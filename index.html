<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baustellenbericht v3.3 Ultra-Mega-DB - Fliesen Unger S√ºd</title>
    
    <!-- PWA Meta-Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Baustellenbericht">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- jsPDF f√ºr PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        window.jsPDF = window.jspdf.jsPDF;
    </script>

    <!-- Firebase f√ºr Cloud-Sync (geteiltes Lernen) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- Tesseract.js f√ºr kostenlose OCR (Texterkennung aus Fotos) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Leaflet f√ºr interaktive Karte (kostenlos, ohne API-Key!) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Eruda Console f√ºr On-Device Debugging (v1.14 Feature) -->
    <script>
        // Eruda wird nur geladen wenn:
        // 1. Nicht sicherer Kontext ODER
        // 2. URL-Parameter ?debug=1
        const shouldLoadEruda = !window.isSecureContext || window.location.search.includes('debug=1');
        if (shouldLoadEruda) {
            const eruScript = document.createElement('script');
            eruScript.src = 'https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js';
            eruScript.onload = () => {
                if (typeof eruda !== 'undefined') {
                    eruda.init();
                    console.log('üõ†Ô∏è Eruda Debug Console aktiviert (v1.14)!');
                }
            };
            document.head.appendChild(eruScript);
        }
    </script>
    
    <!-- jsQR Library f√ºr QR-Code Fallback (v1.15 Feature) -->
    
    
    <!-- v2.0: Capacitor f√ºr Native-App Funktionalit√§t -->
    <script>
        // Capacitor wird nur geladen wenn als Native-App installiert
        // Im Browser wird es ignoriert
        window.isCapacitorApp = typeof window.Capacitor !== 'undefined' && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();
        
        // Log f√ºr Debugging
        console.log('üöÄ Baustellenbericht v3.3 Ultra-Mega-DB');
        console.log('üì± Capacitor verf√ºgbar:', window.isCapacitorApp ? 'JA (Native App)' : 'NEIN (Browser)');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #667eea;
            padding: 20px 10px;
        }
        
        /* TABS */
        .tabs {
            display: flex;
            max-width: 900px;
            margin: 0 auto 0 auto;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 16px;
            border: none;
            background: #f1f5f9;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background: white;
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* RAPPORT FORM - EXAKTES ORIGINAL LAYOUT */
        .rapport-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff8dc; /* Gelb wie Original */
            padding: 30px;
            border: 4px solid #000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        /* HEADER */
        .rapport-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #000;
        }
        
        .rapport-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-box {
            width: 60px;
            height: 60px;
            background: #dc2626;
            border: 3px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
        }
        
        .company-text {
            line-height: 1.1;
        }
        
        .company-name {
            font-size: 20px;
            font-weight: bold;
        }
        
        .company-name span {
            color: #dc2626;
        }
        
        .rapport-contact {
            text-align: right;
            font-size: 10px;
            line-height: 1.4;
        }
        
        /* RAPPORT NR SECTION */
        .rapport-nr-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #000;
            background: #f5f5dc;
            margin-bottom: 15px;
        }
        
        .rapport-nr-box {
            padding: 12px 25px;
            border: 3px solid #000;
            background: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .rapport-worker-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 10px;
        }
        
        .worker-checkbox {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .worker-checkbox div {
            width: 40px;
            height: 25px;
            border: 2px solid #000;
            background: white;
        }
        
        /* HAUPTTABELLE */
        .rapport-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .rapport-table th,
        .rapport-table td {
            border: 2px solid #000;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .rapport-table th {
            background: #f0f0f0;
            font-weight: bold;
            font-size: 12px;
        }
        
        .rapport-table td {
            font-size: 11px;
            min-height: 30px;
        }
        
        .pos-col { width: 50px; }
        .datum-col { width: 100px; }
        .taetig-col { min-height: 40px; }
        
        /* Zeilen f√ºr manuelle Eingabe */
        .editable-row td {
            background: white;
        }
        
        .editable-row input,
        .editable-row textarea {
            width: 100%;
            border: none;
            background: transparent;
            font-family: Arial;
            font-size: 11px;
            padding: 4px;
        }
        
        .editable-row textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* MATERIAL/MASCHINEN SECTIONS */
        .rapport-section {
            border: 2px solid #000;
            padding: 12px;
            margin-bottom: 15px;
            background: #f5f5dc;
        }
        
        .rapport-section-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .rapport-section textarea {
            width: 100%;
            min-height: 80px;
            border: none;
            background: white;
            padding: 8px;
            font-family: Arial;
            font-size: 11px;
            resize: vertical;
        }
        
        /* UNTERSCHRIFTEN */
        .rapport-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .signature-box {
            text-align: center;
        }
        
        .signature-pad {
            width: 100%;
            height: 120px;
            border: 2px solid #000;
            background: white;
            cursor: crosshair;
            touch-action: none;
            margin-bottom: 10px;
        }
        
        .signature-label {
            border-top: 2px solid #000;
            padding-top: 10px;
            font-size: 11px;
        }
        
        .signature-label strong {
            display: block;
            margin-top: 5px;
        }
        
        /* BUTTONS */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #dc2626;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b91c1c;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        /* HELPER SECTIONS */
        .helper-section {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .helper-section h4 {
            color: #dc2626;
            margin-bottom: 12px;
            font-size: 15px;
        }
        
        .helper-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .helper-section select,
        .helper-section input,
        .helper-section textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .helper-section textarea {
            min-height: 80px;
            resize: vertical;
            font-family: Arial;
        }
        
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .chip {
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .chip:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }
        
        .chip.selected {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        
        .chip.selected::after {
            content: ' ‚úÖ';
        }
        
        /* LISTE */
        .berichte-liste {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
        }
        
        .bericht-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .bericht-card h3 {
            color: #dc2626;
            margin-bottom: 8px;
        }
        
        .bericht-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .bericht-actions .btn {
            padding: 8px 14px;
            font-size: 13px;
        }
        
        /* PHOTO GRID */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .photo-item {
            position: relative;
            border: 2px solid #000;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        
        .photo-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* TOAST */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1e293b;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success {
            background: #10b981;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ACTIONS BAR */
        .actions-bar {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            border-top: 3px solid #000;
            flex-wrap: wrap;
        }
        
        /* GPS STATUS */
        .gps-status {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin: 10px 0;
        }
        
        .gps-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .gps-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .gps-loading {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        @media (max-width: 768px) {
            .rapport-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .rapport-contact {
                text-align: left;
            }
            
            .rapport-signatures {
                grid-template-columns: 1fr;
            }
        }
        
        /* MIKROFON PERMISSION MODAL */
        .mic-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        .mic-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border: 3px solid #dc2626;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .mic-modal h3 {
            color: #dc2626;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .mic-modal p {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .mic-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .mic-modal-buttons button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mic-modal-allow {
            background: #dc2626;
            color: white;
        }
        
        .mic-modal-allow:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }
        
        .mic-modal-later {
            background: #e5e7eb;
            color: #4b5563;
        }
        
        .mic-modal-later:hover {
            background: #d1d5db;
        }
        
        /* ===== SETUP ASSISTANT MODAL ===== */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .setup-modal.hidden {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .setup-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .setup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }
        
        .setup-header h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .setup-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .setup-body {
            padding: 30px;
        }
        
        .setup-warning {
            background: #fee;
            border-left: 4px solid #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .setup-warning strong {
            display: block;
            color: #dc2626;
            margin-bottom: 5px;
        }
        
        .setup-step {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }
        
        .setup-step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .setup-step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .setup-step-title {
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
        }
        
        .setup-step-content {
            margin-left: 44px;
        }
        
        .setup-command {
            background: #1f2937;
            color: #10b981;
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            position: relative;
            overflow-x: auto;
            white-space: pre;
        }
        
        .setup-copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #374151;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .setup-copy-btn:hover {
            background: #4b5563;
        }
        
        .setup-copy-btn:active {
            transform: scale(0.95);
        }
        
        .setup-copy-btn.copied {
            background: #10b981;
        }
        
        .setup-info {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .setup-success {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .setup-ip-box {
            background: #fff;
            border: 2px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }
        
        .setup-ip-box strong {
            display: block;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .setup-ip-box .ip-address {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            font-family: 'Courier New', monospace;
        }
        
        .setup-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .setup-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .setup-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .setup-tab-content {
            display: none;
        }
        
        .setup-tab-content.active {
            display: block;
        }
        
        .setup-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }
        
        .setup-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .setup-btn-primary {
            background: #667eea;
            color: white;
        }
        
        .setup-btn-primary:hover {
            background: #5568d3;
        }
        
        .setup-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .setup-btn-secondary:hover {
            background: #d1d5db;
        }
        
        .setup-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .setup-checkbox:hover {
            background: #f3f4f6;
        }
        
        .setup-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .setup-file-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            margin: 15px 0;
        }
        
        .setup-minimize-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .setup-minimize-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .setup-reopen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
            z-index: 99999;
            animation: pulse 2s infinite;
        }
        
        .setup-reopen-btn.hidden {
            display: none;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .setup-qr {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .setup-qr img {
            max-width: 200px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        /* ===== v1.14 FEATURES: HTTPS WARNING BANNER ===== */
        .https-warning-banner {
            max-width: 900px;
            margin: 0 auto 10px;
            background: #fef3c7;
            border: 3px solid #f59e0b;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .https-warning-banner .warning-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .https-warning-banner .warning-content {
            flex: 1;
        }
        
        .https-warning-banner .warning-title {
            font-weight: bold;
            font-size: 16px;
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .https-warning-banner .warning-text {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 8px;
        }
        
        .https-warning-banner .protocol-info {
            font-family: monospace;
            background: #fde68a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }
        
        .https-warning-banner .btn-help {
            padding: 8px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .https-warning-banner .btn-help:hover {
            background: #d97706;
        }
        
        /* ===== v1.14 FEATURES: DEBUG INFO BOX ===== */
        .debug-info-box {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1e293b;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 280px;
        }
        
        .debug-info-box .debug-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .debug-info-box .debug-line {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .debug-info-box .debug-label {
            opacity: 0.7;
        }
        
        .debug-info-box .debug-value {
            font-weight: bold;
        }
        
        .debug-info-box .btn-close-debug {
            margin-top: 10px;
            padding: 6px 12px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            width: 100%;
        }
        
        /* ===== v1.15 FEATURES: GPS SOURCE BADGE ===== */
        .gps-source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .gps-source-badge.source-gps {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .gps-source-badge.source-ip {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }
        
        .gps-source-badge .badge-icon {
            font-size: 13px;
        }
        
        /* ===== v1.15 FEATURES: QR SCANNER OVERLAY ===== */
        .qr-scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .qr-scanner-overlay .scanner-header {
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .qr-scanner-overlay .scanner-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .qr-scanner-overlay .scanner-instructions {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .qr-scanner-overlay .scanner-video-container {
            position: relative;
            max-width: 500px;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .qr-scanner-overlay video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .qr-scanner-overlay canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .qr-scanner-overlay .scanner-target-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0.5);
        }
        
        .qr-scanner-overlay .scanner-corners {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .qr-scanner-overlay .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 4px solid #10b981;
        }
        
        .qr-scanner-overlay .corner.top-left {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
        }
        
        .qr-scanner-overlay .corner.top-right {
            top: -2px;
            right: -2px;
            border-left: none;
            border-bottom: none;
        }
        
        .qr-scanner-overlay .corner.bottom-left {
            bottom: -2px;
            left: -2px;
            border-right: none;
            border-top: none;
        }
        
        .qr-scanner-overlay .corner.bottom-right {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
        }
        
        .qr-scanner-overlay .scanner-status {
            margin-top: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .qr-scanner-overlay .scanner-buttons {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }
        
        .qr-scanner-overlay .btn-scanner {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .qr-scanner-overlay .btn-scanner-close {
            background: #ef4444;
            color: white;
        }
        
        .qr-scanner-overlay .btn-scanner-close:hover {
            background: #dc2626;
        }
        
        /* ===== v1.15 FEATURES: AUDIO RECORDING INDICATOR ===== */
        .audio-recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            color: #991b1b;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
            animation: pulse-recording 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .audio-recording-indicator .recording-dot {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink-dot 1s ease-in-out infinite;
        }
        
        @keyframes blink-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .audio-recording-indicator .recording-time {
            font-family: monospace;
            font-size: 14px;
        }
        
        /* ===== v1.14/v1.15: HTTPS SETUP MODAL ===== */
        .https-setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .https-setup-modal .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .https-setup-modal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px 12px 0 0;
        }
        
        .https-setup-modal .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .https-setup-modal .modal-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .https-setup-modal .modal-body {
            padding: 24px;
        }
        
        .https-setup-modal .setup-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .https-setup-modal .setup-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .https-setup-modal .setup-section-time {
            display: inline-block;
            padding: 4px 10px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .https-setup-modal .setup-steps {
            margin-top: 12px;
        }
        
        .https-setup-modal .setup-step {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .https-setup-modal .setup-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .https-setup-modal .setup-code {
            background: #1e293b;
            color: #10b981;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre;
        }
        
        .https-setup-modal .setup-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #78350f;
            margin: 10px 0;
        }
        
        .https-setup-modal .setup-note strong {
            color: #92400e;
        }
        
        .https-setup-modal .modal-footer {
            padding: 20px 24px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .https-setup-modal .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .https-setup-modal .btn-modal-close {
            background: #64748b;
            color: white;
        }
        
        .https-setup-modal .btn-modal-close:hover {
            background: #475569;
        }
        
        /* ===== V3.0 NEUE FEATURES ===== */
        
        /* Statistik-Karten */
        .stat-card {
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Stats Buttons */
        .stats-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .stats-btn.active, .stats-btn:hover {
            background: #667eea;
            color: white;
        }
        
        /* Kalender */
        .kalender-tag {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .kalender-tag:hover {
            background: #e2e8f0;
        }
        
        .kalender-tag.heute {
            background: #667eea;
            color: white;
        }
        
        .kalender-tag.hat-bericht::after {
            content: 'üìã';
            position: absolute;
            bottom: 2px;
            font-size: 10px;
        }
        
        .kalender-tag.leer {
            background: transparent;
            cursor: default;
        }
        
        .kalender-header {
            font-weight: bold;
            color: #64748b;
            text-align: center;
            padding: 10px 0;
        }
        
        /* Stoppuhr */
        .stoppuhr-container {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }
        
        .stoppuhr-display {
            font-size: 48px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .stoppuhr-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .stoppuhr-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stoppuhr-btn.start {
            background: #22c55e;
            color: white;
        }
        
        .stoppuhr-btn.stop {
            background: #ef4444;
            color: white;
        }
        
        .stoppuhr-btn.uebernehmen {
            background: #667eea;
            color: white;
        }
        
        .stoppuhr-btn.reset {
            background: #64748b;
            color: white;
        }
        
        /* Wetter Widget */
        .wetter-widget {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .wetter-icon {
            font-size: 40px;
        }
        
        .wetter-info {
            flex: 1;
        }
        
        .wetter-temp {
            font-size: 28px;
            font-weight: bold;
        }
        
        .wetter-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .wetter-warning {
            background: linear-gradient(135deg, #f97316, #ef4444);
        }
        
        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #f1f5f9;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        
        .quick-action-btn .icon {
            font-size: 24px;
        }
        
        /* Projekt-Karte */
        .projekt-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .projekt-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .projekt-card.aktiv {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        
        .projekt-info h4 {
            margin: 0 0 5px 0;
            color: #1e293b;
        }
        
        .projekt-info span {
            color: #64748b;
            font-size: 14px;
        }
        
        .projekt-actions {
            display: flex;
            gap: 8px;
        }
        
        .projekt-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Dark Mode */
        body.dark-mode {
            background: #1e293b;
        }
        
        body.dark-mode .rapport-container {
            background: #334155;
            border-color: #475569;
        }
        
        body.dark-mode .tabs {
            background: #1e293b;
        }
        
        body.dark-mode .tab {
            background: #334155;
            color: #94a3b8;
        }
        
        body.dark-mode .tab.active {
            background: #475569;
            color: #f1f5f9;
        }
        
        body.dark-mode .helper-section {
            background: #475569;
        }
        
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }
        
        body.dark-mode h4 {
            color: #f1f5f9;
        }
        
        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1e293b;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
        }
        
        body.dark-mode .dark-mode-toggle {
            background: #fbbf24;
            color: #1e293b;
        }
        
        /* Vorlagen Dropdown */
        .vorlagen-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .vorlagen-section select {
            width: 100%;
            padding: 12px;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        /* Top Baustelle Bar */
        .top-baustelle-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .top-baustelle-bar .rank {
            width: 30px;
            font-weight: bold;
            color: #667eea;
        }
        
        .top-baustelle-bar .name {
            flex: 1;
        }
        
        .top-baustelle-bar .hours {
            font-weight: bold;
            color: #22c55e;
        }
        
        .top-baustelle-bar .bar {
            height: 8px;
            background: #22c55e;
            border-radius: 4px;
            margin-left: 10px;
        }

        /* ===== PUSH-TO-TALK BUTTON STYLES ===== */
        .btn-push-to-talk {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .btn-push-to-talk:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-push-to-talk:active,
        .btn-push-to-talk.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transform: scale(0.98);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            animation: pulse-record 1s ease-in-out infinite;
        }

        @keyframes pulse-record {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
        }

        .btn-push-to-talk .ptt-icon {
            margin-right: 8px;
        }

        .btn-push-to-talk .ptt-text-idle {
            display: inline;
        }

        .btn-push-to-talk .ptt-text-recording {
            display: none;
        }

        .btn-push-to-talk.recording .ptt-text-idle {
            display: none;
        }

        .btn-push-to-talk.recording .ptt-text-recording {
            display: inline;
        }
    </style>
    <!-- Puter.js entfernt - √∂ffnete externe Login-Seite -->
</head>
<body>
    <!-- MIKROFON PERMISSION PRIMING MODAL -->
    <div id="micPermissionModal" class="mic-modal">
        <div class="mic-modal-content">
            <h3>üé§ Spracherfassung aktivieren</h3>
            <p><strong>Diktieren Sie Ihre Berichte hands-free!</strong></p>
            <p style="color: #64748b; margin: 15px 0;">
                Wir ben√∂tigen Mikrofonzugriff, damit Sie Baustellennotizen sprechen k√∂nnen statt zu tippen - 
                ideal bei Handschuhen oder schmutzigen H√§nden auf der Baustelle.
            </p>
            <p id="httpsWarning" style="display: none; background: #fef3c7; padding: 10px; border-radius: 6px; color: #92400e; margin: 10px 0;">
                <strong>‚ö†Ô∏è HTTPS erforderlich!</strong><br>
                Mikrofon funktioniert nur √ºber sichere Verbindung (HTTPS) oder localhost.
            </p>
            <p style="font-size: 13px; color: #94a3b8; margin-top: 15px;">
                ‚ÑπÔ∏è Ihre Privatsph√§re: Wir speichern keine Aufnahmen. Die Spracheingabe wird nur zur sofortigen Texterkennung verwendet.
            </p>
            <div class="mic-modal-buttons">
                <button class="mic-modal-allow" onclick="allowMicrophone()">üé§ Mikrofon aktivieren</button>
                <button class="mic-modal-later" onclick="closeMicModal()">‚úÖ¬èÔ∏è Lieber tippen</button>
            </div>
        </div>
    </div>

    <!-- v1.14/v1.15: HTTPS WARNING BANNER (wird nur bei http:// gezeigt) -->
    <div id="httpsWarningBanner" class="https-warning-banner" style="display: none;">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-content">
            <div class="warning-title">GPS & SPRACHEINGABE BEN√ñTIGEN HTTPS!</div>
            <div class="warning-text">
                Aktuelle Verbindung: <span class="protocol-info" id="currentProtocol"></span>
            </div>
        </div>
        <button class="btn-help" onclick="showHTTPSSetupModal()">üí° Anleitung anzeigen</button>
    </div>
    
    <!-- v1.14: DEBUG INFO BOX (wird nur bei !isSecureContext gezeigt) -->
    <div id="debugInfoBox" class="debug-info-box" style="display: none;">
        <div class="debug-title">üõ†Ô∏è Debug Info</div>
        <div class="debug-line">
            <span class="debug-label">Protocol:</span>
            <span class="debug-value" id="debugProtocol"></span>
        </div>
        <div class="debug-line">
            <span class="debug-label">Secure Context:</span>
            <span class="debug-value" id="debugSecure"></span>
        </div>
        <div class="debug-line">
            <span class="debug-label">GPS API:</span>
            <span class="debug-value" id="debugGPS"></span>
        </div>
        <div class="debug-line">
            <span class="debug-label">Speech API:</span>
            <span class="debug-value" id="debugSpeech"></span>
        </div>
        <div class="debug-line">
            <span class="debug-label">Barcode API:</span>
            <span class="debug-value" id="debugBarcode"></span>
        </div>
        <button class="btn-close-debug" onclick="closeDebugBox()">Schlie√üen</button>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" onclick="switchToTab('neu')">üìù Neu</button>
        <button class="tab" onclick="switchToTab('liste')">üìã Berichte</button>
        <button class="tab" onclick="switchToTab('projekte')">üìÅ Projekte</button>
        <button class="tab" onclick="switchToTab('statistiken')">üìä Stats</button>
        <button class="tab" onclick="switchToTab('kalender')">üìÖ Kalender</button>
        <button class="tab" onclick="openKISettings()" style="margin-left: auto; background: linear-gradient(135deg, #667eea, #764ba2);">‚öôÔ∏è KI</button>
    </div>

    <!-- KI EINSTELLUNGEN MODAL -->
    <div id="kiSettingsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:10003; align-items:center; justify-content:center; padding:15px;">
        <div style="background:white; border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
            <div style="padding:16px 20px; background:linear-gradient(135deg, #667eea, #764ba2); border-radius:16px 16px 0 0;">
                <h3 style="margin:0; color:white; font-size:18px;">ü§ñ KI-Einstellungen</h3>
                <p style="margin:5px 0 0; color:rgba(255,255,255,0.8); font-size:12px;">Kostenlose API-Keys f√ºr intelligente Textverbesserung</p>
            </div>
            <div style="padding:20px;">
                <!-- Groq -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:bold; margin-bottom:8px; color:#1e40af;">
                        üöÄ Groq API Key <span style="font-weight:normal; color:#64748b;">(schnell)</span>
                    </label>
                    <input type="password" id="groqApiKey" placeholder="gsk_..."
                           style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-family:monospace;"
                           onchange="saveKISettings()">
                    <a href="https://console.groq.com/keys" target="_blank"
                       style="font-size:12px; color:#667eea; text-decoration:none;">
                       ‚Üí Kostenlosen Key holen
                    </a>
                </div>

                <!-- Gemini -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:bold; margin-bottom:8px; color:#059669;">
                        ‚ú® Google Gemini API Key <span style="font-weight:normal; color:#64748b;">(Backup)</span>
                    </label>
                    <input type="password" id="geminiApiKey" placeholder="AIza..."
                           style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px; font-family:monospace;"
                           onchange="saveKISettings()">
                    <a href="https://aistudio.google.com/apikey" target="_blank"
                       style="font-size:12px; color:#667eea; text-decoration:none;">
                       ‚Üí Kostenlosen Key holen
                    </a>
                </div>

                <!-- Status -->
                <div id="kiStatus" style="padding:12px; background:#f1f5f9; border-radius:8px; margin-bottom:15px;">
                    <div style="font-size:13px; color:#64748b;">Status wird geladen...</div>
                </div>

                <!-- Info -->
                <div style="background:#fef3c7; padding:12px; border-radius:8px; border-left:4px solid #f59e0b;">
                    <div style="font-size:12px; color:#92400e;">
                        <strong>üí° So funktioniert's:</strong><br>
                        1. Hole dir kostenlose API-Keys (Links oben)<br>
                        2. F√ºge sie hier ein<br>
                        3. Bei Spracheingabe erstellt KI professionelle Zusammenfassungen
                    </div>
                </div>
            </div>
            <div style="padding:12px 20px 20px; display:flex; gap:10px;">
                <button onclick="closeKISettings()"
                        style="flex:1; padding:12px; background:#e5e7eb; color:#475569; border:none; border-radius:8px; cursor:pointer;">
                    Schlie√üen
                </button>
                <button onclick="testKIConnection()"
                        style="flex:1; padding:12px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                    üîå Verbindung testen
                </button>
            </div>
        </div>
    </div>

    <!-- ANALYTICS DASHBOARD MODAL -->
    <div id="analyticsDashboardModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:10004; overflow-y:auto; padding:15px;">
        <div style="max-width:600px; margin:20px auto; background:white; border-radius:16px; overflow:hidden;">
            <!-- Header -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0; font-size:20px;">üìä Analytics Dashboard</h2>
                    <p style="margin:5px 0 0; opacity:0.9; font-size:12px;">KI-Lernfortschritt & Team-Statistiken</p>
                </div>
                <button onclick="closeAnalyticsDashboard()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer;">√ó</button>
            </div>

            <!-- KI-Genauigkeit -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">üéØ KI-Genauigkeit</h3>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div id="dashAccuracyCircle" style="width:80px; height:80px; border-radius:50%; background:conic-gradient(#10b981 0%, #e2e8f0 0%); display:flex; align-items:center; justify-content:center;">
                        <div style="width:60px; height:60px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold;" id="dashAccuracyPercent">--%</div>
                    </div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="color:#10b981; font-size:14px;">‚úÖ Korrekt</span>
                            <span style="font-weight:bold;" id="dashCorrectCount">0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:#f59e0b; font-size:14px;">‚úèÔ∏è Korrigiert</span>
                            <span style="font-weight:bold;" id="dashCorrectedCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fehlertypen -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">‚ö†Ô∏è H√§ufigste Fehler</h3>
                <div id="dashErrorTypes" style="display:flex; flex-direction:column; gap:8px;">
                    <!-- Dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Wissensbasis -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">üìö Wissensbasis</h3>
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;">
                    <div style="background:#f0fdf4; padding:15px; border-radius:10px; text-align:center;">
                        <div style="font-size:24px; font-weight:bold; color:#10b981;" id="dashMitarbeiter">0</div>
                        <div style="font-size:11px; color:#64748b;">Mitarbeiter</div>
                    </div>
                    <div style="background:#eff6ff; padding:15px; border-radius:10px; text-align:center;">
                        <div style="font-size:24px; font-weight:bold; color:#3b82f6;" id="dashKunden">0</div>
                        <div style="font-size:11px; color:#64748b;">Kunden</div>
                    </div>
                    <div style="background:#fef3c7; padding:15px; border-radius:10px; text-align:center;">
                        <div style="font-size:24px; font-weight:bold; color:#f59e0b;" id="dashBeispiele">0</div>
                        <div style="font-size:11px; color:#64748b;">Beispiele</div>
                    </div>
                </div>
            </div>

            <!-- Aktivit√§ts-Timeline -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">üìÖ Letzte Aktivit√§ten</h3>
                <div id="dashTimeline" style="max-height:200px; overflow-y:auto;">
                    <!-- Dynamisch gef√ºllt -->
                </div>
            </div>

            <!-- Lern-Trend -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">üìà Lern-Trend (letzte 7 Tage)</h3>
                <div id="dashTrendChart" style="display:flex; align-items:flex-end; gap:4px; height:80px;">
                    <!-- Dynamisch gef√ºllt -->
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:10px; color:#94a3b8;">
                    <span>vor 7 Tagen</span>
                    <span>heute</span>
                </div>
            </div>

            <!-- Cloud-Status -->
            <div style="padding:20px; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 15px; font-size:16px; color:#475569;">‚òÅÔ∏è Team-Sync Status</h3>
                <div id="dashCloudStatus" style="display:flex; align-items:center; gap:10px; padding:12px; background:#f8fafc; border-radius:8px;">
                    <span id="dashCloudIcon" style="font-size:24px;">‚ö™</span>
                    <div>
                        <div style="font-weight:600;" id="dashCloudText">Nicht verbunden</div>
                        <div style="font-size:11px; color:#64748b;" id="dashCloudDetails">Team-Code eingeben um zu verbinden</div>
                    </div>
                </div>
            </div>

            <!-- Aktionen -->
            <div style="padding:20px; display:flex; gap:10px;">
                <button onclick="exportAnalytics()" style="flex:1; padding:12px; background:#f1f5f9; color:#475569; border:none; border-radius:8px; cursor:pointer; font-size:13px;">
                    üì• Export CSV
                </button>
                <button onclick="resetAnalytics()" style="flex:1; padding:12px; background:#fef2f2; color:#ef4444; border:none; border-radius:8px; cursor:pointer; font-size:13px;">
                    üóëÔ∏è Daten l√∂schen
                </button>
                <button onclick="closeAnalyticsDashboard()" style="flex:1; padding:12px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; font-weight:bold;">
                    ‚úì Schlie√üen
                </button>
            </div>
        </div>
    </div>

    <!-- TAB: NEUER BERICHT -->
    <div class="tab-content active" id="tab-neu">
        <!-- HELPER SECTIONS (VOR DEM FORMULAR) -->
        <div style="max-width: 900px; margin: 0 auto; background: white; padding: 20px;">
            <!-- PROJEKTNUMMER & BAUSTELLE -->
            
            <!-- V3.0: WETTER WIDGET -->
            <div class="wetter-widget" id="wetterWidget">
                <div class="wetter-icon" id="wetterIcon">üå§Ô∏è</div>
                <div class="wetter-info">
                    <div class="wetter-temp" id="wetterTemp">--¬∞C</div>
                    <div class="wetter-desc" id="wetterDesc">Wetter wird geladen...</div>
                </div>
                <div id="wetterOrt" style="font-size: 12px;">üìç --</div>
            </div>
            
            <!-- V3.0: STOPPUHR -->
            <div class="stoppuhr-container">
                <div style="font-size: 14px; margin-bottom: 5px;">‚è±Ô∏è Arbeitszeit-Stoppuhr</div>
                <div class="stoppuhr-display" id="stoppuhrDisplay">00:00:00</div>
                <div class="stoppuhr-buttons">
                    <button class="stoppuhr-btn start" id="stoppuhrStart" onclick="toggleStoppuhr()">‚ñ∂Ô∏è Start</button>
                    <button class="stoppuhr-btn reset" onclick="resetStoppuhr()">üîÑ Reset</button>
                    <button class="stoppuhr-btn uebernehmen" onclick="stoppuhrUebernehmen()">‚úÖ √úbernehmen</button>
                </div>
            </div>
            
            <!-- V3.0: QUICK ACTIONS -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="navigateToBaustelle()">
                    <span class="icon">üß≠</span>
                    <span>Navigation</span>
                </button>
                <button class="quick-action-btn" onclick="schnellFoto()">
                    <span class="icon">üì∑</span>
                    <span>Foto</span>
                </button>
                <button class="quick-action-btn" onclick="callBuero()">
                    <span class="icon">üìû</span>
                    <span>B√ºro anrufen</span>
                </button>
                <button class="quick-action-btn" onclick="showAbwesenheit()">
                    <span class="icon">üìù</span>
                    <span>Abwesenheit</span>
                </button>
            </div>

            <!-- V3.4: KI-AGENT - Sprich einmal, f√ºlle alles aus -->
            <div class="agent-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; margin: 15px 0; color: white;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 40px;">ü§ñ</div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px;">KI-Agent: Sprich einmal, f√ºlle alles aus</h3>
                        <p style="margin: 5px 0 0; opacity: 0.9; font-size: 13px;">Beschreibe deinen Tag - der Agent f√ºllt alle Felder automatisch</p>
                    </div>
                </div>

                <button id="agentButton"
                        onmousedown="startAgentRecording()"
                        onmouseup="stopAgentRecording()"
                        onmouseleave="stopAgentRecording()"
                        ontouchstart="startAgentRecording()"
                        ontouchend="stopAgentRecording()"
                        style="width: 100%; padding: 20px; background: rgba(255,255,255,0.2); border: 2px dashed rgba(255,255,255,0.5); border-radius: 12px; color: white; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                    <div style="font-size: 30px; margin-bottom: 8px;">üé§</div>
                    <div style="font-weight: bold;">Gedr√ºckt halten & Bericht einsprechen</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">z.B. "Heute bei M√ºller, 25qm Fliesen verlegt, 3 Mann, 8 Stunden..."</div>
                </button>

                <div id="agentStatus" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 8px;">
                    <div id="agentStatusText" style="font-size: 14px;">üé§ Aufnahme l√§uft...</div>
                    <div id="agentPreview" style="font-size: 13px; opacity: 0.8; margin-top: 8px; font-style: italic;"></div>
                </div>

                <!-- FEEDBACK-SYSTEM F√úR KI-LERNEN -->
                <div id="feedbackSection" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 12px; color: #333;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #475569;">
                        üéØ War die KI-Erkennung korrekt?
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="submitFeedback('correct')"
                                style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 20px;">üëç</span>
                            <span>Ja, perfekt!</span>
                        </button>
                        <button onclick="submitFeedback('corrected')"
                                style="flex: 1; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 20px;">‚úèÔ∏è</span>
                            <span>Musste korrigieren</span>
                        </button>
                    </div>
                    <div id="feedbackDetails" style="display: none;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Was war falsch? (optional)</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="fbName" style="margin: 0;"> Namen
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="fbMenge" style="margin: 0;"> Mengen
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="fbBaustelle" style="margin: 0;"> Baustelle
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="fbStunden" style="margin: 0;"> Stunden
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="fbSonstig" style="margin: 0;"> Sonstiges
                            </label>
                        </div>
                        <textarea id="feedbackNote" placeholder="Optional: Beschreibe den Fehler kurz..."
                                  style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; resize: none; height: 60px;"></textarea>
                        <button onclick="saveFeedbackWithDetails()"
                                style="width: 100%; margin-top: 10px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üíæ Feedback speichern & KI verbessern
                        </button>
                    </div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: center;">
                        Dein Feedback hilft der KI zu lernen! üß†
                    </div>
                </div>

                <!-- FOTO-UPLOAD IM AGENT-BEREICH -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <input type="file" id="agentPhotoInput" accept="image/*" capture="environment" multiple style="display: none;" onchange="handleAgentPhotos(event)">
                    <button onclick="document.getElementById('agentPhotoInput').click()"
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">üì∑</span>
                        <span>Baustellenfotos hinzuf√ºgen</span>
                        <span id="agentPhotoCount" style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                    </button>
                    <div id="agentPhotoPreview" style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <!-- KI-STATUS ANZEIGE -->
            <div id="kiStatusBadge" style="background: #f8fafc; border-radius: 8px; padding: 10px 15px; margin: 10px 0; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px;">
                <span id="kiStatusIcon">ü§ñ</span>
                <span id="kiStatusText" style="font-size: 12px; color: #64748b;">KI wird initialisiert...</span>
            </div>

            <!-- FIRMEN-WISSENSBASIS (f√ºr Agent Stufe 2) -->
            <div id="wissensbasisSection" style="background: #f8fafc; border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #475569;">üìö Firmen-Wissensbasis</h4>
                    <button onclick="toggleWissensbasis()" style="background: none; border: none; cursor: pointer; font-size: 12px; color: #667eea;">‚öôÔ∏è Bearbeiten</button>
                </div>
                <div style="font-size: 12px; color: #64748b;">
                    <span id="wbMitarbeiterCount">0</span> Mitarbeiter ‚Ä¢
                    <span id="wbKundenCount">0</span> Kunden ‚Ä¢
                    <span id="wbBerichteCount">0</span> gelernte Berichte
                </div>

                <!-- KI-LERN-STATISTIK -->
                <div id="kiStatsSection" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #475569; font-weight: 600;">üß† KI-Lernfortschritt</span>
                        <button onclick="showKIStats()" style="background: none; border: none; cursor: pointer; font-size: 11px; color: #667eea;">üìä Details</button>
                    </div>
                    <div style="background: #e2e8f0; border-radius: 6px; height: 8px; overflow: hidden;">
                        <div id="kiAccuracyBar" style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: 0%; transition: width 0.5s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: #64748b;">
                        <span>Genauigkeit: <strong id="kiAccuracyPercent">--%</strong></span>
                        <span><span id="kiFeedbackCount">0</span> Bewertungen</span>
                    </div>
                </div>

                <!-- CLOUD-SYNC F√úR GETEILTES LERNEN -->
                <div id="cloudSyncSection" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #475569; font-weight: 600;">‚òÅÔ∏è Team-Sync</span>
                        <button onclick="toggleCloudSettings()" style="background: none; border: none; cursor: pointer; font-size: 11px; color: #667eea;">‚öôÔ∏è Einrichten</button>
                    </div>
                    <div id="cloudSyncStatus" style="font-size: 11px; color: #64748b;">
                        <span id="cloudStatusIcon">‚ö™</span>
                        <span id="cloudStatusText">Nicht verbunden</span>
                    </div>
                    <div id="cloudSyncButtons" style="display: none; margin-top: 8px; gap: 6px;">
                        <button onclick="syncToCloud()" style="flex: 1; padding: 6px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            ‚¨ÜÔ∏è Hochladen
                        </button>
                        <button onclick="syncFromCloud()" style="flex: 1; padding: 6px; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            ‚¨áÔ∏è Herunterladen
                        </button>
                    </div>
                </div>

                <!-- CLOUD EINSTELLUNGEN MODAL -->
                <div id="cloudSettingsPanel" style="display: none; margin-top: 12px; padding: 12px; background: #f1f5f9; border-radius: 8px;">
                    <div style="font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 10px;">‚òÅÔ∏è Firebase Cloud-Sync einrichten</div>
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 10px;">
                        Teile Wissensbasis & KI-Lerndaten mit dem ganzen Team!
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 11px; color: #475569;">Team-Code (von Admin):</label>
                        <input type="text" id="firebaseTeamCode" placeholder="z.B. fliesen-unger-2024"
                               style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; margin-top: 4px;">
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 11px; color: #475569;">Dein Name (optional):</label>
                        <input type="text" id="cloudUserName" placeholder="z.B. Thomas"
                               style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; margin-top: 4px;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button onclick="connectToCloud()" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            üîó Verbinden
                        </button>
                        <button onclick="disconnectCloud()" style="flex: 1; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            ‚ùå Trennen
                        </button>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #dbeafe; border-radius: 4px; font-size: 10px; color: #1e40af;">
                        üí° <strong>Admin?</strong> Erstelle einen Firebase-Account auf <a href="https://console.firebase.google.com" target="_blank" style="color: #1e40af;">firebase.google.com</a> und teile den Team-Code.
                    </div>
                </div>
            </div>

            <!-- ANALYTICS DASHBOARD BUTTON -->
            <div style="margin: 15px 0;">
                <button onclick="openAnalyticsDashboard()"
                        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 20px;">üìä</span>
                    <span>Analytics Dashboard √∂ffnen</span>
                </button>
            </div>

            <!-- V3.0: VORLAGEN -->
            <div class="vorlagen-section">
                <h4 style="margin: 0 0 10px 0;">üìã Schnellvorlage laden</h4>
                <select id="vorlageSelect" onchange="loadVorlage(this.value)">
                    <option value="">-- Vorlage w√§hlen --</option>
                    <option value="fliesen-standard">üî≤ Standard Fliesenarbeit</option>
                    <option value="fliesen-bad">üöø Badezimmer komplett</option>
                    <option value="fliesen-kueche">üç≥ K√ºche</option>
                    <option value="fliesen-boden">‚¨ú Bodenfliesen</option>
                    <option value="fliesen-wand">üß± Wandfliesen</option>
                    <option value="naturstein">ü™® Naturstein</option>
                    <option value="reparatur">üîß Reparatur/Ausbesserung</option>
                    <option value="aufmass">üìê Nur Aufma√ü</option>
                </select>
            </div>
            
<div class="helper-section">
                <h4>üìã Projekt-Informationen</h4>
                <label>Projektnummer:</label>
                <input type="text" id="projektnummerHelper" placeholder="z.B. P-2024-001">
                <label>Baustelle:</label>
                <input type="text" id="baustelleHelper" placeholder="z.B. Aldi Sindelfingen">
                <button type="button" class="btn btn-success" onclick="copyProjektInfo()">‚úÖ √úbernehmen</button>
            </div>
            
            <!-- GPS -->
            <div class="helper-section">
                <h4>üìç GPS Position</h4>
                <div id="gpsStatus" class="gps-status">üìç Klicke auf "üîÑ GPS neu erfassen" um Standort zu ermitteln</div>
                <button type="button" class="btn btn-secondary" onclick="getGPS()">üîÑ GPS neu erfassen</button>
                <button type="button" class="btn btn-primary" onclick="openMapPicker()" style="margin-left: 10px;">üó∫Ô∏è Karte √∂ffnen</button>

                <!-- Adresse aus GPS (automatisch bef√ºllt) -->
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">Stra√üe:</label>
                        <input type="text" id="strasseHelper" placeholder="wird automatisch bef√ºllt..." readonly style="background: #f5f5f5;">
                    </div>
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #666;">PLZ:</label>
                            <input type="text" id="plzHelper" placeholder="--" readonly style="background: #f5f5f5; width: 70px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Ort:</label>
                            <input type="text" id="ortHelper" placeholder="wird automatisch bef√ºllt..." readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                </div>

                <input type="hidden" id="gpsLat">
                <input type="hidden" id="gpsLon">
            </div>
            
            <!-- T√ÑTIGKEITEN HELPER -->
            <div class="helper-section">
                <h4>üî® T√§tigkeiten hinzuf√ºgen</h4>
                <label>Position:</label>
                <input type="text" id="taetigkeitPosition" placeholder="z.B. 1 oder 1.1" style="width: 100px;">
                <label>Menge:</label>
                <input type="number" id="taetigkeitMenge" placeholder="z.B. 15" min="0" step="0.1" style="width: 100px;">
                <label>Einheit:</label>
                <select id="taetigkeitEinheit" style="width: 120px;">
                    <option value="">--</option>
                    <option value="Kartons">Kartons</option>
                    <option value="Pakete">Pakete</option>
                    <option value="St√ºck">St√ºck</option>
                    <option value="m¬≤">m¬≤</option>
                    <option value="Laufmeter">Laufmeter</option>
                    <option value="kg">kg</option>
                    <option value="Liter">Liter</option>
                    <option value="Sack">Sack</option>
                    <option value="Eimer">Eimer</option>
                    <option value="Stunden">Stunden</option>
                    <option value="Pauschal">Pauschal</option>
                </select>
                <label>Kategorie w√§hlen:</label>
                <select id="taetigkeitHaupt" onchange="showTaetigkeiten()">
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="vorbereitung">üõ†Ô∏è Vorbereitung & Untergrund</option>
                    <option value="verlegung">üî® Fliesenverlegung</option>
                    <option value="verfugung">üß± Verfugung & Abdichtung</option>
                    <option value="sanierung">üîß Sanierung & Reparatur</option>
                    <option value="spezial">‚≠ê¬ê Spezialarbeiten</option>
                    <option value="abschluss">‚úÖ Abschlussarbeiten</option>
                </select>
                <div id="taetigkeitenChips" class="chips-container"></div>
                <button type="button" class="btn btn-success" onclick="addSelectedToForm()">‚ûï Zur Tabelle hinzuf√ºgen</button>
                <button type="button" class="btn-push-to-talk" id="pttTaetigkeit"
                    onmousedown="startPushToTalk('taetigkeit', this)"
                    onmouseup="stopPushToTalk('taetigkeit', this)"
                    onmouseleave="stopPushToTalk('taetigkeit', this)"
                    ontouchstart="startPushToTalk('taetigkeit', this); event.preventDefault();"
                    ontouchend="stopPushToTalk('taetigkeit', this)">
                    <span class="ptt-icon">üé§</span>
                    <span class="ptt-text-idle">Gedr√ºckt halten zum Sprechen</span>
                    <span class="ptt-text-recording">üî¥ Aufnahme l√§uft...</span>
                </button>
                
                
            </div>
            
            <!-- MATERIAL HELPER -->
            <div class="helper-section">
                <h4>üì¶ Material</h4>
                <label>Menge:</label>
                <input type="number" id="materialMenge" min="0" step="1" placeholder="z.B. 5" style="width: 80px;">
                <label>Einheit:</label>
                <select id="materialEinheit" style="width: 120px;">
                    <option value="">--</option>
                    <option value="Kartons">Kartons</option>
                    <option value="Pakete">Pakete</option>
                    <option value="St√ºck">St√ºck</option>
                    <option value="m¬≤">m¬≤</option>
                    <option value="kg">kg</option>
                    <option value="Liter">Liter</option>
                    <option value="Sack">Sack</option>
                </select>
                <label>Laufmeter:</label>
                <input type="number" id="materialLaufmeter" min="0" step="0.1" placeholder="z.B. 15" style="width: 100px;">
                <label>Kategorie w√§hlen:</label>
                <select id="materialHaupt" onchange="showMaterial()">
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="fliesen">üß± Fliesen</option>
                    <option value="kleber">üß± Kleber & M√∂rtel</option>
                    <option value="fugen">‚¨ú Fugenmaterial</option>
                    <option value="abdichtung">üíß Abdichtung</option>
                    <option value="profile">üë§ Profile & Schienen</option>
                    <option value="sonstiges">üì¶ Sonstiges</option>
                </select>
                <div id="materialChips" class="chips-container"></div>
                <label>Zus√§tzliche Eingabe:</label>
                <textarea id="materialHelperText" placeholder="Material hier eingeben..."></textarea>
                <button type="button" class="btn btn-success" onclick="addMaterialToForm()">‚ûï √úbernehmen</button>
                <button type="button" class="btn-push-to-talk" id="pttMaterial"
                    onmousedown="startPushToTalk('materialHelperText', this)"
                    onmouseup="stopPushToTalk('materialHelperText', this)"
                    onmouseleave="stopPushToTalk('materialHelperText', this)"
                    ontouchstart="startPushToTalk('materialHelperText', this); event.preventDefault();"
                    ontouchend="stopPushToTalk('materialHelperText', this)">
                    <span class="ptt-icon">üé§</span>
                    <span class="ptt-text-idle">Gedr√ºckt halten</span>
                    <span class="ptt-text-recording">üî¥ Aufnahme...</span>
                </button>
            </div>
            
            <!-- WERKZEUGE HELPER -->
            <div class="helper-section">
                <h4>üîß Werkzeuge & Maschinen</h4>
                <label>Kategorie w√§hlen:</label>
                <select id="werkzeugeHaupt" onchange="showWerkzeuge()">
                    <option value="">-- Bitte w√§hlen --</option>
                    <option value="schneiden">‚úÇÔ∏è Schneidwerkzeuge</option>
                    <option value="kleber">üî® Klebewerkzeuge</option>
                    <option value="fugen">üßΩ Fugenwerkzeuge</option>
                    <option value="maschinen">‚öôÔ∏è Maschinen</option>
                    <option value="messen">üìê Messger√§te</option>
                    <option value="handwerkzeug">üîß Handwerkzeuge</option>
                </select>
                <div id="werkzeugeChips" class="chips-container"></div>
                <label>Zus√§tzliche Eingabe:</label>
                <textarea id="werkzeugeHelperText" placeholder="Maschinen/Werkzeuge hier eingeben..."></textarea>
                <button type="button" class="btn btn-success" onclick="addWerkzeugeToForm()">‚ûï √úbernehmen</button>
                <button type="button" class="btn-push-to-talk" id="pttWerkzeuge"
                    onmousedown="startPushToTalk('werkzeugeHelperText', this)"
                    onmouseup="stopPushToTalk('werkzeugeHelperText', this)"
                    onmouseleave="stopPushToTalk('werkzeugeHelperText', this)"
                    ontouchstart="startPushToTalk('werkzeugeHelperText', this); event.preventDefault();"
                    ontouchend="stopPushToTalk('werkzeugeHelperText', this)">
                    <span class="ptt-icon">üé§</span>
                    <span class="ptt-text-idle">Gedr√ºckt halten</span>
                    <span class="ptt-text-recording">üî¥ Aufnahme...</span>
                </button>
            </div>
            
            <!-- PERSONAL -->
            <div class="helper-section">
                <h4>üë∑ Personal</h4>
                <label>Anzahl:</label>
                <input type="number" id="personalAnzahl" value="1" min="1" max="99" placeholder="1" style="width: 80px;">
                <label>Mitarbeiter-Typ:</label>
                <select id="personalTyp">
                    <option value="Vorarbeiter">Vorarbeiter</option>
                    <option value="Facharbeiter">Facharbeiter</option>
                    <option value="Fachhelfer">Fachhelfer</option>
                    <option value="Lehrling">Lehrling</option>
                </select>
                <label>Stunden:</label>
                <input type="number" id="personalStunden" step="0.5" min="0" placeholder="8.0">
                <button type="button" class="btn btn-secondary" onclick="addPersonal()">‚ûï Hinzuf√ºgen</button>
                <div id="personalListe" style="margin-top: 10px;"></div>
            </div>
            
            <!-- FAHRZEUGE -->
            <div class="helper-section">
                <h4>üöó Fahrzeuge</h4>
                <label>Anzahl:</label>
                <input type="number" id="fahrzeugAnzahl" value="1" min="1" max="99" placeholder="1" style="width: 80px;">
                <label>Fahrzeugtyp:</label>
                <select id="fahrzeugTyp">
                    <option value="PKW">PKW</option>
                    <option value="Transporter">Transporter</option>
                    <option value="LKW">LKW</option>
                    <option value="Anh√§nger">Anh√§nger</option>
                </select>
                <label>Kennzeichen:</label>
                <input type="text" id="fahrzeugKennzeichen" placeholder="z.B. S-AB 1234">
                <label>Kilometer:</label>
                <input type="number" id="fahrzeugKm" placeholder="z.B. 125">
                <button type="button" class="btn btn-secondary" onclick="addFahrzeug()">‚ûï Hinzuf√ºgen</button>
                <div id="fahrzeugListe" style="margin-top: 10px;"></div>
            </div>
            
            <!-- FOTOS -->
            <div class="helper-section">
                <h4>üì∑ Fotos</h4>
                <input type="file" id="photoInput" accept="image/*" capture="environment" multiple style="display: none;" onchange="handlePhotos(event)">
                <button type="button" class="btn btn-success" onclick="document.getElementById('photoInput').click()">üñº Fotos hinzuf√ºgen</button>
                <div id="photoGrid" class="photo-grid"></div>
            </div>
        </div>
        
        <!-- DAS EIGENTLICHE FORMULAR (EXAKTES ORIGINAL LAYOUT) -->
        <div class="rapport-container">
            <!-- HEADER -->
            <div class="rapport-header">
                <div class="rapport-logo">
                    <div class="logo-box">F</div>
                    <div class="company-text">
                        <div class="company-name">FLIESEN<span>UNGER</span></div>
                        <div class="company-name">S√úD!</div>
                    </div>
                </div>
                <div class="rapport-contact">
                    Tulpenallee 69<br>
                    71069 Sindelfingen<br>
                    Telefon: 07031/9219 9-0<br>
                    Fax: 07031/9219 9-10<br>
                    E-Mail: <a href="/cdn-cgi/l/email-protection#1a73747c755a7c76737f697f74376f747d7f6837696f7f7e347e7f"><span class="__cf_email__" data-cfemail="afc6c1c9c0efc9c3c6cadccac182dac1c8cadd82dcdacacb81cbca">[email&#160;protected]</span></a><br>
                    Website: www.fliesen-unger-sued.de
                </div>
            </div>
            
            <!-- RAPPORT NR -->
            <div class="rapport-nr-section">
                <div>
                    <div style="font-size: 11px; margin-bottom: 5px;">Projektnummer: <input type="text" id="projektnummer" placeholder="P-2024-001" style="border:none; border-bottom: 1px solid #000; background: transparent; width: 130px; font-size: 11px;"></div>
                    <div style="font-size: 11px;">Baustelle: <input type="text" id="baustelle" placeholder="z.B. Aldi Sindelfingen" style="border:none; border-bottom: 1px solid #000; background: transparent; width: 200px; font-size: 11px;"></div>
                    <input type="date" id="datum" style="display: none;">
                </div>
                <div class="rapport-nr-box">
                    RAPPORT Nr. <span id="rapportNummer">00001</span>
                </div>
                <div class="rapport-worker-box" style="display: flex; gap: 8px; align-items: flex-end;">
                    <div style="text-align: center;">
                        <div style="font-size: 9px; line-height: 1.2;">Vor-<br>arbeiter</div>
                        <div style="width: 18px; height: 18px; border: 2px solid #000; background: white; margin: 3px auto 0;"></div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 9px; line-height: 1.2;">Fach-<br>arbeiter</div>
                        <div style="width: 18px; height: 18px; border: 2px solid #000; background: white; margin: 3px auto 0;"></div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 9px; line-height: 1.2;">Lehrling<br>Helfer</div>
                        <div style="width: 18px; height: 18px; border: 2px solid #000; background: white; margin: 3px auto 0;"></div>
                    </div>
                </div>
            </div>
            
            <!-- FOTO-ZU-RAPPORT SECTION (OCR + KI) -->
            <div class="rapport-section" style="background: linear-gradient(135deg, #667eea22, #764ba222); border: 2px dashed #667eea;">
                <div class="rapport-section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <span>üì∏ Notizzettel fotografieren:</span>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <label class="btn btn-primary" style="padding: 8px 15px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            üì∑ Foto aufnehmen
                            <input type="file" accept="image/*" capture="environment" onchange="processNotePhoto(this)" style="display: none;">
                        </label>
                        <label class="btn btn-secondary" style="padding: 8px 15px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                            üñºÔ∏è Bild w√§hlen
                            <input type="file" accept="image/*" onchange="processNotePhoto(this)" style="display: none;">
                        </label>
                    </div>
                </div>
                <div id="ocrProcessingArea" style="display: none; margin-top: 15px;">
                    <!-- Bildvorschau -->
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">üì∑ Originalbild:</div>
                            <img id="ocrPreviewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        </div>
                        <div style="flex: 2; min-width: 250px;">
                            <div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">üìù Erkannter & verbesserter Text:</div>
                            <textarea id="ocrResultText" style="width: 100%; height: 150px; border-radius: 8px; border: 1px solid #ddd; padding: 10px; font-size: 13px;" placeholder="Text wird hier angezeigt..."></textarea>
                        </div>
                    </div>
                    <!-- Status & Fortschritt -->
                    <div id="ocrStatus" style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 8px; font-size: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="ocrStatusIcon">‚è≥</span>
                            <span id="ocrStatusText">Bereit</span>
                        </div>
                        <div id="ocrProgressBar" style="margin-top: 8px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; display: none;">
                            <div id="ocrProgressFill" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <!-- Mitarbeiter-Zuordnung -->
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">üë∑ Mitarbeiter zuordnen (optional):</div>
                        <select id="ocrMitarbeiterSelect" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
                            <option value="">-- Kein Mitarbeiter --</option>
                        </select>
                    </div>
                    <!-- Ziel-Auswahl -->
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">üìã Einf√ºgen in:</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="ocrTarget" value="taetigkeit" checked> üî® T√§tigkeiten
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="ocrTarget" value="material"> üì¶ Material
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="ocrTarget" value="maschinen"> üîß Maschinen
                            </label>
                        </div>
                    </div>
                    <!-- Aktions-Buttons -->
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-success" onclick="insertOcrToRapport()" style="flex: 1; min-width: 150px;">
                            ‚úÖ In Rapport √ºbernehmen
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="reprocessOcrWithAI()" style="flex: 1; min-width: 150px;">
                            ü§ñ Nochmal mit KI verbessern
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelOcrProcess()" style="padding: 10px 15px;">
                            ‚ùå Abbrechen
                        </button>
                    </div>
                </div>
            </div>

            <!-- T√ÑTIGKEITEN SECTION -->
            <div class="rapport-section">
                <div class="rapport-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üî® T√§tigkeiten:</span>
                    <div style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-secondary" onclick="scrollToHelper('taetigkeit')" style="padding: 5px 10px; font-size: 12px;">‚ûï Hinzuf√ºgen</button>
                        <button type="button" class="btn-push-to-talk" id="pttTaetigkeitUnten"
                            onmousedown="startPushToTalk('taetigkeit', this)"
                            onmouseup="stopPushToTalk('taetigkeit', this)"
                            onmouseleave="stopPushToTalk('taetigkeit', this)"
                            ontouchstart="startPushToTalk('taetigkeit', this); event.preventDefault();"
                            ontouchend="stopPushToTalk('taetigkeit', this)"
                            style="padding: 5px 10px; font-size: 12px;">
                            üé§ Spracheingabe
                        </button>
                    </div>
                </div>
            </div>

            <!-- HAUPTTABELLE -->
            <table class="rapport-table">
                <thead>
                    <tr>
                        <th class="pos-col">Pos.</th>
                        <th class="datum-col">Datum</th>
                        <th class="taetig-col">T√§tigkeit</th>
                        <th style="width: 60px;">Menge</th>
                        <th style="width: 80px;">Einheit</th>
                    </tr>
                </thead>
                <tbody id="taetigkeitenTable">
                    <!-- Zeilen werden dynamisch hinzugef√ºgt -->
                </tbody>
            </table>
            
            <!-- MATERIAL SECTION -->
            <div class="rapport-section">
                <div class="rapport-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üì¶ Material:</span>
                    <div style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-secondary" onclick="scrollToHelper('material')" style="padding: 5px 10px; font-size: 12px;">‚ûï Hinzuf√ºgen</button>
                        <button type="button" class="btn-push-to-talk" id="pttMaterialUnten"
                            onmousedown="startPushToTalk('materialText', this)"
                            onmouseup="stopPushToTalk('materialText', this)"
                            onmouseleave="stopPushToTalk('materialText', this)"
                            ontouchstart="startPushToTalk('materialText', this); event.preventDefault();"
                            ontouchend="stopPushToTalk('materialText', this)"
                            style="padding: 5px 10px; font-size: 12px;">
                            üé§ Spracheingabe
                        </button>
                    </div>
                </div>
                <textarea id="materialText" placeholder="Material hier eingeben oder oben ausw√§hlen..."></textarea>
            </div>
            
            <!-- PERSONAL SECTION -->
            <div class="rapport-section">
                <div class="rapport-section-title">üë∑ Personal:</div>
                <div id="personalFormText" style="background: white; padding: 8px; min-height: 60px; font-size: 11px; border: none;"></div>
            </div>
            
            <!-- MASCHINEN SECTION -->
            <div class="rapport-section">
                <div class="rapport-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üîß Maschinen & Werkzeuge:</span>
                    <div style="display: flex; gap: 5px;">
                        <button type="button" class="btn btn-secondary" onclick="scrollToHelper('werkzeuge')" style="padding: 5px 10px; font-size: 12px;">‚ûï Hinzuf√ºgen</button>
                        <button type="button" class="btn-push-to-talk" id="pttMaschinenUnten"
                            onmousedown="startPushToTalk('maschinenText', this)"
                            onmouseup="stopPushToTalk('maschinenText', this)"
                            onmouseleave="stopPushToTalk('maschinenText', this)"
                            ontouchstart="startPushToTalk('maschinenText', this); event.preventDefault();"
                            ontouchend="stopPushToTalk('maschinenText', this)"
                            style="padding: 5px 10px; font-size: 12px;">
                            üé§ Spracheingabe
                        </button>
                    </div>
                </div>
                <textarea id="maschinenText" placeholder="Maschinen hier eingeben oder oben ausw√§hlen..."></textarea>
            </div>
            
            <!-- FOTOS IM FORMULAR -->
            <div id="photoSection" class="rapport-section hidden">
                <div class="rapport-section-title">üì∑ Fotos:</div>
                <div id="formPhotoGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
            </div>
            
            <!-- UNTERSCHRIFTEN -->
            <div class="rapport-signatures">
                <div class="signature-box">
                    <canvas id="signaturePad1" class="signature-pad"></canvas>
                    <button type="button" class="btn btn-secondary" onclick="clearSignature('signaturePad1')" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è L√∂schen</button>
                    <div class="signature-label">
                        <span id="datumDisplay1">_____________</span>
                        <strong>Datum</strong>
                        <strong style="margin-top: 10px;">Fliesen Unger S√ºd GmbH</strong>
                    </div>
                </div>
                
                <div class="signature-box">
                    <canvas id="signaturePad2" class="signature-pad"></canvas>
                    <button type="button" class="btn btn-secondary" onclick="clearSignature('signaturePad2')" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è L√∂schen</button>
                    <div class="signature-label">
                        <span id="datumDisplay2">_____________</span>
                        <strong>Datum</strong>
                        <strong style="margin-top: 10px;">Auftraggeber</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ACTIONS -->
        <div class="actions-bar" style="max-width: 900px; margin: 0 auto;">
            <button type="button" class="btn btn-success" onclick="saveBericht()">üíæ Bericht speichern</button>
            <button type="button" class="btn btn-primary" onclick="downloadBerichtAsJSON()" style="margin-left: 10px;">üì• Als JSON herunterladen</button>
            <div style="margin-top: 10px;">
                <button type="button" class="btn btn-secondary" onclick="downloadAllBerichteAsBackup()">üíæ Alle Berichte sichern</button>
                <label for="importBackup" class="btn btn-secondary" style="margin-left: 10px; cursor: pointer;">üíæ Backup importieren
                    <input type="file" id="importBackup" accept=".json" onchange="importBerichteBackup(event)" style="display: none;">
                </label>
            </div>
            <div id="autoSaveIndicator" style="margin-top: 10px; font-size: 12px; color: #64748b; opacity: 0.5;">
                üíæ Auto-Save aktiv (alle 30 Sek.)
            </div>
            <button type="button" class="btn btn-primary" onclick="generatePDF()">üìÑ Als PDF herunterladen</button>
            <button type="button" class="btn btn-success" onclick="shareViaWhatsApp()" style="background: #25D366;">üì± Via WhatsApp teilen</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Formular zur√ºcksetzen</button>
        </div>
    </div>
    
    <!-- TAB: LISTE -->
    <div class="tab-content" id="tab-liste">
        <div style="max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 0 0 12px 12px;">
            <!-- Suchleiste -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchBerichte" placeholder="üîç Berichte durchsuchen..." 
                    oninput="filterBerichte(this.value)"
                    style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
            </div>
            <div class="berichte-liste" id="berichteListe"></div>
        </div>
    </div>
    
    <!-- TAB: PROJEKTE -->
    <div class="tab-content" id="tab-projekte">
        <div style="max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 0 0 12px 12px;">
            <h2 style="color: #dc2626; margin-bottom: 20px;">üìÅ Meine Projekte/Baustellen</h2>
            
            <!-- Neues Projekt erstellen -->
            <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">‚ûï Neues Projekt anlegen</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="newProjektName" placeholder="Projektname (z.B. Aldi Sindelfingen)" 
                        style="flex: 2; min-width: 200px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <input type="text" id="newProjektNr" placeholder="Projekt-Nr." 
                        style="flex: 1; min-width: 100px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
                    <button onclick="addProjekt()" 
                        style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ‚úÖ Anlegen
                    </button>
                </div>
            </div>
            
            <!-- Projektliste -->
            <div id="projektListe"></div>
        </div>
    </div>
    
    <!-- TAB: STATISTIKEN -->
    <div class="tab-content" id="tab-statistiken">
        <div style="max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 0 0 12px 12px;">
            <h2 style="color: #dc2626; margin-bottom: 20px;">üìä Statistiken & Auswertung</h2>
            
            <!-- Zeitraum-Auswahl -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="loadStats('woche')" class="stats-btn" id="stats-woche">Diese Woche</button>
                <button onclick="loadStats('monat')" class="stats-btn active" id="stats-monat">Dieser Monat</button>
                <button onclick="loadStats('jahr')" class="stats-btn" id="stats-jahr">Dieses Jahr</button>
                <button onclick="loadStats('gesamt')" class="stats-btn" id="stats-gesamt">Gesamt</button>
            </div>
            
            <!-- Statistik-Karten -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="statStunden">0</div>
                    <div class="stat-label">Arbeitsstunden</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-value" id="statBerichte">0</div>
                    <div class="stat-label">Berichte</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <div class="stat-icon">üèóÔ∏è</div>
                    <div class="stat-value" id="statProjekte">0</div>
                    <div class="stat-label">Baustellen</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                    <div class="stat-icon">üöó</div>
                    <div class="stat-value" id="statKm">0</div>
                    <div class="stat-label">Kilometer</div>
                </div>
            </div>
            
            <!-- Top Baustellen -->
            <div style="background: #f8fafc; padding: 15px; border-radius: 10px;">
                <h4 style="margin-bottom: 15px;">üèÜ Top Baustellen (nach Stunden)</h4>
                <div id="topBaustellen"></div>
            </div>
        </div>
    </div>
    
    <!-- TAB: KALENDER -->
    <div class="tab-content" id="tab-kalender">
        <div style="max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 0 0 12px 12px;">
            <h2 style="color: #dc2626; margin-bottom: 20px;">üìÖ Kalender</h2>
            
            <!-- Monat-Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="changeMonth(-1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">‚óÄÔ∏è Zur√ºck</button>
                <h3 id="kalenderMonat" style="color: #334155;"></h3>
                <button onclick="changeMonth(1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Vor ‚ñ∂Ô∏è</button>
            </div>
            
            <!-- Kalender-Grid -->
            <div id="kalenderGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;"></div>
            
            <!-- Legende -->
            <div style="margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px;">
                <span>üìã = Bericht vorhanden</span>
                <span style="color: #22c55e;">‚óè Heute</span>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let selectedTaetigkeiten = [];
        let selectedMaterial = [];
        let selectedWerkzeuge = [];
        let personalListe = [];
        let fahrzeugListe = [];
        let photos = [];
        let taetigkeitenRowCounter = 1;
        
        // ===== BROWSER CAPABILITIES (Feature Detection statt Platform Detection) =====
        // v2.0: Erweitert um Capacitor-Erkennung f√ºr Native-App
        class BrowserCapabilities {
            constructor() {
                // Capacitor-Erkennung (Native App vs. Browser)
                this.isNativeApp = typeof window.Capacitor !== 'undefined' && 
                                   window.Capacitor.isNativePlatform && 
                                   window.Capacitor.isNativePlatform();
                
                // Protokoll-Erkennung
                this.protocol = this.detectProtocol();
                
                this.features = {
                    geolocation: 'geolocation' in navigator,
                    getUserMedia: !!(navigator.mediaDevices?.getUserMedia),
                    speechRecognition: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
                    webShare: 'share' in navigator && 'canShare' in navigator,
                    permissionsAPI: 'permissions' in navigator,
                    isSecureContext: window.isSecureContext,
                    // v2.0: Native App hat immer alle Berechtigungen verf√ºgbar
                    canUseGPS: this.isNativeApp || window.isSecureContext,
                    canUseMicrophone: this.isNativeApp || window.isSecureContext,
                    canUseCamera: this.isNativeApp || window.isSecureContext
                };
                
                // Log f√ºr Debugging (v2.0 - verbesserte Ausgabe)
                console.log('üìä BrowserCapabilities initialisiert:');
                console.log('   ‚Üí Native App:', this.isNativeApp ? 'JA' : 'NEIN');
                console.log('   ‚Üí Protokoll:', this.protocol.type, this.protocol.secure ? '(sicher)' : '(unsicher)');
                console.log('   ‚Üí GPS verf√ºgbar:', this.features.canUseGPS ? '‚úÖ' : '‚ùå');
                console.log('   ‚Üí Mikrofon verf√ºgbar:', this.features.canUseMicrophone ? '‚úÖ' : '‚ùå');
                console.log('   ‚Üí Secure Context:', this.features.isSecureContext ? '‚úÖ' : '‚ùå');
            }
            
            // v2.0: Protokoll-Erkennung mit spezifischen Meldungen
            detectProtocol() {
                const href = window.location.href;
                const protocol = window.location.protocol;
                
                // Native App (Capacitor)
                if (this.isNativeApp) {
                    return {
                        type: 'capacitor',
                        secure: true,
                        name: 'Native App',
                        icon: 'üì±',
                        message: '‚úÖ Native App - Alle Funktionen verf√ºgbar!',
                        solution: null
                    };
                }
                
                // Content:// (Android Datei-Manager)
                if (href.startsWith('content://')) {
                    return {
                        type: 'content',
                        secure: false,
                        name: 'Android Content Provider',
                        icon: 'üì±',
                        message: 'Du √∂ffnest die Datei √ºber den Android Datei-Manager. GPS & Mikrofon sind BLOCKIERT!',
                        solution: '‚Üí L√∂sung: App als APK installieren (siehe CAPACITOR_SETUP.md)'
                    };
                }
                
                // File:// (lokale Datei)
                if (protocol === 'file:') {
                    return {
                        type: 'file',
                        secure: false,
                        name: 'Lokale Datei',
                        icon: 'üìÅ',
                        message: 'Du √∂ffnest die Datei lokal. Auf Android sind GPS & Mikrofon BLOCKIERT!',
                        solution: '‚Üí L√∂sung: App als APK installieren oder √ºber HTTPS √∂ffnen'
                    };
                }
                
                // HTTP (unsicher)
                if (protocol === 'http:') {
                    return {
                        type: 'http',
                        secure: false,
                        name: 'HTTP (unsicher)',
                        icon: '‚ö†Ô∏è',
                        message: 'HTTP ist nicht sicher. GPS & Mikrofon sind BLOCKIERT!',
                        solution: '‚Üí L√∂sung: Nutze HTTPS statt HTTP'
                    };
                }
                
                // HTTPS (sicher)
                if (protocol === 'https:') {
                    return {
                        type: 'https',
                        secure: true,
                        name: 'HTTPS (sicher)',
                        icon: 'üîí',
                        message: '‚úÖ HTTPS - Alle Browser-Funktionen verf√ºgbar!',
                        solution: null
                    };
                }
                
                // Localhost (Entwicklung)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    return {
                        type: 'localhost',
                        secure: true,
                        name: 'Localhost',
                        icon: 'üíª',
                        message: '‚úÖ Localhost - Entwicklungsmodus aktiv',
                        solution: null
                    };
                }
                
                return {
                    type: 'unknown',
                    secure: false,
                    name: 'Unbekannt',
                    icon: '‚ùì',
                    message: 'Unbekanntes Protokoll',
                    solution: '‚Üí Bitte √ºber HTTPS √∂ffnen oder als APK installieren'
                };
            }
            
            async canShareFiles() {
                if (!this.features.webShare) return false;
                try {
                    const testFile = new File(['test'], 'test.pdf', { type: 'application/pdf' });
                    return navigator.canShare({ files: [testFile] });
                } catch {
                    return false;
                }
            }
            
            // v2.0: Status-Zusammenfassung f√ºr UI
            getStatusSummary() {
                if (this.isNativeApp) {
                    return {
                        status: 'optimal',
                        badge: 'üì± Native App',
                        color: '#10b981',
                        gps: '‚úÖ Verf√ºgbar',
                        speech: '‚úÖ Verf√ºgbar',
                        camera: '‚úÖ Verf√ºgbar'
                    };
                }
                
                if (this.protocol.secure) {
                    return {
                        status: 'good',
                        badge: this.protocol.icon + ' ' + this.protocol.name,
                        color: '#10b981',
                        gps: '‚úÖ Verf√ºgbar',
                        speech: '‚úÖ Verf√ºgbar',
                        camera: '‚úÖ Verf√ºgbar'
                    };
                }
                
                return {
                    status: 'limited',
                    badge: this.protocol.icon + ' ' + this.protocol.name,
                    color: '#f59e0b',
                    gps: '‚ö†Ô∏è Blockiert',
                    speech: '‚ö†Ô∏è Blockiert',
                    camera: '‚ö†Ô∏è Eingeschr√§nkt'
                };
            }
        }
        
        // Globale Instanz (window. f√ºr Script-Block-√ºbergreifenden Zugriff)
        window.browserCaps = new BrowserCapabilities();
        
        // ===== DATA =====
        const taetigkeitenData = {
            'vorbereitung': [
                'Untergrund pr√ºfen',
                'Untergrund reinigen',
                'Untergrund grundieren',
                'Untergrund spachteln',
                'Untergrund schleifen',
                'Estrich vorbereiten',
                'Alte Fliesen entfernen',
                'Putz entfernen',
                'Boden nivellieren',
                'Entkopplungsmatte verlegen'
            ],
            'verlegung': [
                'Fliesen zuschneiden',
                'Fliesen verlegen Wand',
                'Fliesen verlegen Boden',
                'Mosaikfliesen verlegen',
                'Gro√üformat verlegen',
                'Kleber auftragen',
                'Ausrichten mit Laser',
                'Fugenkreuze setzen',
                'Sockelfliesen setzen',
                'Dehnungsfugen einbauen'
            ],
            'verfugung': [
                'Fugenm√∂rtel anr√ºhren',
                'Fugen verf√ºllen',
                'Fugen abziehen',
                'Fugen gl√§tten',
                'Silikonfugen ziehen',
                'Fugenbreite pr√ºfen',
                '√úberschuss entfernen',
                'Fugen versiegeln',
                'Eckfugen bearbeiten',
                'Dehnfugen verf√ºllen'
            ],
            'sanierung': [
                'Schadensstelle freilegen',
                'Besch√§digte Fliesen ersetzen',
                'Risse sanieren',
                'Undichte Stellen abdichten',
                'Fugen erneuern',
                'Schimmel entfernen',
                'Feuchtigkeit beseitigen',
                'Untergrund reparieren',
                'Abdichtung erneuern',
                'Bestandsaufnahme durchf√ºhren'
            ],
            'spezial': [
                'Mosaik-Layout erstellen',
                'Naturstein verlegen',
                'Terrassenplatten verlegen',
                'Treppenstufen fliesen',
                'Nische auskleiden',
                'Bodenablauf einbauen',
                'Wandnische einbauen',
                'Sonderanfertigung einpassen',
                'Schwellenbereich bearbeiten',
                'Barrierefreier Zugang'
            ],
            'abschluss': [
                'Baustelle reinigen',
                'Schutzfolie anbringen',
                'Endkontrolle durchf√ºhren',
                '√úbergabe vorbereiten',
                'Dokumentation erstellen',
                'Material entsorgen',
                'Werkzeug reinigen',
                'Restmaterial verpacken',
                'M√§ngelliste erstellen',
                'Abnahmeprotokoll'
            ]
        };
        
        const materialData = {
            'fliesen': [
                'Wandfliesen 30x60cm',
                'Bodenfliesen 60x60cm',
                'Bodenfliesen 80x80cm',
                'Mosaikfliesen',
                'Gro√üformat 120x120cm',
                'Feinsteinzeug',
                'Natursteinfliesen',
                'Sockelfliesen',
                'Bord√ºren',
                'Dekorplatten'
            ],
            'kleber': [
                'Flexkleber',
                'Standardkleber',
                'D√ºnnbettm√∂rtel',
                'Natursteinm√∂rtel',
                'Schnellkleber',
                'Fliesenkleber au√üen',
                'Dispersionkleber',
                'Haftgrund',
                'Grundierung',
                'Ausgleichsmasse'
            ],
            'fugen': [
                'Fugenm√∂rtel grau',
                'Fugenm√∂rtel wei√ü',
                'Fugenm√∂rtel schwarz',
                'Flexfuge',
                'Epoxidharzfuge',
                'Silikon transparent',
                'Silikon sanit√§r',
                'Acrylfuge',
                'Dehnfugenmasse',
                'Fugenreiniger'
            ],
            'abdichtung': [
                'Dichtschl√§mme',
                'Fl√ºssigfolie',
                'Dichtband',
                'Abdichtungsbahn',
                'Wannenrandband',
                'Eckdichtband',
                'Manschette',
                'Dichtfolie',
                'Grundierung',
                'Sperrgrund'
            ],
            'profile': [
                'Eckprofil Alu',
                'Abschlussprofil',
                '√úbergangsschiene',
                'Dehnfugenprofil',
                'Fliesenschiene',
                'Kantenschutz',
                'Treppenprofil',
                'Sockelprofil',
                'LED-Profil',
                'Quadratprofil'
            ],
            'sonstiges': [
                'Fliesenkreuze 3mm',
                'Fliesenkeile',
                'Nivelliersystem',
                'Fugenkratzer',
                'Reinigungsmittel',
                'Schwamm',
                'Eimer',
                'R√ºhrstab',
                'Zahnspachtel',
                'Gl√§ttekelle'
            ]
        };
        
        const werkzeugeData = {
            'schneiden': [
                'Fliesenschneider',
                'Nassschneider',
                'Winkelschleifer',
                'Bohrkrone',
                'Lochs√§ge',
                'Glasschneider',
                'Diamantscheibe',
                'Zange',
                'Schneidzange',
                'Fliesenbrechzange'
            ],
            'kleber': [
                'Zahnkelle 6mm',
                'Zahnkelle 8mm',
                'Zahnkelle 10mm',
                'Gl√§ttekelle',
                'Spachtel',
                'Kleberkamm',
                'R√ºhrquirl',
                'M√∂rteleimer',
                'Kelle',
                'Maurerkelle'
            ],
            'fugen': [
                'Fugenkratzer',
                'Fugengummi',
                'Fugenbrett',
                'Fugenschwamm',
                'Fuggl√§tter',
                'Silikonspritze',
                'Kartuschenpistole',
                'Fugengl√§tter',
                'Abzieher',
                'Fugenschaber'
            ],
            'maschinen': [
                'R√ºttelplatte',
                'Schleifmaschine',
                'Stemmhammer',
                'Bohrmaschine',
                'Akkuschrauber',
                'R√ºhrger√§t',
                'Absaugger√§t',
                'Staubsauger',
                'Flex',
                'Trennschleifer'
            ],
            'messen': [
                'Wasserwaage',
                'Laser',
                'Richtschnur',
                'Zollstock',
                'Winkelmesser',
                'Lot',
                'Schlagschnur',
                'Digitalmessger√§t',
                'Neigungsmesser',
                'Schieblehre'
            ],
            'handwerkzeug': [
                'Hammer',
                'Gummihammer',
                'Mei√üel',
                'Cutter',
                'Zange',
                'Schraubendreher',
                'Eimer',
                'Schwamm',
                'Besen',
                'Schaufel'
            ]
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // v1.14/v1.15: HTTPS WARNING BANNER & DEBUG INFO
            if (!window.isSecureContext) {
                // Zeige Warning Banner
                const banner = document.getElementById('httpsWarningBanner');
                if (banner) {
                    banner.style.display = 'flex';
                    document.getElementById('currentProtocol').textContent = window.location.protocol + '//' + window.location.hostname;
                }
                
                // Zeige Debug Info Box
                const debugBox = document.getElementById('debugInfoBox');
                if (debugBox) {
                    debugBox.style.display = 'block';
                    document.getElementById('debugProtocol').textContent = window.location.protocol + (window.location.protocol === 'http:' ? ' ‚ùå' : ' ‚úÖ');
                    document.getElementById('debugSecure').textContent = window.isSecureContext ? '‚úÖ JA' : '‚ùå NEIN';
                    document.getElementById('debugGPS').textContent = 'geolocation' in navigator ? '‚úÖ' : '‚ùå';
                    document.getElementById('debugSpeech').textContent = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) ? '‚úÖ' : '‚ùå';
                    document.getElementById('debugBarcode').textContent = 'BarcodeDetector' in window ? '‚úÖ' : '‚ö†Ô∏è Fallback';
                }
                
                console.log('üõ†Ô∏è v1.14 Debug-Tools aktiviert:');
                console.log('   - HTTPS Warning Banner: ‚úÖ');
                console.log('   - Debug Info Box: ‚úÖ');
                console.log('   - Eruda Console: ‚úÖ (siehe Icon unten rechts)');
            }
            
            setupSignaturePads();
            // Auto-GPS beim Laden (IP-basiert als Fallback)
            autoLoadLocation();
            updateRapportNummer();
            // KI-Status pr√ºfen und anzeigen
            checkKIStatus();
            // Wissensbasis-Z√§hler aktualisieren
            updateWissensbasisCounts();
            // KI-Lernstatistik aktualisieren
            updateKIStats();
            // Firebase Cloud-Sync initialisieren
            initFirebase();

            const today = new Date();
            document.getElementById('datum').valueAsDate = today;
            
            // Update datum displays
            const dateStr = today.toLocaleDateString('de-DE');
            document.getElementById('datumDisplay1').textContent = dateStr;
            document.getElementById('datumDisplay2').textContent = dateStr;
            
            // Listen to datum changes
            document.getElementById('datum').addEventListener('change', function() {
                const date = new Date(this.value);
                const dateStr = date.toLocaleDateString('de-DE');
                document.getElementById('datumDisplay1').textContent = dateStr;
                document.getElementById('datumDisplay2').textContent = dateStr;
            });
            
            // Initialize Auto-Save
            restoreAutoSave();
            enableAutoSave();
            
        });
        
        // ===== TAB SWITCHING =====
        function switchToTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchToTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'liste') {
                loadBerichte();
            }
        }

        // ===== KI EINSTELLUNGEN & API FUNKTIONEN =====

        // KI Settings Modal √∂ffnen/schlie√üen
        function openKISettings() {
            const modal = document.getElementById('kiSettingsModal');
            modal.style.display = 'flex';
            loadKISettings();
            updateKISettingsStatus();
        }

        function closeKISettings() {
            document.getElementById('kiSettingsModal').style.display = 'none';
        }

        // API Keys speichern/laden
        function saveKISettings() {
            const groqKey = document.getElementById('groqApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();

            if (groqKey) localStorage.setItem('groqApiKey', groqKey);
            else localStorage.removeItem('groqApiKey');

            if (geminiKey) localStorage.setItem('geminiApiKey', geminiKey);
            else localStorage.removeItem('geminiApiKey');

            updateKISettingsStatus();
            checkKIStatus(); // Update auch den Status-Badge
            showToast('‚úÖ KI-Einstellungen gespeichert', 'success');
        }

        function loadKISettings() {
            const groqKey = localStorage.getItem('groqApiKey') || '';
            const geminiKey = localStorage.getItem('geminiApiKey') || '';

            document.getElementById('groqApiKey').value = groqKey;
            document.getElementById('geminiApiKey').value = geminiKey;
        }

        function updateKISettingsStatus() {
            const groqKey = localStorage.getItem('groqApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');
            const statusEl = document.getElementById('kiStatus');

            let html = '<div style="font-size:13px;">';

            if (groqKey) {
                html += '<div style="color:#22c55e; margin-bottom:5px;">‚úÖ Groq: Konfiguriert</div>';
            } else {
                html += '<div style="color:#ef4444; margin-bottom:5px;">‚ùå Groq: Nicht konfiguriert</div>';
            }

            if (geminiKey) {
                html += '<div style="color:#22c55e;">‚úÖ Gemini: Konfiguriert</div>';
            } else {
                html += '<div style="color:#ef4444;">‚ùå Gemini: Nicht konfiguriert</div>';
            }

            if (!groqKey && !geminiKey) {
                html += '<div style="color:#f59e0b; margin-top:8px; font-size:12px;">‚ö†Ô∏è Mindestens ein API-Key wird f√ºr KI-Funktionen ben√∂tigt</div>';
            }

            html += '</div>';
            statusEl.innerHTML = html;
        }

        // Verbindungstest
        async function testKIConnection() {
            const groqKey = localStorage.getItem('groqApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');

            if (!groqKey && !geminiKey) {
                showToast('‚ö†Ô∏è Bitte erst einen API-Key eingeben', 'error');
                return;
            }

            showToast('üîÑ Teste Verbindung...', 'info');

            // Teste Groq
            if (groqKey) {
                try {
                    const result = await callGroqAPI('Antworte nur mit: OK', groqKey);
                    if (result) {
                        showToast('‚úÖ Groq funktioniert!', 'success');
                        return;
                    }
                } catch (e) {
                    console.log('Groq Test fehlgeschlagen:', e);
                }
            }

            // Teste Gemini
            if (geminiKey) {
                try {
                    const result = await callGeminiAPI('Antworte nur mit: OK', geminiKey);
                    if (result) {
                        showToast('‚úÖ Gemini funktioniert!', 'success');
                        return;
                    }
                } catch (e) {
                    console.log('Gemini Test fehlgeschlagen:', e);
                }
            }

            showToast('‚ùå Verbindung fehlgeschlagen. Bitte API-Keys pr√ºfen.', 'error');
        }

        // ===== GROQ API =====
        async function callGroqAPI(prompt, apiKey) {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.1-70b-versatile',
                    messages: [
                        {
                            role: 'system',
                            content: `Du bist ein Assistent f√ºr Fliesenleger-Baustellenberichte.
Deine Aufgabe ist es, gesprochene Texte in professionelle, kurze T√§tigkeitsbeschreibungen umzuwandeln.
Regeln:
- Maximal 1-2 S√§tze
- Fachbegriffe korrekt verwenden (Feinsteinzeug, D√ºnnbettm√∂rtel, Flexkleber, etc.)
- Mengenangaben beibehalten (m¬≤, St√ºck, lfm)
- Professioneller Baustellenbericht-Stil
- Nur die verbesserte Beschreibung ausgeben, keine Erkl√§rungen`
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 200,
                    temperature: 0.3
                })
            });

            if (!response.ok) {
                throw new Error(`Groq API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0]?.message?.content?.trim() || null;
        }

        // ===== GEMINI API =====
        async function callGeminiAPI(prompt, apiKey) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `Du bist ein Assistent f√ºr Fliesenleger-Baustellenberichte.
Wandle folgenden gesprochenen Text in eine professionelle, kurze T√§tigkeitsbeschreibung um.
Regeln:
- Maximal 1-2 S√§tze
- Fachbegriffe korrekt verwenden
- Mengenangaben beibehalten
- Nur die verbesserte Beschreibung ausgeben

Text: ${prompt}`
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 200,
                        temperature: 0.3
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
        }

        // ===== HAUPT-KI-FUNKTION (mit Fallback) =====
        async function verbessereMitKI(text) {
            const groqKey = localStorage.getItem('groqApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');

            // Versuche Groq zuerst
            if (groqKey) {
                try {
                    const result = await callGroqAPI(text, groqKey);
                    if (result) {
                        console.log('‚úÖ KI-Verbesserung via Groq');
                        return { text: result, source: 'Groq' };
                    }
                } catch (e) {
                    console.log('Groq fehlgeschlagen, versuche Gemini...', e);
                }
            }

            // Fallback zu Gemini
            if (geminiKey) {
                try {
                    const result = await callGeminiAPI(text, geminiKey);
                    if (result) {
                        console.log('‚úÖ KI-Verbesserung via Gemini');
                        return { text: result, source: 'Gemini' };
                    }
                } catch (e) {
                    console.log('Gemini fehlgeschlagen', e);
                }
            }

            // Keine KI verf√ºgbar
            return null;
        }

        // Pr√ºfen ob KI verf√ºgbar ist
        function isKIAvailable() {
            return localStorage.getItem('groqApiKey') || localStorage.getItem('geminiApiKey');
        }

        // ===== V3.4: KI-AGENT SYSTEM =====

        // Agent-Variablen
        let agentRecognition = null;
        let agentIsRecording = false;
        let agentFullText = '';

        // Firmen-Wissensbasis laden
        function getWissensbasis() {
            return {
                mitarbeiter: JSON.parse(localStorage.getItem('firmenMitarbeiter') || '[]'),
                kunden: JSON.parse(localStorage.getItem('firmenKunden') || '[]'),
                materialien: JSON.parse(localStorage.getItem('firmenMaterialien') || '[]'),
                gelernteBeispiele: JSON.parse(localStorage.getItem('gelernteBeispiele') || '[]')
            };
        }

        // Wissensbasis-Counts aktualisieren
        function updateWissensbasisCounts() {
            const wb = getWissensbasis();
            const mEl = document.getElementById('wbMitarbeiterCount');
            const kEl = document.getElementById('wbKundenCount');
            const bEl = document.getElementById('wbBerichteCount');
            if (mEl) mEl.textContent = wb.mitarbeiter.length;
            if (kEl) kEl.textContent = wb.kunden.length;
            if (bEl) bEl.textContent = wb.gelernteBeispiele.length;
        }

        // Agent-Aufnahme starten
        function startAgentRecording() {
            if (!isKIAvailable()) {
                showToast('‚ö†Ô∏è Bitte erst KI-API-Key einrichten (‚öôÔ∏è KI Button)', 'error');
                openKISettings();
                return;
            }

            if (agentIsRecording) return;

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Spracheingabe nicht verf√ºgbar', 'error');
                return;
            }

            agentIsRecording = true;
            agentFullText = '';

            const btn = document.getElementById('agentButton');
            const status = document.getElementById('agentStatus');
            const statusText = document.getElementById('agentStatusText');
            const preview = document.getElementById('agentPreview');

            btn.style.background = 'rgba(239, 68, 68, 0.8)';
            btn.style.borderColor = 'white';
            status.style.display = 'block';
            statusText.textContent = 'üé§ Aufnahme l√§uft... Sprich deinen Bericht';
            preview.textContent = '';

            startAgentSession();
        }

        // Agent-Session (mit Auto-Neustart)
        function startAgentSession() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            agentRecognition = new SpeechRecognition();

            agentRecognition.lang = 'de-DE';
            agentRecognition.continuous = true;
            agentRecognition.interimResults = true;

            let sessionText = '';
            let interimText = '';

            agentRecognition.onresult = function(event) {
                interimText = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        sessionText += event.results[i][0].transcript + ' ';
                    } else {
                        interimText += event.results[i][0].transcript;
                    }
                }

                const preview = document.getElementById('agentPreview');
                if (preview) {
                    preview.textContent = '"' + (agentFullText + sessionText + interimText).trim() + '"';
                }
            };

            agentRecognition.onend = function() {
                agentFullText += sessionText;

                if (agentIsRecording) {
                    // Auto-Neustart
                    setTimeout(() => {
                        if (agentIsRecording) {
                            startAgentSession();
                        }
                    }, 100);
                }
            };

            agentRecognition.onerror = function(event) {
                if (event.error === 'aborted' || event.error === 'no-speech') {
                    if (agentIsRecording) {
                        agentFullText += sessionText;
                        setTimeout(() => {
                            if (agentIsRecording) startAgentSession();
                        }, 100);
                    }
                    return;
                }
                console.error('Agent Speech Error:', event.error);
            };

            try {
                agentRecognition.start();
            } catch (e) {
                console.error('Agent start error:', e);
            }
        }

        // Agent-Aufnahme stoppen und verarbeiten
        async function stopAgentRecording() {
            if (!agentIsRecording) return;

            agentIsRecording = false;

            if (agentRecognition) {
                try {
                    agentRecognition.stop();
                } catch (e) {}
                agentRecognition = null;
            }

            const btn = document.getElementById('agentButton');
            const status = document.getElementById('agentStatus');
            const statusText = document.getElementById('agentStatusText');

            btn.style.background = 'rgba(255,255,255,0.2)';
            btn.style.borderColor = 'rgba(255,255,255,0.5)';

            const text = agentFullText.trim();

            if (!text || text.length < 10) {
                status.style.display = 'none';
                showToast('‚ö†Ô∏è Bitte l√§nger sprechen', 'info');
                return;
            }

            statusText.textContent = 'ü§ñ Agent analysiert deinen Bericht...';
            showToast('ü§ñ Agent verarbeitet...', 'info');

            try {
                const result = await processAgentText(text);
                if (result) {
                    fillFormFromAgent(result);
                    statusText.textContent = '‚úÖ Bericht wurde ausgef√ºllt!';
                    showToast('‚úÖ Agent hat alle Felder ausgef√ºllt!', 'success');

                    // Aus dem Bericht lernen
                    saveToWissensbasis(text, result);

                    // F√ºr Feedback speichern
                    window.lastAgentInput = text;
                    window.lastAgentResult = result;

                    // Feedback-Section anzeigen
                    setTimeout(() => {
                        status.style.display = 'none';
                        showFeedbackSection();
                    }, 1500);
                }
            } catch (e) {
                console.error('Agent error:', e);
                statusText.textContent = '‚ùå Fehler bei der Verarbeitung';
                showToast('‚ùå Agent-Fehler: ' + e.message, 'error');
            }
        }

        // ===== FEEDBACK-SYSTEM F√úR KI-LERNEN =====

        // Feedback-Section anzeigen
        function showFeedbackSection() {
            const section = document.getElementById('feedbackSection');
            const details = document.getElementById('feedbackDetails');
            if (section) {
                section.style.display = 'block';
                details.style.display = 'none';
                // Checkboxen zur√ºcksetzen
                ['fbName', 'fbMenge', 'fbBaustelle', 'fbStunden', 'fbSonstig'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
                const noteEl = document.getElementById('feedbackNote');
                if (noteEl) noteEl.value = '';
            }
        }

        // Feedback absenden
        function submitFeedback(type) {
            if (type === 'correct') {
                // Direkt als korrekt speichern
                saveFeedbackData({
                    type: 'correct',
                    timestamp: new Date().toISOString(),
                    input: window.lastAgentInput,
                    aiResult: window.lastAgentResult,
                    errors: [],
                    note: ''
                });
                document.getElementById('feedbackSection').style.display = 'none';
                showToast('üëç Danke! KI lernt aus korrekten Beispielen.', 'success');
                updateKIStats();
            } else {
                // Details-Bereich anzeigen
                document.getElementById('feedbackDetails').style.display = 'block';
            }
        }

        // Feedback mit Details speichern
        function saveFeedbackWithDetails() {
            const errors = [];
            if (document.getElementById('fbName')?.checked) errors.push('namen');
            if (document.getElementById('fbMenge')?.checked) errors.push('mengen');
            if (document.getElementById('fbBaustelle')?.checked) errors.push('baustelle');
            if (document.getElementById('fbStunden')?.checked) errors.push('stunden');
            if (document.getElementById('fbSonstig')?.checked) errors.push('sonstiges');

            const note = document.getElementById('feedbackNote')?.value || '';

            // Aktuelle Formular-Werte als Korrektur erfassen
            const correctedData = getCurrentFormData();

            saveFeedbackData({
                type: 'corrected',
                timestamp: new Date().toISOString(),
                input: window.lastAgentInput,
                aiResult: window.lastAgentResult,
                correctedResult: correctedData,
                errors: errors,
                note: note
            });

            document.getElementById('feedbackSection').style.display = 'none';
            showToast('‚úèÔ∏è Danke! KI lernt aus deiner Korrektur.', 'success');
            updateKIStats();

            // Aus Korrektur lernen
            learnFromCorrection(window.lastAgentInput, window.lastAgentResult, correctedData, errors);
        }

        // Aktuelle Formulardaten erfassen
        function getCurrentFormData() {
            const taetigkeiten = [];
            const tbody = document.getElementById('taetigkeitenTable');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, i) => {
                    const cells = row.querySelectorAll('td');
                    const textarea = row.querySelector('textarea');
                    taetigkeiten.push({
                        position: String(i + 1),
                        beschreibung: textarea?.value || cells[2]?.textContent || '',
                        menge: cells[3]?.textContent || ''
                    });
                });
            }

            return {
                projektnummer: document.getElementById('projektnummer')?.value || '',
                baustelle: document.getElementById('baustelle')?.value || '',
                taetigkeiten: taetigkeiten,
                material: document.getElementById('materialText')?.value || '',
                notizen: document.getElementById('notizenText')?.value || ''
            };
        }

        // Feedback in LocalStorage speichern
        function saveFeedbackData(data) {
            let feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
            feedbacks.push(data);
            // Maximal 200 Feedbacks speichern
            if (feedbacks.length > 200) feedbacks = feedbacks.slice(-200);
            localStorage.setItem('kiFeedback', JSON.stringify(feedbacks));
        }

        // Aus Korrektur lernen
        function learnFromCorrection(input, aiResult, correctedResult, errorTypes) {
            // Validierung
            if (!correctedResult) return;

            // Wenn Namen falsch waren, versuche korrigierte Namen zu extrahieren
            if (errorTypes && errorTypes.includes('namen') && correctedResult.baustelle) {
                // Extrahiere m√∂gliche Kundennamen aus korrigierter Baustelle
                const wb = getWissensbasis();
                const baustelleName = correctedResult.baustelle.split(/[,\s-]/)[0].trim();
                if (baustelleName && baustelleName.length > 2 && !wb.kunden.includes(baustelleName)) {
                    wb.kunden.push(baustelleName);
                    localStorage.setItem('firmenKunden', JSON.stringify(wb.kunden));
                    console.log('üß† Neuer Kunde gelernt:', baustelleName);
                }
            }

            // Speichere als Lern-Beispiel
            let corrections = JSON.parse(localStorage.getItem('kiCorrections') || '[]');
            corrections.push({
                input: input,
                wrong: aiResult,
                correct: correctedResult,
                errorTypes: errorTypes,
                timestamp: new Date().toISOString()
            });
            // Maximal 50 Korrekturen f√ºr Prompt-Verbesserung
            if (corrections.length > 50) corrections = corrections.slice(-50);
            localStorage.setItem('kiCorrections', JSON.stringify(corrections));
        }

        // KI-Statistiken aktualisieren
        function updateKIStats() {
            const feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
            const total = feedbacks.length;
            const correct = feedbacks.filter(f => f.type === 'correct').length;

            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            const barEl = document.getElementById('kiAccuracyBar');
            const percentEl = document.getElementById('kiAccuracyPercent');
            const countEl = document.getElementById('kiFeedbackCount');

            if (barEl) barEl.style.width = accuracy + '%';
            if (percentEl) percentEl.textContent = total > 0 ? accuracy + '%' : '--%';
            if (countEl) countEl.textContent = total;

            // Farbe basierend auf Genauigkeit
            if (barEl) {
                if (accuracy >= 80) {
                    barEl.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                } else if (accuracy >= 60) {
                    barEl.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                } else {
                    barEl.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                }
            }
        }

        // KI-Statistiken Detail-Ansicht
        function showKIStats() {
            const feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
            const corrections = JSON.parse(localStorage.getItem('kiCorrections') || '[]');

            const total = feedbacks.length;
            const correct = feedbacks.filter(f => f.type === 'correct').length;
            const corrected = feedbacks.filter(f => f.type === 'corrected').length;

            // Fehlertypen z√§hlen
            const errorCounts = {};
            feedbacks.filter(f => f.errors).forEach(f => {
                f.errors.forEach(e => {
                    errorCounts[e] = (errorCounts[e] || 0) + 1;
                });
            });

            let errorList = Object.entries(errorCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => `  ‚Ä¢ ${type}: ${count}x`)
                .join('\n') || '  Keine Fehler erfasst';

            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            alert(`üìä KI-LERNSTATISTIK\n\n` +
                  `Gesamt-Bewertungen: ${total}\n` +
                  `‚úÖ Korrekt: ${correct} (${accuracy}%)\n` +
                  `‚úèÔ∏è Korrigiert: ${corrected}\n\n` +
                  `H√§ufigste Fehlertypen:\n${errorList}\n\n` +
                  `Gespeicherte Korrekturen: ${corrections.length}\n\n` +
                  `Je mehr Feedback, desto besser wird die KI!`);
        }

        // Gelernte Korrekturen in Prompt einbauen
        function getLearnedExamples() {
            const corrections = JSON.parse(localStorage.getItem('kiCorrections') || '[]');
            if (corrections.length === 0) return '';

            // Die letzten 3 Korrekturen als Beispiele (mit null-checks)
            const examples = corrections.slice(-3).map(c => {
                const baustelle = c.correct?.baustelle || 'unbekannt';
                const projektnummer = c.correct?.projektnummer || 'unbekannt';
                const inputText = c.input ? c.input.substring(0, 100) : '';
                return `Eingabe: "${inputText}..."\nKorrektes Ergebnis: Baustelle="${baustelle}", Projekt="${projektnummer}"`;
            }).join('\n\n');

            return `\n\nBEISPIELE AUS FR√úHEREN KORREKTUREN:\n${examples}`;
        }

        // ===== FIREBASE CLOUD-SYNC =====

        // Firebase Konfiguration (√∂ffentliche Demo-Instanz)
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-Key-Replace-With-Your-Own",
            authDomain: "baustellenbericht-demo.firebaseapp.com",
            databaseURL: "https://baustellenbericht-demo-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "baustellenbericht-demo",
            storageBucket: "baustellenbericht-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        let firebaseApp = null;
        let firebaseDb = null;
        let cloudTeamCode = null;

        // Firebase initialisieren
        function initFirebase() {
            try {
                // Pr√ºfe ob Firebase verf√ºgbar
                if (typeof firebase === 'undefined') {
                    console.log('Firebase SDK nicht geladen');
                    return false;
                }

                // Gespeicherten Team-Code laden
                cloudTeamCode = localStorage.getItem('cloudTeamCode');
                const userName = localStorage.getItem('cloudUserName');

                if (cloudTeamCode) {
                    document.getElementById('firebaseTeamCode').value = cloudTeamCode;
                    if (userName) document.getElementById('cloudUserName').value = userName;

                    // Automatisch verbinden
                    connectToCloud(true);
                }

                return true;
            } catch (e) {
                console.error('Firebase init error:', e);
                return false;
            }
        }

        // Cloud-Einstellungen anzeigen/verstecken
        function toggleCloudSettings() {
            const panel = document.getElementById('cloudSettingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Mit Cloud verbinden
        async function connectToCloud(silent = false) {
            const teamCode = document.getElementById('firebaseTeamCode')?.value?.trim();
            const userName = document.getElementById('cloudUserName')?.value?.trim();

            if (!teamCode) {
                if (!silent) showToast('‚ö†Ô∏è Bitte Team-Code eingeben', 'info');
                return;
            }

            try {
                // Firebase App initialisieren (falls noch nicht geschehen)
                if (!firebaseApp && typeof firebase !== 'undefined') {
                    // Verwende Team-Code als Datenbank-Pfad
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    firebaseDb = firebase.database();
                }

                if (!firebaseDb) {
                    // Fallback: Ohne Firebase, nur lokale Simulation
                    updateCloudStatus('simulated');
                    if (!silent) showToast('‚òÅÔ∏è Cloud-Simulation aktiv (ohne echtes Backend)', 'info');
                    localStorage.setItem('cloudTeamCode', teamCode);
                    if (userName) localStorage.setItem('cloudUserName', userName);
                    cloudTeamCode = teamCode;
                    document.getElementById('cloudSyncButtons').style.display = 'flex';
                    return;
                }

                cloudTeamCode = teamCode;
                localStorage.setItem('cloudTeamCode', teamCode);
                if (userName) localStorage.setItem('cloudUserName', userName);

                // Verbindung testen
                const testRef = firebaseDb.ref(`teams/${teamCode}/meta`);
                await testRef.once('value');

                updateCloudStatus('connected');
                document.getElementById('cloudSyncButtons').style.display = 'flex';

                if (!silent) showToast('‚úÖ Mit Cloud verbunden!', 'success');

                // Echtzeit-Listener f√ºr Updates
                setupRealtimeSync();

            } catch (e) {
                console.error('Cloud connect error:', e);
                // Fallback zu Simulation
                updateCloudStatus('simulated');
                localStorage.setItem('cloudTeamCode', teamCode);
                if (userName) localStorage.setItem('cloudUserName', userName);
                cloudTeamCode = teamCode;
                document.getElementById('cloudSyncButtons').style.display = 'flex';
                if (!silent) showToast('‚òÅÔ∏è Offline-Modus (wird synchronisiert wenn online)', 'info');
            }
        }

        // Von Cloud trennen
        function disconnectCloud() {
            cloudTeamCode = null;
            localStorage.removeItem('cloudTeamCode');
            localStorage.removeItem('cloudUserName');
            updateCloudStatus('disconnected');
            document.getElementById('cloudSyncButtons').style.display = 'none';
            document.getElementById('cloudSettingsPanel').style.display = 'none';
            showToast('‚ùå Cloud-Verbindung getrennt', 'info');
        }

        // Cloud-Status UI aktualisieren
        function updateCloudStatus(status) {
            const icon = document.getElementById('cloudStatusIcon');
            const text = document.getElementById('cloudStatusText');

            const statuses = {
                'connected': { icon: 'üü¢', text: 'Verbunden mit Team', color: '#10b981' },
                'simulated': { icon: 'üü°', text: 'Lokaler Sync-Modus', color: '#f59e0b' },
                'syncing': { icon: 'üîÑ', text: 'Synchronisiere...', color: '#667eea' },
                'disconnected': { icon: '‚ö™', text: 'Nicht verbunden', color: '#64748b' },
                'error': { icon: 'üî¥', text: 'Verbindungsfehler', color: '#ef4444' }
            };

            const s = statuses[status] || statuses['disconnected'];
            if (icon) icon.textContent = s.icon;
            if (text) {
                text.textContent = s.text;
                text.style.color = s.color;
            }
        }

        // Daten zur Cloud hochladen
        async function syncToCloud() {
            if (!cloudTeamCode) {
                showToast('‚ö†Ô∏è Bitte zuerst mit Cloud verbinden', 'info');
                return;
            }

            updateCloudStatus('syncing');

            try {
                const wb = getWissensbasis();
                const feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
                const corrections = JSON.parse(localStorage.getItem('kiCorrections') || '[]');
                const userName = localStorage.getItem('cloudUserName') || 'Unbekannt';

                const uploadData = {
                    mitarbeiter: wb.mitarbeiter,
                    kunden: wb.kunden,
                    materialien: wb.materialien,
                    feedbackCount: feedbacks.length,
                    correctCount: feedbacks.filter(f => f.type === 'correct').length,
                    lastSync: new Date().toISOString(),
                    syncBy: userName
                };

                if (firebaseDb) {
                    // Echte Firebase-Synchronisation
                    const teamRef = firebaseDb.ref(`teams/${cloudTeamCode}`);

                    // Mitarbeiter mergen (nicht √ºberschreiben)
                    const snapshot = await teamRef.child('wissensbasis').once('value');
                    const existing = snapshot.val() || {};

                    const mergedMitarbeiter = [...new Set([...(existing.mitarbeiter || []), ...wb.mitarbeiter])];
                    const mergedKunden = [...new Set([...(existing.kunden || []), ...wb.kunden])];
                    const mergedMaterialien = [...new Set([...(existing.materialien || []), ...wb.materialien])];

                    await teamRef.child('wissensbasis').set({
                        mitarbeiter: mergedMitarbeiter,
                        kunden: mergedKunden,
                        materialien: mergedMaterialien
                    });

                    // Statistiken aktualisieren
                    await teamRef.child(`stats/${userName.replace(/[.#$\/\[\]]/g, '_')}`).set(uploadData);

                    updateCloudStatus('connected');
                    showToast('‚úÖ Daten hochgeladen!', 'success');
                } else {
                    // Simulations-Modus: Speichere in localStorage mit Team-Pr√§fix
                    const key = `cloud_${cloudTeamCode}`;
                    const existing = JSON.parse(localStorage.getItem(key) || '{}');

                    const merged = {
                        mitarbeiter: [...new Set([...(existing.mitarbeiter || []), ...wb.mitarbeiter])],
                        kunden: [...new Set([...(existing.kunden || []), ...wb.kunden])],
                        materialien: [...new Set([...(existing.materialien || []), ...wb.materialien])],
                        lastSync: uploadData.lastSync,
                        syncBy: uploadData.syncBy
                    };

                    localStorage.setItem(key, JSON.stringify(merged));
                    updateCloudStatus('simulated');
                    showToast('‚úÖ Lokal gespeichert (Simulation)', 'success');
                }

            } catch (e) {
                console.error('Sync to cloud error:', e);
                updateCloudStatus('error');
                showToast('‚ùå Sync fehlgeschlagen: ' + e.message, 'error');
            }
        }

        // Daten von Cloud herunterladen
        async function syncFromCloud() {
            if (!cloudTeamCode) {
                showToast('‚ö†Ô∏è Bitte zuerst mit Cloud verbinden', 'info');
                return;
            }

            updateCloudStatus('syncing');

            try {
                let cloudData = null;

                if (firebaseDb) {
                    // Echte Firebase-Daten laden
                    const snapshot = await firebaseDb.ref(`teams/${cloudTeamCode}/wissensbasis`).once('value');
                    cloudData = snapshot.val();
                } else {
                    // Simulations-Modus
                    const key = `cloud_${cloudTeamCode}`;
                    cloudData = JSON.parse(localStorage.getItem(key) || 'null');
                }

                if (!cloudData) {
                    updateCloudStatus(firebaseDb ? 'connected' : 'simulated');
                    showToast('‚ÑπÔ∏è Keine Cloud-Daten vorhanden', 'info');
                    return;
                }

                // Mit lokalen Daten mergen
                const localWb = getWissensbasis();

                const mergedMitarbeiter = [...new Set([...localWb.mitarbeiter, ...(cloudData.mitarbeiter || [])])];
                const mergedKunden = [...new Set([...localWb.kunden, ...(cloudData.kunden || [])])];
                const mergedMaterialien = [...new Set([...localWb.materialien, ...(cloudData.materialien || [])])];

                // Speichern
                localStorage.setItem('firmenMitarbeiter', JSON.stringify(mergedMitarbeiter));
                localStorage.setItem('firmenKunden', JSON.stringify(mergedKunden));
                localStorage.setItem('firmenMaterialien', JSON.stringify(mergedMaterialien));

                // UI aktualisieren
                updateWissensbasisCounts();

                updateCloudStatus(firebaseDb ? 'connected' : 'simulated');
                showToast(`‚úÖ ${mergedMitarbeiter.length} Mitarbeiter, ${mergedKunden.length} Kunden geladen!`, 'success');

            } catch (e) {
                console.error('Sync from cloud error:', e);
                updateCloudStatus('error');
                showToast('‚ùå Download fehlgeschlagen: ' + e.message, 'error');
            }
        }

        // Echtzeit-Sync einrichten (bei Firebase)
        function setupRealtimeSync() {
            if (!firebaseDb || !cloudTeamCode) return;

            const wbRef = firebaseDb.ref(`teams/${cloudTeamCode}/wissensbasis`);

            wbRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    console.log('üîÑ Echtzeit-Update empfangen');
                    // Optional: Automatisch mergen
                    // syncFromCloud(); // Auskommentiert um Endlos-Loop zu vermeiden
                }
            });
        }

        // ===== ANALYTICS DASHBOARD =====

        // Dashboard √∂ffnen
        function openAnalyticsDashboard() {
            document.getElementById('analyticsDashboardModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            updateAnalyticsDashboard();
        }

        // Dashboard schlie√üen
        function closeAnalyticsDashboard() {
            document.getElementById('analyticsDashboardModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Dashboard aktualisieren
        function updateAnalyticsDashboard() {
            const feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
            const corrections = JSON.parse(localStorage.getItem('kiCorrections') || '[]');
            const wb = getWissensbasis();

            // Genauigkeit berechnen
            const total = feedbacks.length;
            const correct = feedbacks.filter(f => f.type === 'correct').length;
            const corrected = total - correct;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            // Genauigkeits-Kreis
            const circleEl = document.getElementById('dashAccuracyCircle');
            if (circleEl) {
                const color = accuracy >= 80 ? '#10b981' : accuracy >= 60 ? '#f59e0b' : '#ef4444';
                circleEl.style.background = `conic-gradient(${color} ${accuracy}%, #e2e8f0 ${accuracy}%)`;
            }

            // Zahlen (mit null-checks)
            const dashAccuracyPercentEl = document.getElementById('dashAccuracyPercent');
            const dashCorrectCountEl = document.getElementById('dashCorrectCount');
            const dashCorrectedCountEl = document.getElementById('dashCorrectedCount');

            if (dashAccuracyPercentEl) dashAccuracyPercentEl.textContent = total > 0 ? accuracy + '%' : '--%';
            if (dashCorrectCountEl) dashCorrectCountEl.textContent = correct;
            if (dashCorrectedCountEl) dashCorrectedCountEl.textContent = corrected;

            // Fehlertypen
            const errorCounts = {};
            feedbacks.filter(f => f.errors).forEach(f => {
                f.errors.forEach(e => {
                    errorCounts[e] = (errorCounts[e] || 0) + 1;
                });
            });

            const errorTypesEl = document.getElementById('dashErrorTypes');
            const sortedErrors = Object.entries(errorCounts).sort((a, b) => b[1] - a[1]);

            if (errorTypesEl) {
                if (sortedErrors.length === 0) {
                    errorTypesEl.innerHTML = '<div style="color:#94a3b8; font-size:13px;">Keine Fehler erfasst - super! üéâ</div>';
                } else {
                    const maxCount = sortedErrors[0][1];
                    errorTypesEl.innerHTML = sortedErrors.slice(0, 5).map(([type, count]) => {
                        const percent = Math.round((count / maxCount) * 100);
                        const labels = {
                            'namen': 'üë§ Namen',
                            'mengen': 'üìè Mengen',
                            'baustelle': 'üèóÔ∏è Baustelle',
                            'stunden': '‚è∞ Stunden',
                            'sonstiges': '‚ùì Sonstiges'
                        };
                        return `<div style="display:flex; align-items:center; gap:10px;">
                            <span style="width:80px; font-size:12px;">${labels[type] || type}</span>
                            <div style="flex:1; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;">
                                <div style="background:#f59e0b; height:100%; width:${percent}%;"></div>
                            </div>
                            <span style="font-size:12px; color:#64748b;">${count}x</span>
                        </div>`;
                    }).join('');
                }
            }

            // Wissensbasis (mit null-checks)
            const dashMitarbeiterEl = document.getElementById('dashMitarbeiter');
            const dashKundenEl = document.getElementById('dashKunden');
            const dashBeispieleEl = document.getElementById('dashBeispiele');

            if (dashMitarbeiterEl) dashMitarbeiterEl.textContent = wb.mitarbeiter.length;
            if (dashKundenEl) dashKundenEl.textContent = wb.kunden.length;
            if (dashBeispieleEl) dashBeispieleEl.textContent = corrections.length;

            // Timeline (mit null-check)
            const timelineEl = document.getElementById('dashTimeline');
            const recentFeedbacks = feedbacks.slice(-10).reverse();

            if (timelineEl) {
                if (recentFeedbacks.length === 0) {
                    timelineEl.innerHTML = '<div style="color:#94a3b8; font-size:13px; text-align:center; padding:20px;">Noch keine Aktivit√§ten</div>';
                } else {
                    timelineEl.innerHTML = recentFeedbacks.map(f => {
                        const date = new Date(f.timestamp);
                        const timeStr = date.toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        const icon = f.type === 'correct' ? '‚úÖ' : '‚úèÔ∏è';
                        const text = f.type === 'correct' ? 'Korrekt erkannt' : `Korrigiert (${f.errors?.join(', ') || 'unbekannt'})`;
                        return `<div style="display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #f1f5f9;">
                            <span style="font-size:16px;">${icon}</span>
                            <div style="flex:1;">
                                <div style="font-size:12px;">${text}</div>
                                <div style="font-size:10px; color:#94a3b8;">${timeStr}</div>
                            </div>
                        </div>`;
                    }).join('');
                }
            }

            // Trend-Chart (letzte 7 Tage)
            const trendChartEl = document.getElementById('dashTrendChart');
            const today = new Date();
            const days = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                const dayFeedbacks = feedbacks.filter(f => f.timestamp?.startsWith(dateStr));
                const dayCorrect = dayFeedbacks.filter(f => f.type === 'correct').length;
                const dayTotal = dayFeedbacks.length;

                days.push({
                    date: dateStr,
                    total: dayTotal,
                    correct: dayCorrect,
                    accuracy: dayTotal > 0 ? Math.round((dayCorrect / dayTotal) * 100) : null
                });
            }

            const maxTotal = Math.max(...days.map(d => d.total), 1);

            if (trendChartEl) {
                trendChartEl.innerHTML = days.map((d, i) => {
                    const height = d.total > 0 ? Math.max(20, (d.total / maxTotal) * 80) : 10;
                    const color = d.accuracy === null ? '#e2e8f0' :
                                  d.accuracy >= 80 ? '#10b981' :
                                  d.accuracy >= 60 ? '#f59e0b' : '#ef4444';
                    const dayName = new Date(d.date).toLocaleDateString('de-DE', { weekday: 'short' });

                    return `<div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:4px;">
                        <div style="width:100%; background:${color}; height:${height}px; border-radius:4px;" title="${d.total} Berichte, ${d.accuracy !== null ? d.accuracy + '% korrekt' : 'keine Daten'}"></div>
                        <span style="font-size:9px; color:#94a3b8;">${dayName}</span>
                    </div>`;
                }).join('');
            }

            // Cloud-Status (mit null-checks)
            const cloudIcon = document.getElementById('dashCloudIcon');
            const cloudText = document.getElementById('dashCloudText');
            const cloudDetails = document.getElementById('dashCloudDetails');

            if (cloudIcon && cloudText && cloudDetails) {
                if (cloudTeamCode) {
                    cloudIcon.textContent = firebaseDb ? 'üü¢' : 'üü°';
                    cloudText.textContent = firebaseDb ? 'Mit Team verbunden' : 'Lokaler Sync-Modus';
                    cloudDetails.textContent = `Team: ${cloudTeamCode}`;
                } else {
                    cloudIcon.textContent = '‚ö™';
                    cloudText.textContent = 'Nicht verbunden';
                    cloudDetails.textContent = 'Team-Code eingeben um zu verbinden';
                }
            }
        }

        // Analytics als CSV exportieren
        function exportAnalytics() {
            const feedbacks = JSON.parse(localStorage.getItem('kiFeedback') || '[]');
            const wb = getWissensbasis();

            let csv = 'Datum,Typ,Fehler,Notiz\n';
            feedbacks.forEach(f => {
                const date = f.timestamp ? new Date(f.timestamp).toLocaleString('de-DE') : '';
                const type = f.type === 'correct' ? 'Korrekt' : 'Korrigiert';
                const errors = f.errors?.join('; ') || '';
                const note = (f.note || '').replace(/"/g, '""');
                csv += `"${date}","${type}","${errors}","${note}"\n`;
            });

            csv += '\n\nWissensbasis\n';
            csv += 'Typ,Werte\n';
            csv += `"Mitarbeiter","${wb.mitarbeiter.join(', ')}"\n`;
            csv += `"Kunden","${wb.kunden.join(', ')}"\n`;
            csv += `"Materialien","${wb.materialien.join(', ')}"\n`;

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ki-analytics-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('üì• Analytics exportiert!', 'success');
        }

        // Analytics zur√ºcksetzen
        function resetAnalytics() {
            if (!confirm('‚ö†Ô∏è ACHTUNG!\n\nDas l√∂scht ALLE KI-Lerndaten:\n- Alle Feedbacks\n- Alle Korrekturen\n- Die Wissensbasis\n\nDie KI muss dann neu lernen!\n\nWirklich fortfahren?')) {
                return;
            }

            if (!confirm('üî¥ Letzte Warnung!\n\nAlle Daten werden unwiderruflich gel√∂scht!\n\nSicher?')) {
                return;
            }

            localStorage.removeItem('kiFeedback');
            localStorage.removeItem('kiCorrections');
            localStorage.removeItem('firmenMitarbeiter');
            localStorage.removeItem('firmenKunden');
            localStorage.removeItem('firmenMaterialien');
            localStorage.removeItem('gelernteBeispiele');

            updateAnalyticsDashboard();
            updateKIStats();
            updateWissensbasisCounts();

            showToast('üóëÔ∏è Alle KI-Daten gel√∂scht', 'info');
        }

        // Agent-Text mit KI verarbeiten
        async function processAgentText(text) {
            const wb = getWissensbasis();
            const learnedExamples = getLearnedExamples();

            const systemPrompt = `Du bist ein KI-Agent f√ºr Fliesenleger-Baustellenberichte.
Analysiere den gesprochenen Text und extrahiere ALLE relevanten Informationen.

FIRMEN-WISSENSBASIS:
- Bekannte Mitarbeiter: ${wb.mitarbeiter.join(', ') || 'keine'}
- Bekannte Kunden/Baustellen: ${wb.kunden.join(', ') || 'keine'}
- H√§ufige Materialien: ${wb.materialien.join(', ') || 'Standard-Fliesenmaterial'}
${learnedExamples}

Antworte NUR mit einem JSON-Objekt in diesem Format (keine anderen Texte!):
{
  "projektnummer": "P-2024-XXX oder null",
  "baustelle": "Name und Ort der Baustelle",
  "taetigkeiten": [
    {"position": "1", "menge": 25, "einheit": "m¬≤", "beschreibung": "Bodenfliesen 60x60 verlegt"}
  ],
  "material": "Liste der verwendeten Materialien",
  "maschinen": "Verwendete Maschinen/Werkzeuge oder leer",
  "personal": [
    {"name": "Mitarbeiter 1", "stunden": 8}
  ],
  "gesamtStunden": 24,
  "notizen": "Zus√§tzliche Infos, n√§chste Schritte etc."
}

Wichtig:
- Erkenne Mengenangaben (qm, m¬≤, St√ºck, lfm)
- Erkenne Zeitangaben (Stunden, h)
- Erkenne Personenanzahl und Namen
- Verwende Fachbegriffe korrekt
- Bei fehlenden Infos: null oder leeren String verwenden`;

            const groqKey = localStorage.getItem('groqApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');

            // Versuche Groq
            if (groqKey) {
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${groqKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'llama-3.1-70b-versatile',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: `Analysiere diesen Baustellenbericht:\n\n"${text}"` }
                            ],
                            max_tokens: 1000,
                            temperature: 0.2
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const content = data.choices[0]?.message?.content;
                        return parseAgentResponse(content);
                    }
                } catch (e) {
                    console.log('Groq Agent failed:', e);
                }
            }

            // Fallback Gemini
            if (geminiKey) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: systemPrompt + `\n\nAnalysiere diesen Baustellenbericht:\n\n"${text}"`
                                }]
                            }],
                            generationConfig: { maxOutputTokens: 1000, temperature: 0.2 }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        return parseAgentResponse(content);
                    }
                } catch (e) {
                    console.log('Gemini Agent failed:', e);
                }
            }

            // Fallback 3: Kostenlose KI (keine API-Key n√∂tig!)
            console.log('üÜì Versuche kostenlose KI...');
            try {
                const result = await callFreeAI(systemPrompt, `Analysiere diesen Baustellenbericht:\n\n"${text}"`);
                if (result) {
                    updateKIStatus('free', true);
                    return result;
                }
            } catch (e) {
                console.log('Free AI failed:', e);
            }

            // Fallback 4: Einfache Textanalyse ohne KI
            console.log('üìù Verwende einfache Textanalyse...');
            updateKIStatus('basic', true);
            return simpleTextParsing(text);
        }

        // Kostenlose KI API (keine API-Key n√∂tig)
        async function callFreeAI(systemPrompt, userPrompt) {
            // Versuche mehrere kostenlose Endpoints
            const freeEndpoints = [
                {
                    name: 'Pollinations',
                    url: 'https://text.pollinations.ai/',
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        model: 'openai',
                        jsonMode: true
                    }),
                    parseResponse: async (res) => {
                        const text = await res.text();
                        return parseAgentResponse(text);
                    }
                },
                {
                    name: 'Pollinations-GET',
                    url: `https://text.pollinations.ai/${encodeURIComponent(systemPrompt + '\n\n' + userPrompt)}?model=openai&json=true`,
                    method: 'GET',
                    parseResponse: async (res) => {
                        const text = await res.text();
                        return parseAgentResponse(text);
                    }
                }
            ];

            for (const endpoint of freeEndpoints) {
                try {
                    console.log(`üîÑ Versuche ${endpoint.name}...`);
                    const fetchOptions = {
                        method: endpoint.method,
                        headers: endpoint.headers
                    };
                    if (endpoint.body) fetchOptions.body = endpoint.body;

                    const response = await fetch(endpoint.url, fetchOptions);

                    if (response.ok) {
                        const result = await endpoint.parseResponse(response);
                        if (result) {
                            console.log(`‚úÖ ${endpoint.name} erfolgreich!`);
                            return result;
                        }
                    }
                } catch (e) {
                    console.log(`‚ùå ${endpoint.name} fehlgeschlagen:`, e.message);
                }
            }

            return null;
        }

        // Einfache Textanalyse als letzter Fallback (ohne KI)
        function simpleTextParsing(text) {
            const result = {
                projektnummer: null,
                baustelle: null,
                taetigkeiten: [],
                material: '',
                maschinen: '',
                personal: [],
                gesamtStunden: 0,
                notizen: text
            };

            // Baustelle/Kunde erkennen
            const baustelleMatch = text.match(/(?:bei|baustelle|kunde|projekt|objekt)[:\s]+([A-Za-z√§√∂√º√Ñ√ñ√ú√ü\s]+?)(?:,|\.|in|$)/i);
            if (baustelleMatch) result.baustelle = baustelleMatch[1].trim();

            // Quadratmeter erkennen
            const qmMatches = text.matchAll(/(\d+(?:[.,]\d+)?)\s*(?:qm|m¬≤|quadratmeter)/gi);
            for (const match of qmMatches) {
                result.taetigkeiten.push({
                    position: String(result.taetigkeiten.length + 1),
                    menge: parseFloat(match[1].replace(',', '.')),
                    einheit: 'm¬≤',
                    beschreibung: 'Fliesen verlegt'
                });
            }

            // Stunden erkennen
            const stundenMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:stunden?|h)\b/i);
            if (stundenMatch) result.gesamtStunden = parseFloat(stundenMatch[1].replace(',', '.'));

            // Personenanzahl erkennen
            const personMatch = text.match(/(\d+)\s*(?:mann|person|leute|arbeiter|mitarbeiter)/i);
            if (personMatch) {
                const anzahl = parseInt(personMatch[1]);
                for (let i = 0; i < anzahl; i++) {
                    result.personal.push({
                        name: `Mitarbeiter ${i + 1}`,
                        stunden: result.gesamtStunden / anzahl || 8
                    });
                }
            }

            // Projektnummer erkennen
            const projMatch = text.match(/(?:projekt|p)[\s-]*(\d{4}[\s-]?\d{3})/i);
            if (projMatch) result.projektnummer = 'P-' + projMatch[1].replace(/\s/g, '-');

            return result;
        }

        // ============================================
        // FOTO-ZU-RAPPORT (OCR + KI) FUNKTIONEN
        // ============================================

        // Globale Variable f√ºr aktuelles OCR-Bild
        let currentOcrImageData = null;

        // Foto verarbeiten (OCR + KI)
        async function processNotePhoto(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const imageData = e.target.result;
                currentOcrImageData = imageData;

                // UI anzeigen
                const processingArea = document.getElementById('ocrProcessingArea');
                const previewImg = document.getElementById('ocrPreviewImage');
                const resultText = document.getElementById('ocrResultText');

                if (processingArea) processingArea.style.display = 'block';
                if (previewImg) previewImg.src = imageData;
                if (resultText) resultText.value = '';

                // Mitarbeiter-Dropdown f√ºllen
                populateOcrMitarbeiterSelect();

                // OCR starten
                await performOCR(imageData);
            };

            reader.readAsDataURL(file);
            input.value = ''; // Reset f√ºr erneute Auswahl
        }

        // Mitarbeiter-Dropdown f√ºr OCR f√ºllen
        function populateOcrMitarbeiterSelect() {
            const select = document.getElementById('ocrMitarbeiterSelect');
            if (!select) return;

            const wb = getWissensbasis();
            const mitarbeiter = wb.mitarbeiter || [];

            select.innerHTML = '<option value="">-- Kein Mitarbeiter --</option>';
            mitarbeiter.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m;
                select.appendChild(option);
            });
        }

        // OCR Status aktualisieren
        function updateOcrStatus(icon, text, progress = null) {
            const iconEl = document.getElementById('ocrStatusIcon');
            const textEl = document.getElementById('ocrStatusText');
            const progressBar = document.getElementById('ocrProgressBar');
            const progressFill = document.getElementById('ocrProgressFill');

            if (iconEl) iconEl.textContent = icon;
            if (textEl) textEl.textContent = text;

            if (progress !== null && progressBar && progressFill) {
                progressBar.style.display = 'block';
                progressFill.style.width = `${progress}%`;
            } else if (progressBar) {
                progressBar.style.display = 'none';
            }
        }

        // OCR mit Tesseract durchf√ºhren
        async function performOCR(imageData) {
            updateOcrStatus('‚è≥', 'Lade Texterkennung...', 10);

            try {
                // Pr√ºfen ob Tesseract geladen ist
                if (typeof Tesseract === 'undefined') {
                    throw new Error('Tesseract.js nicht geladen. Bitte Seite neu laden.');
                }

                // Pr√ºfen ob recognize Funktion existiert
                if (typeof Tesseract.recognize !== 'function') {
                    throw new Error('Tesseract API nicht verf√ºgbar');
                }

                updateOcrStatus('üîç', 'Erkenne Text im Bild...', 30);

                // OCR durchf√ºhren (Tesseract.js v5 API)
                const result = await Tesseract.recognize(
                    imageData,
                    'deu', // Deutsch
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = 30 + Math.round(m.progress * 50);
                                updateOcrStatus('üîç', `Erkenne Text... ${Math.round(m.progress * 100)}%`, progress);
                            }
                        }
                    }
                );

                const rawText = result.data.text.trim();
                console.log('üìù OCR Rohtext:', rawText);

                if (!rawText) {
                    updateOcrStatus('‚ö†Ô∏è', 'Kein Text erkannt. Bitte besseres Foto machen.', null);
                    const ocrResult = document.getElementById('ocrResultText');
                    if (ocrResult) ocrResult.value = '(Kein Text erkannt)';
                    return;
                }

                updateOcrStatus('ü§ñ', 'KI verbessert Text...', 85);

                // Text mit KI verbessern
                const improvedText = await improveTextWithAI(rawText);

                const ocrResultEl = document.getElementById('ocrResultText');
                if (ocrResultEl) ocrResultEl.value = improvedText;
                updateOcrStatus('‚úÖ', 'Text erkannt und verbessert!', 100);

                setTimeout(() => {
                    updateOcrStatus('‚úÖ', 'Bereit zum Einf√ºgen', null);
                }, 1500);

            } catch (error) {
                console.error('OCR Fehler:', error);
                updateOcrStatus('‚ùå', 'Fehler: ' + error.message, null);

                // Fallback: Bild kann nicht gelesen werden
                const ocrFallback = document.getElementById('ocrResultText');
                if (ocrFallback) ocrFallback.value = '(Texterkennung fehlgeschlagen - bitte manuell eingeben)';
            }
        }

        // Text mit KI verbessern (kostenlos √ºber Pollinations)
        async function improveTextWithAI(rawText) {
            const systemPrompt = `Du bist ein Assistent f√ºr Baustellenberichte einer Fliesenfirma.
Deine Aufgabe: Verbessere den folgenden Text von einem handgeschriebenen Notizzettel.

Regeln:
- Korrigiere Rechtschreibfehler
- Formatiere als klare Stichpunkte
- Behalte alle wichtigen Infos: Mengen, Materialien, T√§tigkeiten, Namen
- Verwende professionelle Baustellensprache
- Wenn Mengen fehlen, lasse Platzhalter [...]
- Antworte NUR mit dem verbesserten Text, keine Erkl√§rungen`;

            const userPrompt = `Bitte verbessere diesen handgeschriebenen Text:

${rawText}`;

            try {
                // Versuche kostenlose KI
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        model: 'openai'
                    })
                });

                if (response.ok) {
                    const improvedText = await response.text();
                    if (improvedText && improvedText.length > 10) {
                        console.log('‚úÖ KI-Verbesserung erfolgreich');
                        return improvedText.trim();
                    }
                }
            } catch (e) {
                console.log('KI-Verbesserung fehlgeschlagen:', e);
            }

            // Fallback: Einfache Bereinigung ohne KI
            return cleanupTextBasic(rawText);
        }

        // Einfache Textbereinigung (ohne KI)
        function cleanupTextBasic(text) {
            return text
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => '‚Ä¢ ' + line)
                .join('\n');
        }

        // Nochmal mit KI verbessern
        async function reprocessOcrWithAI() {
            const textArea = document.getElementById('ocrResultText');
            if (!textArea || !textArea.value) {
                showToast('Kein Text zum Verbessern vorhanden', 'warning');
                return;
            }

            updateOcrStatus('ü§ñ', 'KI verbessert Text erneut...', 50);

            const improvedText = await improveTextWithAI(textArea.value);
            textArea.value = improvedText;

            updateOcrStatus('‚úÖ', 'Text nochmal verbessert!', 100);
            setTimeout(() => {
                updateOcrStatus('‚úÖ', 'Bereit zum Einf√ºgen', null);
            }, 1500);
        }

        // OCR-Text in Rapport einf√ºgen
        function insertOcrToRapport() {
            const textArea = document.getElementById('ocrResultText');
            const targetRadio = document.querySelector('input[name="ocrTarget"]:checked');
            const mitarbeiterSelect = document.getElementById('ocrMitarbeiterSelect');

            if (!textArea || !textArea.value.trim()) {
                showToast('Kein Text zum Einf√ºgen vorhanden', 'warning');
                return;
            }

            const text = textArea.value.trim();
            const target = targetRadio ? targetRadio.value : 'taetigkeit';
            const mitarbeiter = mitarbeiterSelect ? mitarbeiterSelect.value : '';

            // Mitarbeiter-Prefix hinzuf√ºgen wenn gew√§hlt
            let finalText = text;
            if (mitarbeiter) {
                finalText = `[${mitarbeiter}] ${text}`;
            }

            // In das richtige Feld einf√ºgen
            switch (target) {
                case 'taetigkeit':
                    // Als neue T√§tigkeit hinzuf√ºgen
                    addTaetigkeitFromOcr(finalText);
                    break;
                case 'material':
                    appendToTextarea('materialText', finalText);
                    break;
                case 'maschinen':
                    appendToTextarea('maschinenText', finalText);
                    break;
            }

            // Erfolgsmeldung
            showToast('‚úÖ Text wurde in Rapport eingef√ºgt!', 'success');

            // OCR-Bereich zur√ºcksetzen
            cancelOcrProcess();
        }

        // Text an Textarea anh√§ngen
        function appendToTextarea(textareaId, text) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            if (textarea.value.trim()) {
                textarea.value += '\n\n' + text;
            } else {
                textarea.value = text;
            }
        }

        // T√§tigkeit aus OCR-Text hinzuf√ºgen
        function addTaetigkeitFromOcr(text) {
            const tbody = document.getElementById('taetigkeitenTable');
            if (!tbody) {
                console.error('taetigkeitenTable nicht gefunden');
                return;
            }

            const datum = document.getElementById('datum')?.value || new Date().toISOString().split('T')[0];

            // Teile den Text in Zeilen auf
            const lines = text.split('\n').filter(l => l.trim());

            if (lines.length === 0) return;

            // Jede Zeile als separate T√§tigkeit
            lines.forEach(line => {
                // Entferne Bulletpoints
                let cleanLine = line.replace(/^[‚Ä¢\-\*]\s*/, '').trim();
                if (!cleanLine) return;

                // Versuche Menge und Einheit zu erkennen
                let menge = '';
                let einheit = 'm¬≤';

                // Regex mit Wortgrenze (\b) um falsche Treffer zu vermeiden
                const mengeMatch = cleanLine.match(/(\d+(?:[.,]\d+)?)\s*(m¬≤|qm|stk|st√ºck|lfm|kg|l|m)\b/i);
                if (mengeMatch) {
                    menge = mengeMatch[1].replace(',', '.');
                    // Einheit normalisieren (toLowerCase + Konvertierung)
                    einheit = mengeMatch[2].toLowerCase();
                    if (einheit === 'qm') einheit = 'm¬≤';
                    if (einheit === 'st√ºck') einheit = 'Stk';
                    if (einheit === 'stk') einheit = 'Stk';
                    if (einheit === 'lfm') einheit = 'lfm';
                    if (einheit === 'kg') einheit = 'kg';
                    if (einheit === 'l') einheit = 'l';
                    if (einheit === 'm') einheit = 'm';
                    // Entferne die Menge aus der Beschreibung
                    cleanLine = cleanLine.replace(mengeMatch[0], '').trim();
                }

                // Position automatisch ermitteln
                const position = (typeof taetigkeitenRowCounter !== 'undefined')
                    ? taetigkeitenRowCounter.toString()
                    : (tbody.rows.length + 1).toString();

                // Neue Zeile mit contenteditable TDs erstellen (wie im Original-Code)
                const row = document.createElement('tr');
                row.className = 'editable-row';
                row.innerHTML = `
                    <td contenteditable="true">${position}</td>
                    <td>${datum}</td>
                    <td contenteditable="true">${cleanLine}</td>
                    <td contenteditable="true">${menge}</td>
                    <td contenteditable="true">${einheit}</td>
                `;
                tbody.appendChild(row);

                // Counter erh√∂hen wenn vorhanden
                if (typeof taetigkeitenRowCounter !== 'undefined') {
                    taetigkeitenRowCounter++;
                }
            });
        }

        // OCR-Prozess abbrechen
        function cancelOcrProcess() {
            const processingArea = document.getElementById('ocrProcessingArea');
            const previewImg = document.getElementById('ocrPreviewImage');
            const resultText = document.getElementById('ocrResultText');

            if (processingArea) processingArea.style.display = 'none';
            if (previewImg) previewImg.src = '';
            if (resultText) resultText.value = '';

            currentOcrImageData = null;
            updateOcrStatus('‚è≥', 'Bereit', null);
        }

        // ============================================
        // ENDE FOTO-ZU-RAPPORT FUNKTIONEN
        // ============================================

        // KI-Status UI aktualisieren
        function updateKIStatus(type, available) {
            const icon = document.getElementById('kiStatusIcon');
            const text = document.getElementById('kiStatusText');

            if (!icon || !text) return;

            const statuses = {
                'groq': { icon: 'üöÄ', text: 'Groq KI (schnell & intelligent)', color: '#10b981' },
                'gemini': { icon: '‚ú®', text: 'Google Gemini KI', color: '#667eea' },
                'free': { icon: 'üÜì', text: 'Kostenlose KI (ohne API-Key)', color: '#f59e0b' },
                'basic': { icon: 'üìù', text: 'Einfache Textanalyse (offline)', color: '#6b7280' },
                'none': { icon: '‚ùå', text: 'Keine KI verf√ºgbar', color: '#ef4444' }
            };

            const status = statuses[type] || statuses['none'];
            icon.textContent = status.icon;
            text.textContent = status.text;
            text.style.color = status.color;
        }

        // KI-Status beim Laden pr√ºfen
        function checkKIStatus() {
            const groqKey = localStorage.getItem('groqApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');

            if (groqKey) {
                updateKIStatus('groq', true);
            } else if (geminiKey) {
                updateKIStatus('gemini', true);
            } else {
                updateKIStatus('free', true);
            }
        }

        // Agent-Antwort parsen
        function parseAgentResponse(content) {
            if (!content) return null;

            // JSON aus der Antwort extrahieren
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                console.error('Kein JSON in Antwort:', content);
                return null;
            }

            try {
                return JSON.parse(jsonMatch[0]);
            } catch (e) {
                console.error('JSON Parse Error:', e, content);
                return null;
            }
        }

        // Formular mit Agent-Daten f√ºllen
        function fillFormFromAgent(data) {
            console.log('ü§ñ Agent f√ºllt Formular:', data);

            // Projektnummer
            if (data.projektnummer) {
                const projEl = document.getElementById('projektnummerHelper');
                if (projEl) projEl.value = data.projektnummer;
                const projEl2 = document.getElementById('projektnummer');
                if (projEl2) projEl2.value = data.projektnummer;
            }

            // Baustelle
            if (data.baustelle) {
                const bauEl = document.getElementById('baustelleHelper');
                if (bauEl) bauEl.value = data.baustelle;
                const bauEl2 = document.getElementById('baustelle');
                if (bauEl2) bauEl2.value = data.baustelle;
            }

            // T√§tigkeiten
            if (data.taetigkeiten && Array.isArray(data.taetigkeiten)) {
                const tbody = document.getElementById('taetigkeitenTable');
                if (tbody) {
                    // Bestehende Zeilen l√∂schen
                    tbody.innerHTML = '';

                    data.taetigkeiten.forEach((t, i) => {
                        const row = tbody.insertRow();
                        const today = new Date().toLocaleDateString('de-DE');
                        row.innerHTML = `
                            <td>${t.position || (i + 1)}</td>
                            <td>${today}</td>
                            <td><textarea style="width:100%;min-height:60px;border:1px solid #ddd;border-radius:4px;padding:8px;">${t.beschreibung || ''}</textarea></td>
                            <td contenteditable="true">${t.menge ? t.menge + ' ' + (t.einheit || '') : ''}</td>
                            <td contenteditable="true"></td>
                        `;
                    });
                }
            }

            // Material
            if (data.material) {
                const matEl = document.getElementById('materialText');
                if (matEl) matEl.value = data.material;
            }

            // Maschinen
            if (data.maschinen) {
                const maschEl = document.getElementById('maschinenText');
                if (maschEl) maschEl.value = data.maschinen;
            }

            // Personal
            if (data.personal && Array.isArray(data.personal)) {
                // Personal-Liste aktualisieren
                personalListe = data.personal.map(p => ({
                    name: p.name || 'Mitarbeiter',
                    anzahl: 1,
                    stunden: p.stunden || 8
                }));
                updatePersonalListe();
            }

            // Notizen in ein Textfeld oder als Toast
            if (data.notizen) {
                showToast('üìù Notiz: ' + data.notizen, 'info');
            }

            // Scroll zum Formular
            document.getElementById('tab-neu')?.scrollIntoView({ behavior: 'smooth' });
        }

        // In Wissensbasis speichern (Lernen)
        function saveToWissensbasis(originalText, parsedData) {
            const wb = getWissensbasis();

            // Neue Mitarbeiter lernen
            if (parsedData.personal) {
                parsedData.personal.forEach(p => {
                    if (p.name && !wb.mitarbeiter.includes(p.name)) {
                        wb.mitarbeiter.push(p.name);
                    }
                });
            }

            // Neue Kunden/Baustellen lernen
            if (parsedData.baustelle && !wb.kunden.includes(parsedData.baustelle)) {
                wb.kunden.push(parsedData.baustelle);
            }

            // Beispiel speichern (max. 20)
            wb.gelernteBeispiele.push({
                input: originalText.substring(0, 200),
                output: parsedData,
                timestamp: new Date().toISOString()
            });
            if (wb.gelernteBeispiele.length > 20) {
                wb.gelernteBeispiele.shift();
            }

            // Speichern
            localStorage.setItem('firmenMitarbeiter', JSON.stringify(wb.mitarbeiter));
            localStorage.setItem('firmenKunden', JSON.stringify(wb.kunden));
            localStorage.setItem('gelernteBeispiele', JSON.stringify(wb.gelernteBeispiele));

            updateWissensbasisCounts();
            console.log('üìö Wissensbasis aktualisiert:', wb);
        }

        // Wissensbasis-Editor √∂ffnen
        function toggleWissensbasis() {
            const wb = getWissensbasis();

            const modal = document.createElement('div');
            modal.id = 'wissensbasisModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10004;display:flex;align-items:center;justify-content:center;padding:15px;';

            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
                    <div style="padding:16px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:16px 16px 0 0;">
                        <h3 style="margin:0;color:white;">üìö Firmen-Wissensbasis</h3>
                        <p style="margin:5px 0 0;color:rgba(255,255,255,0.8);font-size:12px;">Der Agent lernt aus diesen Daten</p>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold;display:block;margin-bottom:8px;">üë∑ Mitarbeiter (einer pro Zeile)</label>
                            <textarea id="wbMitarbeiterEdit" rows="4" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;">${wb.mitarbeiter.join('\n')}</textarea>
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold;display:block;margin-bottom:8px;">üè¢ Kunden/Baustellen (eine pro Zeile)</label>
                            <textarea id="wbKundenEdit" rows="4" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;">${wb.kunden.join('\n')}</textarea>
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold;display:block;margin-bottom:8px;">üß± H√§ufige Materialien (eines pro Zeile)</label>
                            <textarea id="wbMaterialienEdit" rows="3" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;">${wb.materialien.join('\n')}</textarea>
                        </div>
                        <div style="background:#f1f5f9;padding:12px;border-radius:8px;font-size:12px;color:#64748b;">
                            üìä ${wb.gelernteBeispiele.length} Berichte gelernt
                            <button onclick="if(confirm('Alle gelernten Beispiele l√∂schen?')){localStorage.removeItem('gelernteBeispiele');showToast('Gel√∂scht','success');}" style="margin-left:10px;font-size:11px;color:#ef4444;background:none;border:none;cursor:pointer;">üóëÔ∏è Zur√ºcksetzen</button>
                        </div>
                    </div>
                    <div style="padding:12px 20px 20px;display:flex;gap:10px;">
                        <button onclick="document.getElementById('wissensbasisModal').remove()" style="flex:1;padding:12px;background:#e5e7eb;color:#475569;border:none;border-radius:8px;cursor:pointer;">Abbrechen</button>
                        <button onclick="saveWissensbasisEdit()" style="flex:1;padding:12px;background:#22c55e;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">üíæ Speichern</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Wissensbasis speichern
        function saveWissensbasisEdit() {
            const mitarbeiter = document.getElementById('wbMitarbeiterEdit').value.split('\n').map(s => s.trim()).filter(s => s);
            const kunden = document.getElementById('wbKundenEdit').value.split('\n').map(s => s.trim()).filter(s => s);
            const materialien = document.getElementById('wbMaterialienEdit').value.split('\n').map(s => s.trim()).filter(s => s);

            localStorage.setItem('firmenMitarbeiter', JSON.stringify(mitarbeiter));
            localStorage.setItem('firmenKunden', JSON.stringify(kunden));
            localStorage.setItem('firmenMaterialien', JSON.stringify(materialien));

            updateWissensbasisCounts();
            document.getElementById('wissensbasisModal')?.remove();
            showToast('‚úÖ Wissensbasis gespeichert', 'success');
        }

        // Beim Laden: Wissensbasis-Counts aktualisieren
        document.addEventListener('DOMContentLoaded', function() {
            updateWissensbasisCounts();
        });

        // ===== WETTER FUNKTIONEN (aus Script 2 hierher verschoben) =====
        function updateWetterUI(ort, temp, desc, icon = 'üå§Ô∏è') {
            const wetterIcon = document.getElementById('wetterIcon');
            const wetterTemp = document.getElementById('wetterTemp');
            const wetterDesc = document.getElementById('wetterDesc');
            const wetterOrt = document.getElementById('wetterOrt');
            if (wetterIcon) wetterIcon.textContent = icon;
            if (wetterTemp) wetterTemp.textContent = temp + '¬∞C';
            if (wetterDesc) wetterDesc.textContent = desc;
            if (wetterOrt) wetterOrt.textContent = 'üìç ' + ort;
        }

        function getWetterIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return 'üå§Ô∏è';
            if (code <= 48) return '‚òÅÔ∏è';
            if (code <= 57) return 'üåßÔ∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return '‚ùÑÔ∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code >= 95) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        function getWetterBeschreibung(code) {
            if (code === 0) return 'Klar';
            if (code <= 3) return 'Teilweise bew√∂lkt';
            if (code <= 48) return 'Bew√∂lkt/Nebel';
            if (code <= 57) return 'Nieselregen';
            if (code <= 67) return 'Regen';
            if (code <= 77) return 'Schnee';
            if (code <= 82) return 'Starkregen';
            if (code >= 95) return 'Gewitter';
            return 'Wechselhaft';
        }

        // Globale Variable f√ºr Stadt (wird von autoLoadLocation gesetzt)
        let aktuelleStadt = null;

        async function loadWetter(stadtParam) {
            try {
                let lat = document.getElementById('gpsLat')?.value;
                let lon = document.getElementById('gpsLon')?.value;
                let city = stadtParam || aktuelleStadt || null;

                // Wenn kein GPS, versuche IP-basiert
                if (!lat || !lon) {
                    const ipLoc = await getIPLocation();
                    if (ipLoc) {
                        lat = ipLoc.lat;
                        lon = ipLoc.lon;
                        city = ipLoc.city;
                        aktuelleStadt = city;
                    } else {
                        updateWetterUI('Unbekannt', '--', 'Standort nicht verf√ºgbar');
                        return;
                    }
                }

                // Wetter von Open-Meteo laden
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code`);
                const data = await res.json();

                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const code = data.current.weather_code;
                    const desc = getWetterBeschreibung(code);
                    const icon = getWetterIcon(code);
                    let ort = city || 'Dein Standort';

                    updateWetterUI(ort, temp, desc, icon);

                    if (code >= 61) {
                        const widget = document.getElementById('wetterWidget');
                        if (widget) widget.classList.add('wetter-warning');
                    }
                } else {
                    updateWetterUI('Unbekannt', '--', 'Keine Wetterdaten');
                }
            } catch (e) {
                console.log('Wetter-Fehler:', e);
                updateWetterUI('Unbekannt', '--', 'Fehler beim Laden');
            }
        }

        // ===== AUTO-LOCATION BEIM SEITENAUFRUF =====
        async function autoLoadLocation() {
            const statusEl = document.getElementById('gpsStatus');
            if (statusEl) {
                statusEl.textContent = 'üìç Standort wird ermittelt...';
                statusEl.className = 'gps-status gps-loading';
            }

            try {
                // IP-basiert versuchen (schnell, keine Permission n√∂tig)
                const ipLoc = await getIPLocation();
                if (ipLoc && ipLoc.lat && ipLoc.lon) {
                    document.getElementById('gpsLat').value = ipLoc.lat;
                    document.getElementById('gpsLon').value = ipLoc.lon;
                    if (statusEl) {
                        statusEl.textContent = `üìç ${ipLoc.city || 'Standort'} (IP-basiert, ¬±20km)`;
                        statusEl.className = 'gps-status gps-success';
                    }
                    // Stadt speichern und in Adressfeld eintragen
                    aktuelleStadt = ipLoc.city;
                    const ortInput = document.getElementById('ortHelper');
                    if (ortInput && ipLoc.city) {
                        ortInput.value = ipLoc.city;
                    }
                    updateGPSSourceBadge('ip', 20000);
                    loadWetter(ipLoc.city);
                    return;
                }
            } catch (e) {
                console.log('Auto-Location fehlgeschlagen:', e);
            }

            if (statusEl) {
                statusEl.textContent = 'üìç Klicke auf "üîÑ GPS neu erfassen" f√ºr genauen Standort';
                statusEl.className = 'gps-status';
            }
            loadWetter();
        }

        // ===== v1.15: IP-GEOLOCATION FALLBACK (mit mehreren APIs) =====
        async function getIPLocation() {
            console.log('üîÑ IP-Geolocation wird versucht...');

            // Nur HTTPS-f√§hige APIs (ip-api.com funktioniert nur mit HTTP)
            const apis = [
                {
                    url: 'https://ipapi.co/json/',
                    parse: d => ({ lat: d.latitude, lon: d.longitude, city: d.city, country: d.country_name })
                },
                {
                    url: 'https://ipwho.is/',
                    parse: d => ({ lat: d.latitude, lon: d.longitude, city: d.city, country: d.country })
                },
                {
                    url: 'https://freeipapi.com/api/json',
                    parse: d => ({ lat: d.latitude, lon: d.longitude, city: d.cityName, country: d.countryName })
                },
                {
                    url: 'https://api.ipdata.co/?api-key=test',
                    parse: d => ({ lat: d.latitude, lon: d.longitude, city: d.city, country: d.country_name })
                }
            ];

            for (const api of apis) {
                try {
                    const response = await fetch(api.url);
                    if (!response.ok) continue;
                    const data = await response.json();
                    const parsed = api.parse(data);

                    if (parsed.lat && parsed.lon) {
                        console.log('‚úÖ IP-Geolocation von:', api.url, parsed);
                        return {
                            source: 'ip',
                            lat: parsed.lat,
                            lon: parsed.lon,
                            accuracy: 20000,
                            city: parsed.city,
                            country: parsed.country
                        };
                    }
                } catch (e) {
                    console.log('‚ùå API fehlgeschlagen:', api.url);
                }
            }

            console.error('‚ùå Alle IP-Geolocation APIs fehlgeschlagen');
            return null;
        }
        
        // ===== v1.15: GPS SOURCE INDICATOR =====
        function updateGPSSourceBadge(source, accuracy) {
            const statusEl = document.getElementById('gpsStatus');
            let badgeHTML = '';
            
            if (source === 'gps') {
                badgeHTML = `<span class="gps-source-badge source-gps"><span class="badge-icon">üìç</span> GPS High-Accuracy (¬±${Math.round(accuracy)}m)</span>`;
            } else if (source === 'ip') {
                badgeHTML = `<span class="gps-source-badge source-ip"><span class="badge-icon">üìç</span> IP-Standort (~20km Genauigkeit)</span>`;
            }
            
            // Append badge to status
            if (badgeHTML) {
                const currentHTML = statusEl.innerHTML.split('<span class="gps-source-badge')[0]; // Remove old badge
                statusEl.innerHTML = currentHTML + badgeHTML;
            }
        }
        
        // ===== GPS HIGH-ACCURACY (¬±5m) MIT MULTI-MESSUNG + v1.15 IP-FALLBACK =====
        async function getGPS() {
            const statusEl = document.getElementById('gpsStatus');
            statusEl.className = 'gps-status gps-loading';
            statusEl.innerHTML = 'üîÑ GPS wird erfasst (High-Accuracy)...';
            
            // Feature Detection
            if (!browserCaps.features.geolocation) {
                statusEl.className = 'gps-status gps-error';
                statusEl.innerHTML = '‚ùå GPS nicht verf√ºgbar in diesem Browser';
                showToast('Bitte GPS-Koordinaten manuell eingeben', 'info');
                return;
            }
            
            const measurements = [];
            const targetAccuracy = 20; // Target ¬±20m or better
            const maxMeasurements = 3;
            const timeout = 20000; // 20 seconds per measurement
            
            // Funktion f√ºr einzelne GPS-Messung
            const getSinglePosition = () => {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: timeout,
                            maximumAge: 0
                        }
                    );
                });
            };
            
            try {
                // Sammle 3 Messungen
                for (let i = 0; i < maxMeasurements; i++) {
                    statusEl.innerHTML = `üîÑ GPS-Messung ${i + 1}/${maxMeasurements}...`;
                    
                    const position = await getSinglePosition();
                    const accuracy = position.coords.accuracy;
                    
                    measurements.push({
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: accuracy
                    });
                    
                    statusEl.innerHTML = `üîÑ Messung ${i + 1}: ¬±${Math.round(accuracy)}m Genauigkeit`;
                    
                    // Stop early if we have excellent accuracy
                    if (accuracy <= targetAccuracy && i >= 1) {
                        break;
                    }
                    
                    // Short delay between measurements
                    if (i < maxMeasurements - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Calculate weighted average (better accuracy = higher weight)
                let totalWeight = 0;
                let weightedLat = 0;
                let weightedLon = 0;
                
                measurements.forEach(m => {
                    // Weight is inverse of accuracy (better accuracy = more weight)
                    const weight = 1 / m.accuracy;
                    totalWeight += weight;
                    weightedLat += m.lat * weight;
                    weightedLon += m.lon * weight;
                });
                
                const finalLat = (weightedLat / totalWeight).toFixed(6);
                const finalLon = (weightedLon / totalWeight).toFixed(6);
                const avgAccuracy = Math.round(
                    measurements.reduce((sum, m) => sum + m.accuracy, 0) / measurements.length
                );
                
                // Set values
                document.getElementById('gpsLat').value = finalLat;
                document.getElementById('gpsLon').value = finalLon;
                
                // Show success with accuracy
                statusEl.className = 'gps-status gps-success';
                statusEl.innerHTML = `‚úÖ GPS erfasst: ${finalLat}, ${finalLon} (¬±${avgAccuracy}m, ${measurements.length} Messungen)`;
                
                showToast(`GPS erfolgreich erfasst mit ¬±${avgAccuracy}m Genauigkeit`, 'success');

                // v1.15: Update GPS Source Badge
                updateGPSSourceBadge('gps', avgAccuracy);

                // Update map marker
                updateMapMarker();

                // Reverse Geocoding - Adresse aus Koordinaten ermitteln
                reverseGeocode(finalLat, finalLon);

            } catch (error) {
                // v1.15: Progressive GPS with IP-Fallback
                console.log('‚ùå GPS High-Accuracy fehlgeschlagen, versuche IP-Fallback...');
                console.error('GPS Error:', {
                    code: error.code,
                    message: error.message
                });
                
                statusEl.className = 'gps-status gps-loading';
                statusEl.innerHTML = 'üîÑ GPS nicht verf√ºgbar, verwende IP-Standort...';
                
                // Try IP-Geolocation Fallback
                const ipLocation = await getIPLocation();
                
                if (ipLocation) {
                    // Success: Use IP location
                    const finalLat = ipLocation.lat.toFixed(6);
                    const finalLon = ipLocation.lon.toFixed(6);
                    
                    document.getElementById('gpsLat').value = finalLat;
                    document.getElementById('gpsLon').value = finalLon;
                    
                    statusEl.className = 'gps-status gps-success';
                    statusEl.innerHTML = `‚úÖ Standort erfasst: ${finalLat}, ${finalLon} (via IP-Standort)`;
                    
                    if (ipLocation.city) {
                        statusEl.innerHTML += `<br><small>üìç ${ipLocation.city}, ${ipLocation.country}</small>`;
                    }
                    
                    showToast(`IP-Standort erfasst: ${ipLocation.city || 'Unbekannt'} (~20km Genauigkeit)`, 'success');
                    
                    // v1.15: Update GPS Source Badge
                    updateGPSSourceBadge('ip', ipLocation.accuracy);
                    
                    // Update map
                    updateMapMarker();
                    
                    // Reverse Geocoding
                    reverseGeocode(finalLat, finalLon);
                } else {
                    // Fallback also failed
                    statusEl.className = 'gps-status gps-error';
                    
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'GPS-Zugriff verweigert';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'GPS-Position nicht verf√ºgbar';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'GPS-Anfrage Timeout';
                            break;
                        default:
                            errorMsg = 'GPS-Fehler';
                    }
                    
                    statusEl.innerHTML = `‚ùå ${errorMsg} & IP-Fallback fehlgeschlagen`;
                    showToast(errorMsg + ' - Bitte Koordinaten manuell eingeben', 'error');
                }
            }
        }

        // ===== FEHLENDE FUNKTIONEN (hinzugef√ºgt) =====
        // updateMapMarker - Aktualisiert Karten-Marker (falls Map offen)
        function updateMapMarker() {
            // Diese Funktion wird aufgerufen wenn GPS aktualisiert wird
            // Map ist nur im Map-Picker Modal aktiv, daher hier nichts tun
            console.log('üìç GPS aktualisiert');
        }

        // reverseGeocode - Wandelt Koordinaten in Adresse um
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const data = await response.json();

                if (data && data.address) {
                    const adresse = data.address;
                    const strasse = adresse.road || adresse.pedestrian || '';
                    const hausnr = adresse.house_number || '';
                    const plz = adresse.postcode || '';
                    const ort = adresse.city || adresse.town || adresse.village || adresse.municipality || '';

                    // Adresse in Formular eintragen
                    const strasseInput = document.getElementById('strasseHelper');
                    if (strasseInput && strasse) {
                        strasseInput.value = strasse + (hausnr ? ' ' + hausnr : '');
                    }

                    const plzInput = document.getElementById('plzHelper');
                    if (plzInput && plz) {
                        plzInput.value = plz;
                    }

                    const ortInput = document.getElementById('ortHelper');
                    if (ortInput && ort) {
                        ortInput.value = ort;
                    }

                    // Stadt global speichern und Wetter-Anzeige aktualisieren
                    if (ort) {
                        aktuelleStadt = ort;
                        const wetterOrt = document.getElementById('wetterOrt');
                        if (wetterOrt) {
                            wetterOrt.textContent = 'üìç ' + ort;
                        }
                    }

                    console.log('üìç Reverse Geocoding:', ort, strasse);
                }
            } catch (e) {
                console.log('Reverse Geocoding fehlgeschlagen:', e);
            }
        }

        // ===== PROJEKT INFO √úBERNEHMEN =====
        function copyProjektInfo() {
            const projektnummerHelper = document.getElementById('projektnummerHelper').value;
            const baustelleHelper = document.getElementById('baustelleHelper').value;
            
            document.getElementById('projektnummer').value = projektnummerHelper;
            document.getElementById('baustelle').value = baustelleHelper;
            
            showToast('Projekt-Informationen √ºbernommen', 'success');
        }
        
        // ===== v1.15: QR-CODE SCANNER =====
        let qrStream = null;
        let qrScanInterval = null;
        
        async function startQRScanner() {
            const overlay = document.getElementById('qrScannerOverlay');
            const video = document.getElementById('qrVideo');
            const canvas = document.getElementById('qrCanvas');
            const status = document.getElementById('scannerStatus');
            
            overlay.style.display = 'flex';
            status.textContent = 'üì∑ Kamera wird ge√∂ffnet...';
            
            try {
                // Request camera access
                qrStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' } // Rear camera
                });
                
                video.srcObject = qrStream;
                await video.play();
                
                status.textContent = 'üì∑ Suche nach QR-Code...';
                
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Start scanning
                qrScanInterval = setInterval(() => {
                    scanQRCode(video, canvas, status);
                }, 300);
                
            } catch (error) {
                console.error('‚ùå QR-Scanner Error:', error);
                status.textContent = '‚ùå Kamera-Zugriff verweigert';
                showToast('Kamera-Zugriff ben√∂tigt f√ºr QR-Scanner', 'error');
                setTimeout(() => stopQRScanner(), 2000);
            }
        }
        
        function scanQRCode(video, canvas, status) {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Try BarcodeDetector API first
            if ('BarcodeDetector' in window) {
                const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                barcodeDetector.detect(imageData)
                    .then(barcodes => {
                        if (barcodes.length > 0) {
                            processQRCode(barcodes[0].rawValue, status);
                        }
                    })
                    .catch(err => console.error('BarcodeDetector error:', err));
            } else if (typeof jsQR !== 'undefined') {
                // Fallback to jsQR
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    processQRCode(code.data, status);
                }
            }
        }
        
        function processQRCode(data, status) {
            console.log('‚úÖ QR-Code detected:', data);
            
            // Expected format: "lat,lon" or "lat, lon"
            const coords = data.trim().split(',').map(s => s.trim());
            
            if (coords.length === 2) {
                const lat = parseFloat(coords[0]);
                const lon = parseFloat(coords[1]);
                
                if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                    // Valid coordinates
                    document.getElementById('gpsLat').value = lat.toFixed(6);
                    document.getElementById('gpsLon').value = lon.toFixed(6);
                    
                    const gpsStatus = document.getElementById('gpsStatus');
                    gpsStatus.className = 'gps-status gps-success';
                    gpsStatus.innerHTML = `‚úÖ QR-Code gescannt: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    
                    updateGPSSourceBadge('gps', 0); // QR is exact, 0m accuracy
                    updateMapMarker();
                    reverseGeocode(lat, lon);
                    
                    status.textContent = '‚úÖ QR-Code erfolgreich gescannt!';
                    showToast('QR-Code erfolgreich gescannt!', 'success');
                    
                    setTimeout(() => stopQRScanner(), 1000);
                } else {
                    status.textContent = '‚ùå Ung√ºltige Koordinaten im QR-Code';
                    showToast('QR-Code enth√§lt ung√ºltige Koordinaten', 'error');
                }
            } else {
                status.textContent = '‚ö†Ô∏è QR-Code Format nicht erkannt';
                showToast('QR-Code Format: "lat,lon" erwartet', 'info');
            }
        }
        
        function stopQRScanner() {
            const overlay = document.getElementById('qrScannerOverlay');
            overlay.style.display = 'none';
            
            if (qrScanInterval) {
                clearInterval(qrScanInterval);
                qrScanInterval = null;
            }
            
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
        }
        
        // ===== v1.15: MEDIARECORDER AUDIO AUFNAHME =====
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;
        
        async function toggleAudioRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                stopAudioRecording();
            } else {
                // Start recording
                await startAudioRecording();
            }
        }
        
        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create MediaRecorder
                const options = { mimeType: 'audio/webm;codecs=opus' };
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                    downloadAudio(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Reset
                    audioChunks = [];
                    mediaRecorder = null;
                    
                    // Remove indicator
                    document.getElementById('audioRecordingIndicator').innerHTML = '';
                    
                    if (recordingTimer) {
                        clearInterval(recordingTimer);
                        recordingTimer = null;
                    }
                };
                
                // Start recording
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Show indicator
                updateRecordingIndicator();
                recordingTimer = setInterval(updateRecordingIndicator, 1000);
                
                showToast('üéôÔ∏è Audio-Aufnahme gestartet', 'success');
                
            } catch (error) {
                console.error('‚ùå MediaRecorder Error:', error);
                showToast('Mikrofon-Zugriff verweigert', 'error');
            }
        }
        
        function stopAudioRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                showToast('‚úÖ Audio-Aufnahme gestoppt', 'success');
            }
        }
        
        function updateRecordingIndicator() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('audioRecordingIndicator').innerHTML = `
                <span class="audio-recording-indicator">
                    <span class="recording-dot"></span>
                    <span class="recording-time">${timeStr}</span>
                </span>
            `;
        }
        
        function downloadAudio(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `audio_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showToast('üì• Audio heruntergeladen', 'success');
        }
        
        // ===== v1.14/v1.15: HTTPS SETUP MODAL =====
        function showHTTPSSetupModal() {
            document.getElementById('httpsSetupModal').style.display = 'flex';
        }
        
        function closeHTTPSSetupModal() {
            document.getElementById('httpsSetupModal').style.display = 'none';
        }
        
        // ===== v1.14: DEBUG BOX =====
        function closeDebugBox() {
            document.getElementById('debugInfoBox').style.display = 'none';
        }
        
        // ===== DROPDOWNS =====
        function showTaetigkeiten() {
            const hauptkat = document.getElementById('taetigkeitHaupt').value;
            const container = document.getElementById('taetigkeitenChips');
            
            if (!hauptkat) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            
            taetigkeitenData[hauptkat].forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                if (selectedTaetigkeiten.includes(item)) {
                    chip.classList.add('selected');
                }
                chip.textContent = item;
                chip.onclick = function() {
                    toggleSelection(item, selectedTaetigkeiten, chip);
                };
                container.appendChild(chip);
            });
        }
        
        function showMaterial() {
            const hauptkat = document.getElementById('materialHaupt').value;
            const container = document.getElementById('materialChips');
            
            if (!hauptkat) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            
            materialData[hauptkat].forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                if (selectedMaterial.includes(item)) {
                    chip.classList.add('selected');
                }
                chip.textContent = item;
                chip.onclick = function() {
                    toggleSelection(item, selectedMaterial, chip);
                };
                container.appendChild(chip);
            });
        }
        
        function showWerkzeuge() {
            const hauptkat = document.getElementById('werkzeugeHaupt').value;
            const container = document.getElementById('werkzeugeChips');
            
            if (!hauptkat) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            
            werkzeugeData[hauptkat].forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                if (selectedWerkzeuge.includes(item)) {
                    chip.classList.add('selected');
                }
                chip.textContent = item;
                chip.onclick = function() {
                    toggleSelection(item, selectedWerkzeuge, chip);
                };
                container.appendChild(chip);
            });
        }
        
        function toggleSelection(item, array, chipElement) {
            const index = array.indexOf(item);
            if (index > -1) {
                array.splice(index, 1);
                chipElement.classList.remove('selected');
            } else {
                array.push(item);
                chipElement.classList.add('selected');
            }
        }
        
        // ===== ADD TO FORM =====
        function addSelectedToForm() {
            if (selectedTaetigkeiten.length === 0) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie mindestens eine T√§tigkeit aus!');
                return;
            }
            
            const tbody = document.getElementById('taetigkeitenTable');
            const datum = document.getElementById('datum').value;
            let position = document.getElementById('taetigkeitPosition').value.trim();
            const menge = document.getElementById('taetigkeitMenge').value.trim();
            const einheit = document.getElementById('taetigkeitEinheit').value;
            
            // Wenn keine Position eingegeben, automatisch hochz√§hlen
            if (!position) {
                position = taetigkeitenRowCounter.toString();
            }
            
            selectedTaetigkeiten.forEach(taetigkeit => {
                const row = document.createElement('tr');
                row.className = 'editable-row';
                row.innerHTML = `
                    <td contenteditable="true">${position}</td>
                    <td>${datum}</td>
                    <td contenteditable="true">${taetigkeit}</td>
                    <td contenteditable="true">${menge}</td>
                    <td contenteditable="true">${einheit}</td>
                `;
                tbody.appendChild(row);
                
                // Erh√∂he Counter nur wenn automatische Position verwendet wurde
                if (document.getElementById('taetigkeitPosition').value.trim() === '') {
                    taetigkeitenRowCounter++;
                }
            });
            
            // RESET nach Hinzuf√ºgen
            selectedTaetigkeiten = [];
            document.getElementById('taetigkeitenChips').innerHTML = '';
            document.getElementById('taetigkeitHaupt').value = '';
            document.getElementById('taetigkeitPosition').value = '';
            document.getElementById('taetigkeitMenge').value = '';
            document.getElementById('taetigkeitEinheit').value = '';
            
            showToast('T√§tigkeiten zur Tabelle hinzugef√ºgt', 'success');
        }
        
        function addMaterialToForm() {
            const textarea = document.getElementById('materialText');
            const helperText = document.getElementById('materialHelperText').value.trim();
            const menge = document.getElementById('materialMenge').value.trim();
            const einheit = document.getElementById('materialEinheit').value;
            const laufmeter = document.getElementById('materialLaufmeter').value.trim();
            
            // Sammle alle Eintr√§ge: Chips + Textarea
            let allItems = [];
            
            if (selectedMaterial.length > 0) {
                allItems = allItems.concat(selectedMaterial);
            }
            
            if (helperText) {
                allItems.push(helperText);
            }
            
            if (allItems.length === 0) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie Material aus oder geben Sie etwas ein!');
                return;
            }
            
            // F√ºge Menge/Einheit hinzu wenn vorhanden
            let prefix = '';
            if (menge && einheit) {
                prefix = `${menge} ${einheit} `;
            } else if (menge) {
                prefix = `${menge}x `;
            }
            
            // F√ºge Laufmeter als Suffix hinzu wenn vorhanden
            let suffix = '';
            if (laufmeter) {
                suffix = ` (${laufmeter} Laufmeter)`;
            }
            
            // F√ºge zum Formular hinzu
            const current = textarea.value.trim();
            const newItems = allItems.map(item => prefix + item + suffix).join('\n');
            
            if (current) {
                textarea.value = current + '\n' + newItems;
            } else {
                textarea.value = newItems;
            }
            
            // RESET nach √úbernehmen
            selectedMaterial = [];
            document.getElementById('materialChips').innerHTML = '';
            document.getElementById('materialHaupt').value = '';
            document.getElementById('materialHelperText').value = '';
            document.getElementById('materialMenge').value = '';
            document.getElementById('materialEinheit').value = '';
            document.getElementById('materialLaufmeter').value = '';
            
            showToast('Material √ºbernommen', 'success');
        }
        
        function addWerkzeugeToForm() {
            const textarea = document.getElementById('maschinenText');
            const helperText = document.getElementById('werkzeugeHelperText').value.trim();
            
            // Sammle alle Eintr√§ge: Chips + Textarea
            let allItems = [];
            
            if (selectedWerkzeuge.length > 0) {
                allItems = allItems.concat(selectedWerkzeuge);
            }
            
            if (helperText) {
                allItems.push(helperText);
            }
            
            if (allItems.length === 0) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie Werkzeuge aus oder geben Sie etwas ein!');
                return;
            }
            
            // F√ºge zum Formular hinzu
            const current = textarea.value.trim();
            const newItems = allItems.join('\n');
            
            if (current) {
                textarea.value = current + '\n' + newItems;
            } else {
                textarea.value = newItems;
            }
            
            // RESET nach √úbernehmen
            selectedWerkzeuge = [];
            document.getElementById('werkzeugeChips').innerHTML = '';
            document.getElementById('werkzeugeHaupt').value = '';
            document.getElementById('werkzeugeHelperText').value = '';
            
            showToast('Werkzeuge √ºbernommen', 'success');
        }
        
        // ===== PERSONAL =====
        function addPersonal() {
            const anzahl = parseInt(document.getElementById('personalAnzahl').value) || 1;
            const typ = document.getElementById('personalTyp').value;
            const stunden = parseFloat(document.getElementById('personalStunden').value) || 0;
            
            if (stunden === 0) {
                alert('‚ö†Ô∏è Bitte Stunden eingeben!');
                return;
            }
            
            personalListe.push({ anzahl, typ, stunden });
            updatePersonalListe();
            
            document.getElementById('personalAnzahl').value = '1';
            document.getElementById('personalStunden').value = '';
            showToast('Personal hinzugef√ºgt', 'success');
        }
        
        function updatePersonalListe() {
            const container = document.getElementById('personalListe');
            const formContainer = document.getElementById('personalFormText');
            
            if (personalListe.length === 0) {
                container.innerHTML = '';
                formContainer.innerHTML = '';
                return;
            }
            
            // Update Helper-Liste (oben)
            container.innerHTML = '<div style="margin-top: 10px; border: 2px solid #e2e8f0; border-radius: 6px; padding: 10px; background: #f8fafc;">';
            
            personalListe.forEach((person, index) => {
                const anzahlText = person.anzahl > 1 ? `${person.anzahl}x ` : '';
                container.innerHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 6px; margin-bottom: 6px; background: white; border-radius: 4px;">
                        <span><strong>${anzahlText}${person.typ}</strong>: ${person.stunden}h</span>
                        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px; background: #ef4444;" onclick="removePersonal(${index})">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            container.innerHTML += '</div>';
            
            // Update Formular (unten im gelben Rapport) - Format wie im Original mit Anzahl
            let formText = '';
            personalListe.forEach(person => {
                const anzahlText = person.anzahl > 1 ? `${person.anzahl}x ` : '';
                formText += `${anzahlText}${person.typ} √† ${person.stunden}h\n`;
            });
            formContainer.textContent = formText.trim();
        }
        
        function removePersonal(index) {
            personalListe.splice(index, 1);
            updatePersonalListe();
        }
        
        // ===== FAHRZEUGE =====
        function addFahrzeug() {
            const anzahl = parseInt(document.getElementById('fahrzeugAnzahl').value) || 1;
            const typ = document.getElementById('fahrzeugTyp').value;
            const kennzeichen = document.getElementById('fahrzeugKennzeichen').value.trim() || 'ohne Kennzeichen';
            const km = parseFloat(document.getElementById('fahrzeugKm').value) || 0;
            
            fahrzeugListe.push({ anzahl, typ, kennzeichen, km });
            updateFahrzeugListe();
            
            document.getElementById('fahrzeugAnzahl').value = '1';
            document.getElementById('fahrzeugKennzeichen').value = '';
            document.getElementById('fahrzeugKm').value = '';
            showToast('Fahrzeug hinzugef√ºgt', 'success');
        }
        
        function updateFahrzeugListe() {
            const container = document.getElementById('fahrzeugListe');
            if (fahrzeugListe.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<div style="margin-top: 10px; border: 2px solid #e2e8f0; border-radius: 6px; padding: 10px; background: #f8fafc;">';
            
            fahrzeugListe.forEach((fz, index) => {
                const anzahlText = fz.anzahl > 1 ? `${fz.anzahl}x ` : '';
                container.innerHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 6px; margin-bottom: 6px; background: white; border-radius: 4px;">
                        <span><strong>${anzahlText}${fz.typ}</strong>: ${fz.kennzeichen} - ${fz.km} km</span>
                        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px; background: #ef4444;" onclick="removeFahrzeug(${index})">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            container.innerHTML += '</div>';
        }
        
        function removeFahrzeug(index) {
            fahrzeugListe.splice(index, 1);
            updateFahrzeugListe();
        }
        
        // ===== PHOTOS =====
        function handlePhotos(event) {
            const files = Array.from(event.target.files);

            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    compressImage(file, function(compressedDataUrl) {
                        photos.push(compressedDataUrl);
                        updatePhotoGrid();
                        updateAgentPhotoPreview();
                    });
                }
            });

            event.target.value = '';
        }

        // Agent-Bereich Foto-Upload
        function handleAgentPhotos(event) {
            const files = Array.from(event.target.files);

            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    compressImage(file, function(compressedDataUrl) {
                        photos.push(compressedDataUrl);
                        updatePhotoGrid();
                        updateAgentPhotoPreview();
                        showToast('üì∑ Foto hinzugef√ºgt', 'success');
                    });
                }
            });

            event.target.value = '';
        }

        // Agent-Bereich Foto-Vorschau aktualisieren
        function updateAgentPhotoPreview() {
            const countEl = document.getElementById('agentPhotoCount');
            const previewEl = document.getElementById('agentPhotoPreview');

            if (countEl) countEl.textContent = photos.length;

            if (previewEl) {
                previewEl.innerHTML = '';
                photos.slice(-4).forEach((photo, index) => {
                    const img = document.createElement('img');
                    img.src = photo;
                    img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid rgba(255,255,255,0.5);';
                    img.onclick = () => {
                        if (confirm('Foto entfernen?')) {
                            const realIndex = photos.length - 4 + index;
                            if (realIndex >= 0) {
                                photos.splice(realIndex < 0 ? photos.length + index - 4 : photos.indexOf(photo), 1);
                                updatePhotoGrid();
                                updateAgentPhotoPreview();
                            }
                        }
                    };
                    previewEl.appendChild(img);
                });

                if (photos.length > 4) {
                    const moreEl = document.createElement('div');
                    moreEl.style.cssText = 'width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold;';
                    moreEl.textContent = `+${photos.length - 4}`;
                    previewEl.appendChild(moreEl);
                }
            }
        }
        
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxWidth = 1200;
                    const maxHeight = 900;
                    
                    if (width > maxWidth || height > maxHeight) {
                        if (width > height) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        } else {
                            width = width * (maxHeight / height);
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function updatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            const formGrid = document.getElementById('formPhotoGrid');
            const section = document.getElementById('photoSection');
            
            if (photos.length === 0) {
                grid.innerHTML = '';
                formGrid.innerHTML = '';
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            grid.innerHTML = '';
            formGrid.innerHTML = '';
            
            photos.forEach((photo, index) => {
                // Helper grid
                const item1 = document.createElement('div');
                item1.className = 'photo-item';
                item1.innerHTML = `
                    <img src="${photo}">
                    <button class="photo-delete" onclick="removePhoto(${index})">√ó</button>
                `;
                grid.appendChild(item1);
                
                // Form grid
                const item2 = document.createElement('img');
                item2.src = photo;
                item2.style.width = '100%';
                item2.style.height = '100px';
                item2.style.objectFit = 'cover';
                item2.style.border = '1px solid #000';
                formGrid.appendChild(item2);
            });
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoGrid();
        }
        
        // ===== SIGNATURE =====
        function setupSignaturePads() {
            setupSinglePad('signaturePad1');
            setupSinglePad('signaturePad2');
        }
        
        function setupSinglePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 120;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            
            function startDraw(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            }
            
            function doDraw(e) {
                if (!drawing) return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            }
            
            function stopDraw() {
                drawing = false;
            }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', stopDraw);
        }
        
        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('Unterschrift gel√∂scht', 'success');
        }
        
        // ===== RAPPORT NUMBER =====
        function updateRapportNummer() {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const nextNr = (berichte.length + 1).toString().padStart(5, '0');
            document.getElementById('rapportNummer').textContent = nextNr;
        }
        
        // ===== SAVE =====
        function saveBericht() {
            const rapportNr = document.getElementById('rapportNummer').textContent;
            const datum = document.getElementById('datum').value;
            const projektnummer = document.getElementById('projektnummer').value;
            const baustelle = document.getElementById('baustelle').value;
            const gpsLat = document.getElementById('gpsLat').value;
            const gpsLon = document.getElementById('gpsLon').value;
            
            if (!baustelle) {
                alert('‚ö†Ô∏è Bitte Baustelle eingeben!');
                return;
            }
            
            // Collect all activities from table - v3.3 Ultra-Mega-DB fixed
            const tbody = document.getElementById('taetigkeitenTable');
            const rows = tbody.querySelectorAll('tr');
            const taetigkeiten = [];
            
            rows.forEach(row => {
                if (row.cells && row.cells.length >= 3) {
                    const cell = row.cells[2]; // Dritte Spalte = T√§tigkeit
                    const textarea = cell.querySelector('textarea');
                    const text = textarea ? textarea.value.trim() : cell.textContent.trim();
                    if (text && text !== 'T√§tigkeit') {
                        taetigkeiten.push(text);
                    }
                }
            });
            
            const canvas1 = document.getElementById('signaturePad1');
            const canvas2 = document.getElementById('signaturePad2');
            const signature1 = canvas1 ? canvas1.toDataURL('image/jpeg', 0.8) : '';
            const signature2 = canvas2 ? canvas2.toDataURL('image/jpeg', 0.8) : '';
            
            // v3.3 Ultra-Mega-DB: Berechne Gesamtstunden und km f√ºr Statistiken
            const gesamtStunden = personalListe.reduce((sum, p) => sum + (p.anzahl * p.stunden), 0);
            const gesamtKm = fahrzeugListe.reduce((sum, f) => sum + (f.anzahl * f.km), 0);
            
            const bericht = {
                rapportNr,
                datum,
                projektnummer,
                baustelle,
                gps: { lat: gpsLat, lon: gpsLon },
                taetigkeiten,
                material: document.getElementById('materialText').value,
                maschinen: document.getElementById('maschinenText').value,
                personal: [...personalListe],
                fahrzeuge: [...fahrzeugListe],
                photos: [...photos],
                signature1,
                signature2,
                stunden: gesamtStunden,
                km: gesamtKm,
                timestamp: new Date().toISOString()
            };
            
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            berichte.push(bericht);
            localStorage.setItem('baustellenberichte', JSON.stringify(berichte));
            
            showToast('Bericht erfolgreich gespeichert!', 'success');
            resetForm();
            updateRapportNummer();
        }
        
        // ===== RESET =====
        function resetForm() {
            document.getElementById('baustelle').value = '';
            document.getElementById('materialText').value = '';
            document.getElementById('maschinenText').value = '';
            document.getElementById('personalFormText').textContent = '';
            
            // Reset table - l√∂she alle Zeilen
            const tbody = document.getElementById('taetigkeitenTable');
            while (tbody.rows.length > 0) {
                tbody.deleteRow(0);
            }
            taetigkeitenRowCounter = 1;
            
            selectedTaetigkeiten = [];
            selectedMaterial = [];
            selectedWerkzeuge = [];
            personalListe = [];
            fahrzeugListe = [];
            photos = [];
            
            updatePersonalListe();
            updateFahrzeugListe();
            updatePhotoGrid();
            
            clearSignature('signaturePad1');
            clearSignature('signaturePad2');
            
            document.getElementById('taetigkeitenChips').innerHTML = '';
            document.getElementById('materialChips').innerHTML = '';
            document.getElementById('werkzeugeChips').innerHTML = '';
            
            const today = new Date();
            document.getElementById('datum').valueAsDate = today;
            
            showToast('Formular zur√ºckgesetzt', 'success');
        }
        
        // ===== DOWNLOAD & EXPORT FUNKTIONEN =====
        // Download aktuellen Bericht als JSON
        function downloadBerichtAsJSON() {
            const rapportNr = document.getElementById('rapportNummer').textContent;
            const datum = document.getElementById('datum').value;
            const projektnummer = document.getElementById('projektnummer').value;
            const baustelle = document.getElementById('baustelle').value;
            const gpsLat = document.getElementById('gpsLat').value;
            const gpsLon = document.getElementById('gpsLon').value;
            
            if (!baustelle) {
                alert('‚ö†Ô∏è Bitte erst Baustelle eingeben!');
                return;
            }
            
            // Collect data
            const tbody = document.getElementById('taetigkeitenTable');
            const rows = tbody.querySelectorAll('tr');
            const taetigkeiten = [];
            
            rows.forEach(row => {
                const textarea = row.querySelector('textarea');
                const text = textarea ? textarea.value.trim() : row.cells[2].textContent.trim();
                if (text) {
                    taetigkeiten.push(text);
                }
            });
            
            const canvas1 = document.getElementById('signaturePad1');
            const canvas2 = document.getElementById('signaturePad2');
            const signature1 = canvas1 ? canvas1.toDataURL('image/jpeg', 0.8) : '';
            const signature2 = canvas2 ? canvas2.toDataURL('image/jpeg', 0.8) : '';
            
            const bericht = {
                rapportNr,
                datum,
                projektnummer,
                baustelle,
                gps: { lat: gpsLat, lon: gpsLon },
                taetigkeiten,
                material: document.getElementById('materialText').value,
                maschinen: document.getElementById('maschinenText').value,
                personal: [...personalListe],
                fahrzeuge: [...fahrzeugListe],
                photos: [...photos],
                signature1,
                signature2,
                stunden: personalListe.reduce((sum, p) => sum + (p.anzahl * p.stunden), 0),
                km: fahrzeugListe.reduce((sum, f) => sum + (f.anzahl * f.km), 0),
                timestamp: new Date().toISOString()
            };
            
            // Create download
            const dataStr = JSON.stringify(bericht, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Baustellenbericht_${rapportNr}_${datum}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('üì• Bericht als JSON heruntergeladen!', 'success');
        }
        
        // Download alle Berichte als Backup
        function downloadAllBerichteAsBackup() {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            
            if (berichte.length === 0) {
                showToast('‚ö†Ô∏è Keine gespeicherten Berichte vorhanden', 'info');
                return;
            }
            
            const backup = {
                version: '3.3',
                exportDate: new Date().toISOString(),
                count: berichte.length,
                berichte: berichte
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `Baustellenberichte_Backup_${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast(`üì• ${berichte.length} Berichte als Backup heruntergeladen!`, 'success');
        }
        
        // Import Backup
        function importBerichteBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.berichte || !Array.isArray(backup.berichte)) {
                        throw new Error('Ung√ºltiges Backup-Format');
                    }
                    
                    const confirmed = confirm(
                        `Backup mit ${backup.berichte.length} Berichten importieren?\n` +
                        `Export-Datum: ${new Date(backup.exportDate).toLocaleString()}\n\n` +
                        `‚ö†Ô∏è Dies √ºberschreibt alle aktuellen Berichte!`
                    );
                    
                    if (!confirmed) return;
                    
                    localStorage.setItem('baustellenberichte', JSON.stringify(backup.berichte));
                    showToast(`‚úÖ ${backup.berichte.length} Berichte importiert!`, 'success');
                    updateRapportNummer();
                    
                } catch (error) {
                    showToast('‚ùå Fehler beim Importieren: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // AUTO-SAVE FUNKTION
        let autoSaveInterval = null;
        let lastAutoSaveData = '';
        
        function enableAutoSave() {
            // Auto-Save alle 30 Sekunden
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            autoSaveInterval = setInterval(() => {
                const baustelle = document.getElementById('baustelle').value;
                if (!baustelle) return; // Nur speichern wenn Baustelle angegeben
                
                // Check if data has changed
                const currentData = JSON.stringify({
                    baustelle: document.getElementById('baustelle').value,
                    material: document.getElementById('materialText').value,
                    maschinen: document.getElementById('maschinenText').value
                });
                
                if (currentData === lastAutoSaveData) return;
                
                lastAutoSaveData = currentData;
                
                // Save to sessionStorage (temporary, lost on browser close)
                const autoSaveData = {
                    baustelle: document.getElementById('baustelle').value,
                    projektnummer: document.getElementById('projektnummer').value,
                    datum: document.getElementById('datum').value,
                    gpsLat: document.getElementById('gpsLat').value,
                    gpsLon: document.getElementById('gpsLon').value,
                    material: document.getElementById('materialText').value,
                    maschinen: document.getElementById('maschinenText').value,
                    timestamp: new Date().toISOString()
                };
                
                sessionStorage.setItem('baustellenbericht_autosave', JSON.stringify(autoSaveData));
                
                // Show subtle notification
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.textContent = 'üíæ Auto-gespeichert um ' + new Date().toLocaleTimeString();
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.opacity = '0.5';
                    }, 2000);
                }
            }, 30000); // 30 seconds
        }
        
        // Restore auto-saved data on page load
        function restoreAutoSave() {
            const saved = sessionStorage.getItem('baustellenbericht_autosave');
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                const age = Date.now() - new Date(data.timestamp).getTime();
                
                // Only restore if less than 1 hour old
                if (age > 3600000) {
                    sessionStorage.removeItem('baustellenbericht_autosave');
                    return;
                }
                
                const confirmed = confirm(
                    'üíæ Auto-gespeicherte Daten gefunden!\n\n' +
                    `Baustelle: ${data.baustelle}\n` +
                    `Von: ${new Date(data.timestamp).toLocaleString()}\n\n` +
                    'M√∂chten Sie diese Daten wiederherstellen?'
                );
                
                if (confirmed) {
                    document.getElementById('baustelle').value = data.baustelle || '';
                    document.getElementById('projektnummer').value = data.projektnummer || '';
                    document.getElementById('datum').value = data.datum || '';
                    document.getElementById('gpsLat').value = data.gpsLat || '';
                    document.getElementById('gpsLon').value = data.gpsLon || '';
                    document.getElementById('materialText').value = data.material || '';
                    document.getElementById('maschinenText').value = data.maschinen || '';
                    
                    showToast('‚úÖ Auto-gespeicherte Daten wiederhergestellt!', 'success');
                }
                
                sessionStorage.removeItem('baustellenbericht_autosave');
            } catch (error) {
                console.error('Error restoring auto-save:', error);
            }
        }
        
        // ===== INTERAKTIVE KARTE MIT LEAFLET (OpenStreetMap) =====
        let map = null;
        let marker = null;
        
        function openMapPicker() {
            // Create modal for map
            const modalHTML = `
                <div id="mapModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <div style="padding: 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üìç Standort auf Karte w√§hlen</h3>
                            <button onclick="closeMapPicker()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ùå Schlie√üen</button>
                        </div>
                        <div style="padding: 15px; background: #f3f4f6;">
                            <p style="margin: 0; font-size: 14px;">
                                <strong>Anleitung:</strong> Klicken Sie auf die Karte um den Standort zu w√§hlen. Die Adresse wird automatisch ermittelt und Sie k√∂nnen w√§hlen, welche Informationen √ºbernommen werden sollen (Gesch√§ft, Stra√üe, etc.).
                            </p>
                        </div>
                        <div id="map" style="height: 500px; width: 100%;"></div>
                        <div style="padding: 15px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div id="mapCoords" style="font-size: 14px; color: #64748b;">
                                    Klicken Sie auf die Karte...
                                </div>
                                <button onclick="confirmMapSelection()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    ‚úÖ Standort √ºbernehmen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize map
            setTimeout(() => {
                // Get current coordinates or use default (Berlin)
                const currentLat = parseFloat(document.getElementById('gpsLat').value) || 52.5200;
                const currentLon = parseFloat(document.getElementById('gpsLon').value) || 13.4050;
                
                map = L.map('map').setView([currentLat, currentLon], 13);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Add marker if coordinates exist
                if (document.getElementById('gpsLat').value) {
                    marker = L.marker([currentLat, currentLon]).addTo(map);
                    document.getElementById('mapCoords').innerHTML = `üìç Ausgew√§hlt: ${currentLat.toFixed(6)}, ${currentLon.toFixed(6)}`;
                }
                
                // Add click event
                map.on('click', async function(e) {
                    const lat = e.latlng.lat;
                    const lon = e.latlng.lng;
                    
                    // Remove old marker
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    
                    // Add new marker
                    marker = L.marker([lat, lon]).addTo(map);
                    
                    // Update display with loading message
                    document.getElementById('mapCoords').innerHTML = `üìç ${lat.toFixed(6)}, ${lon.toFixed(6)} - <span style="color: #f59e0b;">‚è≥ Adresse wird geladen...</span>`;
                    
                    // Reverse Geocoding mit Nominatim
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`, {
                            headers: {
                                'User-Agent': 'Baustellenbericht-App/1.12'
                            }
                        });
                        
                        if (!response.ok) throw new Error('Keine Internetverbindung');
                        
                        const data = await response.json();
                        
                        // Erstelle Auswahl-Optionen
                        const options = [];
                        
                        // Option 1: Vollst√§ndige Adresse
                        if (data.display_name) {
                            options.push({
                                label: 'üìç Vollst√§ndige Adresse',
                                value: data.display_name
                            });
                        }
                        
                        // Option 2: POI + Stra√üe (wenn POI vorhanden)
                        if (data.address) {
                            const addr = data.address;
                            let poiStreet = '';
                            
                            // POI Priorisierung: shop > supermarket > building > amenity
                            const poi = addr.shop || addr.supermarket || addr.building || addr.amenity || 
                                       addr.retail || addr.commercial || addr.office;
                            
                            if (poi && (addr.road || addr.street)) {
                                const street = addr.road || addr.street;
                                const houseNumber = addr.house_number || '';
                                poiStreet = poi + ', ' + street + (houseNumber ? ' ' + houseNumber : '');
                                options.push({
                                    label: 'üìç Gesch√§ft + Stra√üe',
                                    value: poiStreet
                                });
                            }
                            
                            // Option 3: Nur Stra√üe + Hausnummer
                            if (addr.road || addr.street) {
                                const street = addr.road || addr.street;
                                const houseNumber = addr.house_number || '';
                                const streetOnly = street + (houseNumber ? ' ' + houseNumber : '');
                                options.push({
                                    label: 'üìç Stra√üe + Hausnr.',
                                    value: streetOnly
                                });
                            }
                            
                            // Option 4: Nur Stadt/Ort
                            const city = addr.city || addr.town || addr.village || addr.hamlet;
                            if (city) {
                                options.push({
                                    label: 'üìçÔ∏è Nur Ort',
                                    value: city
                                });
                            }
                        }
                        
                        // Option 5: Nur Koordinaten (Fallback)
                        options.push({
                            label: 'üìç Nur Koordinaten',
                            value: `${lat.toFixed(6)}, ${lon.toFixed(6)}`
                        });
                        
                        // Zeige Auswahl-Dropdown
                        let optionsHTML = '<div style="margin-top: 10px;">';
                        optionsHTML += '<label style="display: block; margin-bottom: 5px; font-weight: bold; color: #374151;">Welche Information √ºbernehmen?</label>';
                        optionsHTML += '<select id="addressSelect" style="width: 100%; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px;">';
                        options.forEach((opt, idx) => {
                            optionsHTML += `<option value="${idx}">${opt.label}: ${opt.value}</option>`;
                        });
                        optionsHTML += '</select>';
                        optionsHTML += '</div>';
                        
                        document.getElementById('mapCoords').innerHTML = `üìç ${lat.toFixed(6)}, ${lon.toFixed(6)}` + optionsHTML;
                        
                        // Speichere Optionen f√ºr confirmMapSelection
                        window.selectedLocationOptions = options;
                        
                    } catch (error) {
                        // Offline-Fallback: Nur Koordinaten
                        console.log('Reverse Geocoding fehlgeschlagen:', error);
                        document.getElementById('mapCoords').innerHTML = `üìç ${lat.toFixed(6)}, ${lon.toFixed(6)} <span style="color: #ef4444; font-size: 12px;">(Offline - nur Koordinaten)</span>`;
                        window.selectedLocationOptions = [{
                            label: 'üìç Koordinaten',
                            value: `${lat.toFixed(6)}, ${lon.toFixed(6)}`
                        }];
                    }
                });
            }, 100);
        }
        
        function confirmMapSelection() {
            if (!marker) {
                showToast('‚ö†Ô∏è Bitte erst einen Standort auf der Karte w√§hlen', 'warning');
                return;
            }
            
            const latlng = marker.getLatLng();
            document.getElementById('gpsLat').value = latlng.lat.toFixed(6);
            document.getElementById('gpsLon').value = latlng.lng.toFixed(6);
            
            // √úbernehme ausgew√§hlte Adress-Information ins Baustelle-Feld
            if (window.selectedLocationOptions) {
                const selectEl = document.getElementById('addressSelect');
                const selectedIdx = selectEl ? parseInt(selectEl.value) : 0;
                const selectedAddress = window.selectedLocationOptions[selectedIdx].value;
                
                // Baustelle-Feld finden
                const baustelleField = document.getElementById('baustelle');
                
                // Anh√§ngen an bestehenden Text (mit Komma wenn bereits Text vorhanden)
                if (baustelleField) {
                    const currentValue = baustelleField.value.trim();
                    if (currentValue) {
                        baustelleField.value = currentValue + ', ' + selectedAddress;
                    } else {
                        baustelleField.value = selectedAddress;
                    }
                    
                    showToast(`‚úÖ Adresse hinzugef√ºgt: ${selectedAddress}`, 'success');
                }
            }
            
            const statusEl = document.getElementById('gpsStatus');
            statusEl.className = 'gps-status gps-success';
            statusEl.innerHTML = `‚úÖ Standort von Karte √ºbernommen: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            
            closeMapPicker();
        }
        
        function closeMapPicker() {
            const modal = document.getElementById('mapModal');
            if (modal) {
                if (map) {
                    map.remove();
                    map = null;
                }
                marker = null;
                modal.remove();
            }
        }
        
        // ===== WHATSAPP SHARE =====
        async function shareViaWhatsApp() {
            // PDF-Library Check
            if (typeof window.jspdf === 'undefined') {
                showToast('‚ö†Ô∏è PDF-Library wird geladen. Bitte in 2-3 Sekunden erneut versuchen.', 'error');
                return;
            }
            
            try {
                const doc = new jsPDF();
                
                // Header
                doc.setFillColor(220, 38, 38);
                doc.rect(0, 0, 210, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('FLIESEN UNGER S√úD', 15, 18);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Baustellenbericht', 15, 24);
                
                doc.setTextColor(0, 0, 0);
                
                // Rapport-Nummer
                const rapportNr = document.getElementById('rapportNummer').textContent;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Rapport Nr. ${rapportNr}`, 15, 40);
                
                // Projektnummer & Baustelle
                const projektnummer = document.getElementById('projektnummer').value;
                const baustelle = document.getElementById('baustelle').value;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                let yPos = 48;
                if (projektnummer) {
                    doc.text(`Projektnummer: ${projektnummer}`, 15, yPos);
                    yPos += 6;
                }
                if (baustelle) {
                    doc.text(`Baustelle: ${baustelle}`, 15, yPos);
                    yPos += 6;
                }
                
                // Datum
                const datum = document.getElementById('datum').value;
                doc.text(`Datum: ${new Date(datum).toLocaleDateString('de-DE')}`, 15, yPos);
                yPos += 10;
                
                // Content
                const tbody = document.getElementById('taetigkeitenTable');
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length > 0) {
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('T√§tigkeiten:', 15, yPos);
                    yPos += 6;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    rows.forEach(row => {
                        const cells = row.cells;
                        if (cells.length >= 3) {
                            const pos = cells[0].textContent;
                            const taetigkeit = cells[2].textContent;
                            doc.text(`${pos}. ${taetigkeit}`, 20, yPos);
                            yPos += 5;
                        }
                    });
                    yPos += 3;
                }
                
                // Save PDF as Blob
                const pdfBlob = doc.output('blob');
                const fileName = `Baustellenbericht_${rapportNr}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Feature Detection f√ºr Web Share API
                if (browserCaps.features.webShare) {
                    const canShareFiles = await browserCaps.canShareFiles();
                    
                    if (canShareFiles) {
                        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                        
                        // Nochmal validieren (double-check)
                        if (navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: `Baustellenbericht ${rapportNr}`,
                                    text: `Baustellenbericht f√ºr ${baustelle || 'Baustelle'}`
                                });
                                showToast('‚úÖ PDF geteilt!', 'success');
                                return; // Erfolgreich geteilt, fertig!
                            } catch (error) {
                                if (error.name === 'AbortError') {
                                    showToast('‚ÑπÔ∏è Teilen abgebrochen', 'info');
                                    return;
                                }
                                console.warn('Share fehlgeschlagen, Fallback zu Download:', error);
                            }
                        }
                    }
                }
                
                // Fallback: Download PDF (funktioniert √ºberall!)
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('‚¨õ‚Ä°Ô∏è PDF wird heruntergeladen', 'success');
                
            } catch (error) {
                console.error('WhatsApp Share Error:', error);
                showToast('‚ùå Fehler beim Erstellen des PDFs', 'error');
            }
        }
        
        // ===== PDF =====
        function generatePDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('‚ö†Ô∏è PDF-Library wird geladen. Bitte in 2-3 Sekunden erneut versuchen.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // v1.14: KOMPAKTES 1-SEITEN-PDF - checkPageBreak() ENTFERNT!
            // Alle Inhalte passen auf 1 Seite durch kleinere Schriften & Abst√§nde
            
            const rapportNr = document.getElementById('rapportNummer').textContent;
            const datum = document.getElementById('datum').value;
            const projektnummer = document.getElementById('projektnummer').value;
            const baustelle = document.getElementById('baustelle').value;
            
            // Header - KOMPAKT (v1.14)
            doc.setFillColor(220, 38, 38);
            doc.rect(15, 15, 50, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14); // v1.14: 14 statt 16
            doc.setFont(undefined, 'bold');
            doc.text('FLIESEN', 20, 23);
            doc.text('UNGER S√úD', 20, 28);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(7); // v1.14: 7 statt 8
            doc.setFont(undefined, 'normal');
            doc.text('Tulpenallee 69, 71069 Sindelfingen', 150, 18);
            doc.text('Tel: 07031/9219 9-0', 150, 22);
            doc.text('info@fliesen-unger-sued.de', 150, 26);
            
            doc.setFontSize(11); // v1.14: 11 statt 14
            doc.setFont(undefined, 'bold');
            doc.text(`RAPPORT Nr. ${rapportNr}`, 140, 40);
            
            doc.setFontSize(9); // v1.14: 9 statt 10
            doc.text('Projektnummer:', 15, 50);
            doc.setFont(undefined, 'normal');
            doc.text(projektnummer || '-', 50, 50);
            
            doc.setFont(undefined, 'bold');
            doc.text('Baustelle:', 15, 56);
            doc.setFont(undefined, 'normal');
            doc.text(baustelle, 40, 56);
            
            doc.text('Datum:', 15, 62);
            doc.text(datum, 40, 62);
            
            let yPos = 71;
            
            // Activities
            const tbody = document.getElementById('taetigkeitenTable');
            const rows = tbody.querySelectorAll('tr');
            let hasTaetigkeiten = false;
            
            rows.forEach(row => {
                const textarea = row.querySelector('textarea');
                const text = textarea ? textarea.value.trim() : row.cells[2].textContent.trim();
                if (text) {
                    if (!hasTaetigkeiten) {
                        checkPageBreak();
                        doc.setFont(undefined, 'bold');
                        doc.text('T√§tigkeiten:', 15, yPos);
                        yPos += 6;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        hasTaetigkeiten = true;
                    }
                    checkPageBreak();
                    doc.text('‚Ä¢ ' + text, 20, yPos);
                    yPos += 5;
                }
            });
            
            if (hasTaetigkeiten) yPos += 3;
            
            // Material
            const material = document.getElementById('materialText').value.trim();
            if (material) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Material:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                material.split('\n').forEach(line => {
                    if (line.trim()) {
                        checkPageBreak();
                        doc.text('‚Ä¢ ' + line.trim(), 20, yPos);
                        yPos += 5;
                    }
                });
                yPos += 3;
            }
            
            // Maschinen
            const maschinen = document.getElementById('maschinenText').value.trim();
            if (maschinen) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Maschinen:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                maschinen.split('\n').forEach(line => {
                    if (line.trim()) {
                        checkPageBreak();
                        doc.text('‚Ä¢ ' + line.trim(), 20, yPos);
                        yPos += 5;
                    }
                });
                yPos += 3;
            }
            
            // Personal
            if (personalListe.length > 0) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Personal:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                personalListe.forEach(p => {
                    checkPageBreak();
                    const anzahlText = p.anzahl > 1 ? `${p.anzahl}x ` : '';
                    doc.text(`‚Ä¢ ${anzahlText}${p.typ}: ${p.stunden}h`, 20, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            // Fahrzeuge
            if (fahrzeugListe.length > 0) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Fahrzeuge:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                fahrzeugListe.forEach(fz => {
                    checkPageBreak();
                    const anzahlText = fz.anzahl > 1 ? `${fz.anzahl}x ` : '';
                    doc.text(`‚Ä¢ ${anzahlText}${fz.typ}: ${fz.kennzeichen} - ${fz.km} km`, 20, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            // GPS
            const gpsLat = document.getElementById('gpsLat').value;
            const gpsLon = document.getElementById('gpsLon').value;
            if (gpsLat && gpsLon) {
                checkPageBreak();
                doc.setFontSize(9);
                doc.text(`GPS: ${gpsLat}, ${gpsLon}`, 15, yPos);
                yPos += 5;
            }
            
            // Signatures
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Fliesen Unger S√ºd GmbH', 15, 270);
            const canvas1 = document.getElementById('signaturePad1');
            if (canvas1) {
                const sig1 = canvas1.toDataURL('image/jpeg', 0.8);
                doc.addImage(sig1, 'JPEG', 15, 275, 60, 15);
            }
            
            doc.text('Auftraggeber', 120, 270);
            const canvas2 = document.getElementById('signaturePad2');
            if (canvas2) {
                const sig2 = canvas2.toDataURL('image/jpeg', 0.8);
                doc.addImage(sig2, 'JPEG', 120, 275, 60, 15);
            }
            
            const filename = `Baustellenbericht_${rapportNr}_${baustelle.replace(/[^a-z0-9]/gi, '_')}.pdf`;
            doc.save(filename);
            
            showToast('PDF erfolgreich heruntergeladen!', 'success');
        }
        
        // ===== LISTE =====
        function loadBerichte() {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const liste = document.getElementById('berichteListe');
            
            if (berichte.length === 0) {
                liste.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">Noch keine Berichte gespeichert.</p>';
                return;
            }
            
            liste.innerHTML = '';
            
            // WICHTIG: Kopie erstellen f√ºr reverse, nicht das Original ver√§ndern
            const berichteReversed = [...berichte].reverse();
            
            berichteReversed.forEach((bericht, index) => {
                const actualIndex = berichte.length - 1 - index;
                const div = document.createElement('div');
                div.className = 'bericht-card';
                
                div.innerHTML = `
                    <h3>Rapport ${bericht.rapportNr} - ${bericht.baustelle}</h3>
                    <p style="color: #64748b; margin: 8px 0;">
                        ${bericht.projektnummer ? `<strong>Projektnummer:</strong> ${bericht.projektnummer}<br>` : ''}
                        <strong>Datum:</strong> ${bericht.datum}<br>
                        <strong>T√§tigkeiten:</strong> ${bericht.taetigkeiten.length} Eintr√§ge<br>
                        ${bericht.personal.length > 0 ? `<strong>Personal:</strong> ${bericht.personal.length} Eintr√§ge<br>` : ''}
                        ${bericht.fahrzeuge.length > 0 ? `<strong>Fahrzeuge:</strong> ${bericht.fahrzeuge.length} Eintr√§ge<br>` : ''}
                        ${bericht.photos.length > 0 ? `<strong>Fotos:</strong> ${bericht.photos.length}<br>` : ''}
                    </p>
                    <div class="bericht-actions">
                        <button class="btn btn-primary" onclick="generatePDFFromList(${actualIndex})">üìÑ PDF</button>
                        <button class="btn btn-secondary" style="background: #ef4444;" onclick="if(confirm('Wirklich l√∂schen?')) deleteBericht(${actualIndex})">üóëÔ∏è L√∂schen</button>
                    </div>
                `;
                
                liste.appendChild(div);
            });
        }
        
        function deleteBericht(index) {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            berichte.splice(index, 1);
            localStorage.setItem('baustellenberichte', JSON.stringify(berichte));
            loadBerichte();
            showToast('Bericht gel√∂scht', 'success');
        }
        
        function generatePDFFromList(index) {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const bericht = berichte[index];
            
            if (typeof window.jspdf === 'undefined') {
                alert('‚ö†Ô∏è PDF-Library wird geladen. Bitte in 2-3 Sekunden erneut versuchen.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Hilfsfunktion f√ºr automatischen Seitenumbruch
            function checkPageBreak() {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            }
            
            // Header
            doc.setFillColor(220, 38, 38);
            doc.rect(15, 15, 50, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('FLIESEN', 20, 23);
            doc.text('UNGER S√úD', 20, 28);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text('Tulpenallee 69, 71069 Sindelfingen', 150, 18);
            doc.text('Tel: 07031/9219 9-0', 150, 22);
            doc.text('info@fliesen-unger-sued.de', 150, 26);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(`RAPPORT Nr. ${bericht.rapportNr}`, 140, 40);
            
            doc.setFontSize(10);
            doc.text('Projektnummer:', 15, 50);
            doc.setFont(undefined, 'normal');
            doc.text(bericht.projektnummer || '-', 50, 50);
            
            doc.setFont(undefined, 'bold');
            doc.text('Baustelle:', 15, 56);
            doc.setFont(undefined, 'normal');
            doc.text(bericht.baustelle, 40, 56);
            
            doc.text('Datum:', 15, 62);
            doc.text(bericht.datum, 40, 62);
            
            let yPos = 71;
            
            if (bericht.taetigkeiten.length > 0) {
                checkPageBreak();
                doc.setFont(undefined, 'bold');
                doc.text('T√§tigkeiten:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bericht.taetigkeiten.forEach(t => {
                    checkPageBreak();
                    doc.text('‚Ä¢ ' + t, 20, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            if (bericht.material) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Material:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bericht.material.split('\n').forEach(line => {
                    if (line.trim()) {
                        checkPageBreak();
                        doc.text('‚Ä¢ ' + line.trim(), 20, yPos);
                        yPos += 5;
                    }
                });
                yPos += 3;
            }
            
            if (bericht.maschinen) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Maschinen:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bericht.maschinen.split('\n').forEach(line => {
                    if (line.trim()) {
                        checkPageBreak();
                        doc.text('‚Ä¢ ' + line.trim(), 20, yPos);
                        yPos += 5;
                    }
                });
                yPos += 3;
            }
            
            if (bericht.personal.length > 0) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Personal:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bericht.personal.forEach(p => {
                    checkPageBreak();
                    const anzahlText = p.anzahl > 1 ? `${p.anzahl}x ` : '';
                    doc.text(`‚Ä¢ ${anzahlText}${p.typ}: ${p.stunden}h`, 20, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            if (bericht.fahrzeuge.length > 0) {
                checkPageBreak();
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Fahrzeuge:', 15, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bericht.fahrzeuge.forEach(fz => {
                    checkPageBreak();
                    const anzahlText = fz.anzahl > 1 ? `${fz.anzahl}x ` : '';
                    doc.text(`‚Ä¢ ${anzahlText}${fz.typ}: ${fz.kennzeichen} - ${fz.km} km`, 20, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            if (bericht.gps.lat && bericht.gps.lon) {
                checkPageBreak();
                doc.setFontSize(9);
                doc.text(`GPS: ${bericht.gps.lat}, ${bericht.gps.lon}`, 15, yPos);
                yPos += 5;
            }
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Fliesen Unger S√ºd GmbH', 15, 270);
            if (bericht.signature1) {
                doc.addImage(bericht.signature1, 'JPEG', 15, 275, 60, 15);
            }
            
            doc.text('Auftraggeber', 120, 270);
            if (bericht.signature2) {
                doc.addImage(bericht.signature2, 'JPEG', 120, 275, 60, 15);
            }
            
            const filename = `Baustellenbericht_${bericht.rapportNr}_${bericht.baustelle.replace(/[^a-z0-9]/gi, '_')}.pdf`;
            doc.save(filename);
            
            showToast('PDF erfolgreich heruntergeladen!', 'success');
        }
        
        // ===== PUSH-TO-TALK SPRACHEINGABE (verbessert f√ºr lange Texte) =====
        let currentRecognition = null;
        let pttActiveTarget = null;
        let pttActiveButton = null;
        let pttIsHolding = false;  // Wird Button noch gehalten?
        let pttFullTranscript = ''; // Gesamter Text √ºber mehrere Sessions

        // Push-to-Talk: Aufnahme starten wenn Button gedr√ºckt wird
        function startPushToTalk(targetId, buttonElement) {
            // Verhindere Doppelstart
            if (currentRecognition) {
                return;
            }

            // 1. Feature Detection
            if (!window.browserCaps || !window.browserCaps.features.speechRecognition) {
                showToast('‚ö†Ô∏è Spracheingabe nicht verf√ºgbar in diesem Browser', 'error');
                return;
            }

            if (!window.browserCaps.features.isSecureContext) {
                showToast('‚ö†Ô∏è HTTPS erforderlich f√ºr Spracheingabe', 'error');
                return;
            }

            // Speichere aktive Elemente
            pttActiveTarget = targetId;
            pttActiveButton = buttonElement;
            pttIsHolding = true;
            pttFullTranscript = ''; // Reset f√ºr neue Aufnahme

            // Button visuell als "recording" markieren
            buttonElement.classList.add('recording');

            // Starte erste Recognition-Session
            startRecognitionSession(targetId);
        }

        // Separate Funktion f√ºr Recognition-Session (erm√∂glicht Auto-Neustart)
        function startRecognitionSession(targetId) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            currentRecognition = recognition;

            recognition.lang = 'de-DE';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            let sessionTranscript = '';
            let interimTranscript = '';

            recognition.onstart = function() {
                if (pttFullTranscript === '') {
                    showToast('üé§ Aufnahme l√§uft - Loslassen zum Beenden', 'success');
                }

                // Falls targetId ein Textarea ist, border √§ndern
                if (targetId !== 'taetigkeit') {
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.style.border = '3px solid #ef4444';
                        targetElement.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
                    }
                }
            };

            recognition.onresult = function(event) {
                interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        sessionTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // Live-Vorschau im Textarea (falls vorhanden)
                if (targetId !== 'taetigkeit') {
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const existingText = targetElement.dataset.originalText || '';
                        targetElement.value = existingText + (existingText ? '\n' : '') +
                            pttFullTranscript + sessionTranscript + interimTranscript;
                    }
                }
            };

            recognition.onerror = function(event) {
                // 'aborted' und 'no-speech' sind normal bei langen Pausen
                if (event.error === 'aborted' || event.error === 'no-speech') {
                    // Bei no-speech: Wenn Button noch gehalten, neu starten
                    if (pttIsHolding && event.error === 'no-speech') {
                        console.log('üîÑ Keine Sprache erkannt, starte neu...');
                        pttFullTranscript += sessionTranscript;
                        currentRecognition = null;
                        setTimeout(() => {
                            if (pttIsHolding) {
                                startRecognitionSession(targetId);
                            }
                        }, 100);
                    }
                    return;
                }

                let errorMsg = 'Spracheingabe-Fehler';

                switch(event.error) {
                    case 'audio-capture':
                        errorMsg = 'Kein Mikrofon gefunden';
                        break;
                    case 'not-allowed':
                        errorMsg = 'Mikrofon-Zugriff verweigert. Bitte Browser-Einstellungen pr√ºfen.';
                        break;
                }

                showToast(errorMsg, 'error');
                cleanupPTT();
            };

            recognition.onend = function() {
                // Sammle Text dieser Session
                const sessionText = (sessionTranscript + interimTranscript).trim();

                // Wenn Button noch gehalten wird ‚Üí Auto-Neustart
                if (pttIsHolding) {
                    console.log('üîÑ Recognition beendet, starte automatisch neu...');
                    pttFullTranscript += sessionText + ' ';
                    currentRecognition = null;

                    // Kurze Pause, dann neu starten
                    setTimeout(() => {
                        if (pttIsHolding) {
                            showToast('üé§ Weiter sprechen...', 'info');
                            startRecognitionSession(targetId);
                        }
                    }, 100);
                    return;
                }

                // Button wurde losgelassen ‚Üí Verarbeite Gesamtergebnis
                const gesamtText = (pttFullTranscript + sessionText).trim();

                if (gesamtText) {
                    if (targetId === 'taetigkeit') {
                        console.log('üé§ Spracheingabe erkannt:', gesamtText);
                        showTextVerbesserungModal(gesamtText, 'taetigkeit');
                    } else {
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            const originalText = targetElement.dataset.originalText || '';
                            if (originalText) {
                                targetElement.value = originalText + '\n' + gesamtText;
                            } else {
                                targetElement.value = gesamtText;
                            }
                            showToast('‚úÖ Text √ºbernommen', 'success');
                        }
                    }
                } else {
                    showToast('‚ö†Ô∏è Keine Sprache erkannt. Bitte erneut versuchen.', 'info');
                }

                cleanupPTT();
            };

            // Speichere originalen Text f√ºr Textarea
            if (targetId !== 'taetigkeit') {
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.dataset.originalText = targetElement.value;
                }
            }

            try {
                recognition.start();
            } catch (e) {
                showToast('Fehler beim Starten der Spracheingabe', 'error');
                cleanupPTT();
            }
        }

        // Push-to-Talk: Aufnahme stoppen wenn Button losgelassen wird
        function stopPushToTalk(targetId, buttonElement) {
            // Markiere dass Button losgelassen wurde (verhindert Auto-Neustart)
            pttIsHolding = false;

            if (currentRecognition && pttActiveTarget === targetId) {
                try {
                    currentRecognition.stop();
                } catch (e) {
                    // Ignoriere Fehler beim Stoppen
                }
            }
        }

        // Aufr√§umen nach PTT
        function cleanupPTT() {
            if (pttActiveButton) {
                pttActiveButton.classList.remove('recording');
            }

            if (pttActiveTarget && pttActiveTarget !== 'taetigkeit') {
                const targetElement = document.getElementById(pttActiveTarget);
                if (targetElement) {
                    targetElement.style.border = '';
                    targetElement.style.boxShadow = '';
                    delete targetElement.dataset.originalText;
                }
            }

            currentRecognition = null;
            pttActiveTarget = null;
            pttActiveButton = null;
            pttIsHolding = false;
            pttFullTranscript = '';
        }

        // Legacy-Funktionen f√ºr Abw√§rtskompatibilit√§t (falls irgendwo noch verwendet)
        async function addTaetigkeitViaVoice() {
            showToast('‚ÑπÔ∏è Bitte den Push-to-Talk Button gedr√ºckt halten', 'info');
        }

        async function startVoiceInput(targetId) {
            showToast('‚ÑπÔ∏è Bitte den Push-to-Talk Button gedr√ºckt halten', 'info');
        }

        // Alte startVoiceInput Funktion (wird nicht mehr verwendet, aber f√ºr Kompatibilit√§t behalten)
        async function startVoiceInputOld(targetId) {
            if (!browserCaps.features.speechRecognition) {
                showToast('‚ö†Ô∏è Spracheingabe nicht verf√ºgbar in diesem Browser', 'error');
                return;
            }

            if (!browserCaps.features.isSecureContext) {
                showToast('‚ö†Ô∏è HTTPS erforderlich f√ºr Spracheingabe. Bitte √ºber HTTPS oder localhost √∂ffnen.', 'error');
                return;
            }

            if (currentRecognition) {
                currentRecognition.stop();
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            currentRecognition = recognition;

            recognition.lang = 'de-DE';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const targetElement = document.getElementById(targetId);

            recognition.onstart = function() {
                showToast('üé§ Sprechen Sie jetzt...', 'success');
                targetElement.style.border = '2px solid #10b981';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;

                // Append to existing text with a newline if there's already content
                if (targetElement.value.trim()) {
                    targetElement.value += '\n' + transcript;
                } else {
                    targetElement.value = transcript;
                }
                
                showToast('‚úÖ Text hinzugef√ºgt', 'success');
                targetElement.style.border = '';
            };
            
            recognition.onerror = function(event) {
                let errorMsg = 'Spracheingabe-Fehler';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'Keine Sprache erkannt. Bitte erneut versuchen.';
                        break;
                    case 'audio-capture':
                        errorMsg = 'Kein Mikrofon gefunden';
                        break;
                    case 'not-allowed':
                        errorMsg = 'Mikrofon-Zugriff verweigert. Bitte in Browser-Einstellungen aktivieren.';
                        break;
                }
                
                showToast(errorMsg, 'error');
                targetElement.style.border = '';
                currentRecognition = null;
            };
            
            recognition.onend = function() {
                targetElement.style.border = '';
                currentRecognition = null;
            };
            
            try {
                recognition.start();
            } catch (e) {
                showToast('Fehler beim Starten der Spracheingabe', 'error');
                currentRecognition = null;
            }
        }
        
        function startVoiceInputHelper(targetId) {
            // Diese Funktion ist f√ºr die Helper-Section Textareas
            startVoiceInput(targetId);
        }
        
        // ===== TOAST =====
        function showToast(message, type = 'success') {
            // Entferne existierende Toasts
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            // Farbe basierend auf Typ
            if (type === 'success') toast.style.background = '#22c55e';
            else if (type === 'error') toast.style.background = '#ef4444';
            else if (type === 'info') toast.style.background = '#3b82f6';

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        
        // ===== MIKROFON PERMISSION POPUP =====
        
        // ===== PERMISSION PRIMING FUNKTIONEN =====
        // WICHTIG: navigator.permissions.query funktioniert NICHT zuverl√§ssig auf Android!
        // Daher nutzen wir direkten API-Aufruf mit Pre-Permission-Dialog
        
        // Permission Priming Modal zeigen
        function showMicrophonePermissionPriming() {
            return new Promise((resolve) => {
                const modal = document.getElementById('micPermissionModal');
                
                // Pr√ºfe ob HTTPS/localhost
                if (!browserCaps.features.isSecureContext) {
                    document.getElementById('httpsWarning').style.display = 'block';
                }
                
                modal.style.display = 'flex';
                
                // Tempor√§re Event Listener
                const allowBtn = modal.querySelector('.mic-modal-allow');
                const laterBtn = modal.querySelector('.mic-modal-later');
                
                const handleAllow = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(true); // User akzeptiert
                };
                
                const handleDecline = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false); // User lehnt ab
                };
                
                const cleanup = () => {
                    allowBtn.removeEventListener('click', handleAllow);
                    laterBtn.removeEventListener('click', handleDecline);
                };
                
                allowBtn.addEventListener('click', handleAllow);
                laterBtn.addEventListener('click', handleDecline);
            });
        }
        
        function closeMicModal() {
            const modal = document.getElementById('micPermissionModal');
            modal.style.display = 'none';
        }
        
        async function allowMicrophone() {
            closeMicModal();
            
            if (!browserCaps.features.getUserMedia) {
                showToast('‚ùå Mikrofon nicht unterst√ºtzt in diesem Browser', 'error');
                return;
            }
            
            if (!browserCaps.features.isSecureContext) {
                showToast('‚ö†Ô∏è HTTPS erforderlich f√ºr Mikrofon-Zugriff', 'error');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Stoppe Stream sofort (wir brauchen nur Permission)
                stream.getTracks().forEach(track => track.stop());
                showToast('‚úÖ Mikrofon-Zugriff erlaubt!', 'success');
            } catch (err) {
                console.error('Mikrofon-Fehler:', err);
                
                let errorMsg = '‚ùå Mikrofon-Zugriff verweigert';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg = '‚ùå Mikrofon-Zugriff verweigert. Bitte in Browser-Einstellungen aktivieren:\n\nChrome: Einstellungen ‚Üí Datenschutz ‚Üí Website-Einstellungen ‚Üí Mikrofon';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = '‚ùå Kein Mikrofon gefunden. Bitte Mikrofon anschlie√üen.';
                } else if (err.name === 'NotReadableError') {
                    errorMsg = '‚ùå Mikrofon wird bereits verwendet. Bitte andere Apps schlie√üen.';
                } else if (err.name === 'SecurityError') {
                    errorMsg = '‚ö†Ô∏è HTTPS erforderlich! Mikrofon funktioniert nur √ºber HTTPS.';
                }
                
                showToast(errorMsg, 'error');
            }
        }
        
        // ===== HTTPS STARTUP CHECK =====
        window.addEventListener('load', () => {
            // Pr√ºfe ob sicherer Kontext
            if (!window.isSecureContext) {
                const protocol = window.location.protocol;
                const hostname = window.location.hostname;
                
                console.warn('‚ö†Ô∏è UNSICHERER KONTEXT!', protocol + '//' + hostname);
                
                // Zeige Setup-Modal
                showSetupModal();
                
                // Zeige gro√üe Warnung
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #dc2626;
                    color: white;
                    padding: 15px;
                    z-index: 99998;
                    text-align: center;
                    font-weight: bold;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                `;
                warningDiv.innerHTML = `
                    ‚ö†Ô∏è HTTPS ERFORDERLICH!<br>
                    <small>Mikrofon, GPS und Kamera funktionieren nur √ºber HTTPS oder file://</small>
                `;
                document.body.insertBefore(warningDiv, document.body.firstChild);
                
                showToast('‚ö†Ô∏è Diese App ben√∂tigt HTTPS! Bitte Setup-Assistent √∂ffnen.', 'error');
            } else {
                console.log('‚úÖ Sicherer Kontext erkannt:', window.location.protocol);
            }
            
            // Service Worker registrieren (f√ºr PWA und Offline-Funktionalit√§t)
            // Nur auf eigenem Server versuchen (nicht auf Test-Domains)
            const hostname = window.location.hostname;
            const isTestDomain = hostname.includes('claudeusercontent.com') || 
                                hostname.includes('github.io') ||
                                hostname === '' ||
                                window.location.protocol === 'about:';
            
            if ('serviceWorker' in navigator && window.isSecureContext && !isTestDomain) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registriert:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ÑπÔ∏è Service Worker nicht verf√ºgbar (optional)');
                        // Kein Fehler anzeigen - optional Feature
                    });
                
                // PWA Install-Prompt Event
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    console.log('‚úÖ PWA kann installiert werden!');
                    
                    // Optional: Install-Button anzeigen
                    // showToast('üí° Tipp: Diese App kann auf dem Home-Screen installiert werden!', 'info');
                });
                
                window.addEventListener('appinstalled', () => {
                    console.log('‚úÖ PWA wurde auf dem Home-Screen installiert!');
                    deferredPrompt = null;
                });
            }
        });
        
        // ===== SETUP ASSISTANT FUNCTIONS =====
        let detectedLocalIP = null;
        
        function showSetupModal() {
            const modal = document.getElementById('setupModal');
            modal.classList.remove('hidden');
            
            // Zeige aktuelle URL
            document.getElementById('setupCurrentUrl').textContent = 
                `Aktuelle URL: ${window.location.protocol}//${window.location.host}`;
            
            // Erkenne lokale IP
            detectLocalIP();
        }
        
        function minimizeSetup() {
            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('setupReopenBtn').classList.remove('hidden');
        }
        
        function reopenSetup() {
            document.getElementById('setupModal').classList.remove('hidden');
            document.getElementById('setupReopenBtn').classList.add('hidden');
        }
        
        function showSetupTab(tabName) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.setup-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.setup-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Aktiven Tab aktivieren
            event.target.classList.add('active');
            document.getElementById('setup-' + tabName).classList.add('active');
        }
        
        async function detectLocalIP() {
            try {
                // Methode 1: WebRTC
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (ice) => {
                    if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                    
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                    const ipMatch = ipRegex.exec(ice.candidate.candidate);
                    
                    if (ipMatch && ipMatch[1]) {
                        const ip = ipMatch[1];
                        // Nur lokale IPs (192.168.x.x oder 10.x.x.x)
                        if (ip.startsWith('192.168.') || ip.startsWith('10.')) {
                            detectedLocalIP = ip;
                            updateIPDisplay(ip);
                            pc.close();
                        }
                    }
                };
                
                // Fallback nach 3 Sekunden
                setTimeout(() => {
                    if (!detectedLocalIP) {
                        updateIPDisplay('192.168.1.100');
                        showToast('‚ÑπÔ∏è IP konnte nicht automatisch erkannt werden. Bitte manuell pr√ºfen!', 'info');
                    }
                }, 3000);
                
            } catch (error) {
                console.error('IP-Erkennung fehlgeschlagen:', error);
                updateIPDisplay('192.168.1.100');
            }
        }
        
        function updateIPDisplay(ip) {
            // Aktualisiere alle IP-Anzeigen
            document.getElementById('detectedIP').textContent = ip;
            if (document.getElementById('detectedIP-mac')) {
                document.getElementById('detectedIP-mac').textContent = ip;
            }
            if (document.getElementById('detectedIP-linux')) {
                document.getElementById('detectedIP-linux').textContent = ip;
            }
            
            // Aktualisiere mkcert-Befehle
            const mkcertCmd = `mkcert localhost ${ip} 127.0.0.1 ::1`;
            document.getElementById('mkcertCommand').innerHTML = 
                mkcertCmd + `<button class="setup-copy-btn" onclick="copyToClipboard(this, '${mkcertCmd}')">üìã Kopieren</button>`;
            
            if (document.getElementById('mkcertCommandMac')) {
                document.getElementById('mkcertCommandMac').innerHTML = 
                    mkcertCmd + `<button class="setup-copy-btn" onclick="copyToClipboard(this, '${mkcertCmd}')">üìã Kopieren</button>`;
            }
            if (document.getElementById('mkcertCommandLinux')) {
                document.getElementById('mkcertCommandLinux').innerHTML = 
                    mkcertCmd + `<button class="setup-copy-btn" onclick="copyToClipboard(this, '${mkcertCmd}')">üìã Kopieren</button>`;
            }
            
            // Aktualisiere Android-URL
            const androidUrl = `https://${ip}:8000/baustellenbericht_v1_10.html`;
            document.getElementById('androidURL').textContent = androidUrl;
        }
        
        async function copyToClipboard(button, text) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.textContent;
                button.textContent = '‚úÖ Kopiert!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
                showToast('üìã In Zwischenablage kopiert!', 'success');
            } catch (error) {
                console.error('Kopieren fehlgeschlagen:', error);
                showToast('‚ùå Kopieren fehlgeschlagen. Bitte manuell kopieren.', 'error');
            }
        }
        
        function generateQRCode() {
            const ip = detectedLocalIP || '192.168.1.100';
            const url = `https://${ip}:8000/baustellenbericht_v1_10.html`;
            
            // Nutze Google Charts API f√ºr QR-Code
            const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(url)}`;
            
            const qrContainer = document.getElementById('qrCodeContainer');
            const qrCode = document.getElementById('qrCode');
            
            qrCode.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
            qrContainer.classList.remove('hidden');
            
            showToast('üì∑ QR-Code generiert! Jetzt mit Android-Kamera scannen.', 'success');
        }
        
        function testConnection() {
            const ip = detectedLocalIP || '192.168.1.100';
            const testUrl = `https://${ip}:8000`;
            
            showToast('üì∑ Teste Verbindung zu ' + testUrl + ' ...', 'info');
            
            // √ñffne in neuem Tab
            window.open(testUrl, '_blank');
            
            setTimeout(() => {
                if (confirm('Hat die Verbindung funktioniert? (Keine Sicherheitswarnung?)')) {
                    showToast('üéâ Perfekt! Das Setup funktioniert!', 'success');
                    minimizeSetup();
                } else {
                    showToast('‚ùå Bitte folge den Setup-Schritten nochmal genau.', 'error');
                }
            }, 3000);
        }
    </script>
    
    <!-- SETUP ASSISTANT MODAL -->
    <div id="setupModal" class="setup-modal hidden">
        <div class="setup-content">
            <div class="setup-header">
                <button class="setup-minimize-btn" onclick="minimizeSetup()">‚àí</button>
                <h2>üîí HTTPS Setup-Assistent</h2>
                <p>Mikrofon, GPS und Kamera ben√∂tigen HTTPS</p>
            </div>
            
            <div class="setup-body">
                <!-- Warnung -->
                <div class="setup-warning">
                    <strong>‚ö†Ô∏è Aktuelle Verbindung: UNSICHER</strong>
                    <span id="setupCurrentUrl"></span>
                </div>
                
                <!-- OS Tabs -->
                <div class="setup-tabs">
                    <button class="setup-tab active" onclick="showSetupTab('windows')">Windows</button>
                    <button class="setup-tab" onclick="showSetupTab('mac')">macOS</button>
                    <button class="setup-tab" onclick="showSetupTab('linux')">Linux</button>
                    <button class="setup-tab" onclick="showSetupTab('quick')">Schnelle Alternative</button>
                </div>
                
                <!-- WINDOWS TAB -->
                <div id="setup-windows" class="setup-tab-content active">
                    <!-- Schritt 1 -->
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">1</div>
                            <div class="setup-step-title">mkcert installieren</div>
                        </div>
                        <div class="setup-step-content">
                            <p>PowerShell als Administrator √∂ffnen und ausf√ºhren:</p>
                            <div class="setup-command">choco install mkcert<button class="setup-copy-btn" onclick="copyToClipboard(this, 'choco install mkcert')">üìã Kopieren</button></div>
                            <div class="setup-info">
                                üí° <strong>Kein Chocolatey?</strong> Download: <a href="https://github.com/FiloSottile/mkcert/releases" target="_blank">github.com/FiloSottile/mkcert</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schritt 2 -->
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">2</div>
                            <div class="setup-step-title">Zertifikate erstellen</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">mkcert -install<button class="setup-copy-btn" onclick="copyToClipboard(this, 'mkcert -install')">üìã Kopieren</button></div>
                            <p style="margin: 15px 0;">Deine lokale IP-Adresse:</p>
                            <div class="setup-ip-box">
                                <strong>üìç Deine IP (automatisch erkannt):</strong>
                                <div class="ip-address" id="detectedIP">Wird erkannt...</div>
                            </div>
                            <p style="margin: 10px 0;">Zertifikat erstellen (mit deiner IP):</p>
                            <div class="setup-command" id="mkcertCommand">mkcert localhost 192.168.1.100 127.0.0.1 ::1<button class="setup-copy-btn" onclick="copyToClipboard(this, document.getElementById('mkcertCommand').textContent.trim())">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <!-- Schritt 3 -->
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">3</div>
                            <div class="setup-step-title">HTTPS-Server starten</div>
                        </div>
                        <div class="setup-step-content">
                            <p>http-server installieren (einmalig):</p>
                            <div class="setup-command">npm install -g http-server<button class="setup-copy-btn" onclick="copyToClipboard(this, 'npm install -g http-server')">üìã Kopieren</button></div>
                            <p style="margin: 15px 0;">Server starten (im Projekt-Ordner):</p>
                            <div class="setup-command">http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1<button class="setup-copy-btn" onclick="copyToClipboard(this, 'http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1')">üìã Kopieren</button></div>
                            <p style="margin: 15px 0;">Firewall-Regel hinzuf√ºgen:</p>
                            <div class="setup-command">netsh advfirewall firewall add rule name="HTTP Server 8000" dir=in action=allow protocol=TCP localport=8000<button class="setup-copy-btn" onclick="copyToClipboard(this, 'netsh advfirewall firewall add rule name=\"HTTP Server 8000\" dir=in action=allow protocol=TCP localport=8000')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <!-- Schritt 4 -->
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">4</div>
                            <div class="setup-step-title">Auf Android installieren</div>
                        </div>
                        <div class="setup-step-content">
                            <p>Root-CA auf Android √ºbertragen:</p>
                            <div class="setup-command">mkcert -CAROOT<button class="setup-copy-btn" onclick="copyToClipboard(this, 'mkcert -CAROOT')">üìã Kopieren</button></div>
                            <div class="setup-info">
                                <strong>Datei rootCA.pem finden und per USB/Email/Cloud auf Android √ºbertragen</strong><br>
                                Dann: Einstellungen ‚Üí Sicherheit ‚Üí Verschl√ºsselung & Anmeldedaten ‚Üí CA-Zertifikat installieren
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schritt 5 -->
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">5</div>
                            <div class="setup-step-title">Auf Android √∂ffnen</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-ip-box">
                                <strong>üì± √ñffne auf Android:</strong>
                                <div class="ip-address" id="androidURL">https://192.168.1.100:8000</div>
                            </div>
                            <div id="qrCodeContainer" class="setup-qr hidden">
                                <p><strong>üì∑ QR-Code scannen:</strong></p>
                                <div id="qrCode"></div>
                            </div>
                            <button class="setup-btn setup-btn-primary" onclick="generateQRCode()" style="width: 100%;">
                                üì∑ QR-Code generieren
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- MAC TAB -->
                <div id="setup-mac" class="setup-tab-content">
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">1</div>
                            <div class="setup-step-title">mkcert installieren</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">brew install mkcert<button class="setup-copy-btn" onclick="copyToClipboard(this, 'brew install mkcert')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">2</div>
                            <div class="setup-step-title">IP-Adresse herausfinden</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">ifconfig | grep "inet "<button class="setup-copy-btn" onclick="copyToClipboard(this, 'ifconfig | grep \"inet \"')">üìã Kopieren</button></div>
                            <div class="setup-ip-box">
                                <strong>üìç Automatisch erkannt:</strong>
                                <div class="ip-address" id="detectedIP-mac">Wird erkannt...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">3</div>
                            <div class="setup-step-title">Zertifikate erstellen</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">mkcert -install<button class="setup-copy-btn" onclick="copyToClipboard(this, 'mkcert -install')">üìã Kopieren</button></div>
                            <div class="setup-command" id="mkcertCommandMac">mkcert localhost 192.168.1.100 127.0.0.1 ::1<button class="setup-copy-btn" onclick="copyToClipboard(this, document.getElementById('mkcertCommandMac').textContent.trim())">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">4</div>
                            <div class="setup-step-title">Server starten</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">npm install -g http-server<button class="setup-copy-btn" onclick="copyToClipboard(this, 'npm install -g http-server')">üìã Kopieren</button></div>
                            <div class="setup-command">http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1<button class="setup-copy-btn" onclick="copyToClipboard(this, 'http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 20px;"><strong>Dann Schritte 4-5 von Windows-Tab folgen f√ºr Android-Installation</strong></p>
                </div>
                
                <!-- LINUX TAB -->
                <div id="setup-linux" class="setup-tab-content">
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">1</div>
                            <div class="setup-step-title">mkcert installieren</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">sudo apt install libnss3-tools
wget https://github.com/FiloSottile/mkcert/releases/latest/download/mkcert-v1.4.4-linux-amd64
chmod +x mkcert-v1.4.4-linux-amd64
sudo mv mkcert-v1.4.4-linux-amd64 /usr/local/bin/mkcert<button class="setup-copy-btn" onclick="copyToClipboard(this, 'sudo apt install libnss3-tools\nwget https://github.com/FiloSottile/mkcert/releases/latest/download/mkcert-v1.4.4-linux-amd64\nchmod +x mkcert-v1.4.4-linux-amd64\nsudo mv mkcert-v1.4.4-linux-amd64 /usr/local/bin/mkcert')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">2</div>
                            <div class="setup-step-title">IP-Adresse herausfinden</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">hostname -I<button class="setup-copy-btn" onclick="copyToClipboard(this, 'hostname -I')">üìã Kopieren</button></div>
                            <div class="setup-ip-box">
                                <strong>üìç Automatisch erkannt:</strong>
                                <div class="ip-address" id="detectedIP-linux">Wird erkannt...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">3</div>
                            <div class="setup-step-title">Zertifikate erstellen</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">mkcert -install<button class="setup-copy-btn" onclick="copyToClipboard(this, 'mkcert -install')">üìã Kopieren</button></div>
                            <div class="setup-command" id="mkcertCommandLinux">mkcert localhost 192.168.1.100 127.0.0.1 ::1<button class="setup-copy-btn" onclick="copyToClipboard(this, document.getElementById('mkcertCommandLinux').textContent.trim())">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">4</div>
                            <div class="setup-step-title">Server starten</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">npm install -g http-server<button class="setup-copy-btn" onclick="copyToClipboard(this, 'npm install -g http-server')">üìã Kopieren</button></div>
                            <div class="setup-command">http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1<button class="setup-copy-btn" onclick="copyToClipboard(this, 'http-server -S -C localhost+3.pem -K localhost+3-key.pem -p 8000 -c-1')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 20px;"><strong>Dann Schritte 4-5 von Windows-Tab folgen f√ºr Android-Installation</strong></p>
                </div>
                
                <!-- QUICK TAB -->
                <div id="setup-quick" class="setup-tab-content">
                    <div class="setup-file-note">
                        <strong>üí° Schnellste L√∂sung: file:// Protokoll</strong><br>
                        Die App kann auch direkt vom Ger√§t-Speicher ge√∂ffnet werden!
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">1</div>
                            <div class="setup-step-title">Datei auf Android √ºbertragen</div>
                        </div>
                        <div class="setup-step-content">
                            <p>√úbertrage <code>baustellenbericht_v1_10.html</code> auf dein Android-Ger√§t:</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Per USB-Kabel in Download-Ordner</li>
                                <li>Per Email als Anhang</li>
                                <li>Via Google Drive / Dropbox</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">2</div>
                            <div class="setup-step-title">Datei √∂ffnen</div>
                        </div>
                        <div class="setup-step-content">
                            <p>√ñffne die Datei in Chrome:</p>
                            <div class="setup-info">
                                Datei-Manager ‚Üí Downloads ‚Üí baustellenbericht_v1_10.html ‚Üí Mit Chrome √∂ffnen
                            </div>
                            <div class="setup-success">
                                ‚úÖ Mikrofon, GPS und Kamera funktionieren √ºber file://!
                            </div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">3</div>
                            <div class="setup-step-title">Einschr√§nkungen beachten</div>
                        </div>
                        <div class="setup-step-content">
                            <p>‚ö†Ô∏è √úber file:// funktioniert NICHT:</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Service Worker (Offline-Modus)</li>
                                <li>PWA-Installation</li>
                                <li>Einige Browser-Caching-Features</li>
                            </ul>
                            <p><strong>Aber:</strong> Alle Hauptfunktionen (Mikrofon, GPS, Kamera, PDF-Export) funktionieren! ‚úÖ</p>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0;">
                    
                    <div class="setup-file-note" style="background: #e0f2fe; border-color: #0ea5e9;">
                        <strong>üöÄ Alternative: ngrok (f√ºr schnelles Testing)</strong><br>
                        Kein mkcert-Setup n√∂tig, funktioniert sofort!
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">A</div>
                            <div class="setup-step-title">ngrok installieren</div>
                        </div>
                        <div class="setup-step-content">
                            <p>Download: <a href="https://ngrok.com/download" target="_blank">ngrok.com/download</a></p>
                            <div class="setup-command">ngrok authtoken DEIN_TOKEN<button class="setup-copy-btn" onclick="copyToClipboard(this, 'ngrok authtoken DEIN_TOKEN')">üìã Kopieren</button></div>
                        </div>
                    </div>
                    
                    <div class="setup-step">
                        <div class="setup-step-header">
                            <div class="setup-step-number">B</div>
                            <div class="setup-step-title">Server starten</div>
                        </div>
                        <div class="setup-step-content">
                            <div class="setup-command">python -m http.server 8000<button class="setup-copy-btn" onclick="copyToClipboard(this, 'python -m http.server 8000')">üìã Kopieren</button></div>
                            <p style="margin: 10px 0;">In anderem Terminal:</p>
                            <div class="setup-command">ngrok http 8000<button class="setup-copy-btn" onclick="copyToClipboard(this, 'ngrok http 8000')">üìã Kopieren</button></div>
                            <div class="setup-success">
                                ‚úÖ ngrok gibt dir eine https:// URL die von √ºberall funktioniert!
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="setup-actions">
                    <button class="setup-btn setup-btn-secondary" onclick="minimizeSetup()">Sp√§ter einrichten</button>
                    <button class="setup-btn setup-btn-primary" onclick="testConnection()">‚úÖ Verbindung testen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- REOPEN BUTTON -->
    <button id="setupReopenBtn" class="setup-reopen-btn hidden" onclick="reopenSetup()">
        ‚ö†Ô∏è HTTPS Setup
    </button>
    
    <!-- v1.15: QR-SCANNER OVERLAY -->
    <div id="qrScannerOverlay" class="qr-scanner-overlay" style="display: none;">
        <div class="scanner-header">
            <div class="scanner-title">üì∑ QR-Code Scanner</div>
            <div class="scanner-instructions">Halte den QR-Code in den gr√ºnen Rahmen</div>
        </div>
        <div class="scanner-video-container">
            <video id="qrVideo" autoplay playsinline></video>
            <canvas id="qrCanvas" style="display: none;"></canvas>
            <div class="scanner-target-box">
                <div class="scanner-corners">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>
            </div>
        </div>
        <div id="scannerStatus" class="scanner-status">üì∑ Suche nach QR-Code...</div>
        <div class="scanner-buttons">
            <button class="btn-scanner btn-scanner-close" onclick="stopQRScanner()">‚ùå Abbrechen</button>
        </div>
    </div>
    
    <!-- v1.14/v1.15: HTTPS SETUP MODAL -->
    <div id="httpsSetupModal" class="https-setup-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîí HTTPS SETUP-ANLEITUNG</div>
                <div class="modal-subtitle">GPS & Spracheingabe auf Android Chrome aktivieren</div>
            </div>
            <div class="modal-body">
                <!-- ANDROID QUICK FIX -->
                <div class="setup-section">
                    <div class="setup-section-title">
                        üì± F√úR ANDROID: SCHNELLSTE L√ñSUNG
                        <span class="setup-section-time">‚ö° 1 Minute</span>
                    </div>
                    <div class="setup-steps">
                        <div class="setup-step">
                            <span class="setup-step-number">1</span>
                            App-Datei auf Handy √ºbertragen (USB, WhatsApp, etc.)
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">2</span>
                            Mit Chrome √∂ffnen: <code>file:///storage/emulated/0/Download/baustellenbericht_v1_15.html</code>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">3</span>
                            ‚úÖ GPS & Sprache funktionieren sofort!
                        </div>
                    </div>
                    <div class="setup-note">
                        <strong>üí° Tipp:</strong> Lesezeichen erstellen f√ºr schnellen Zugriff!
                    </div>
                </div>
                
                <!-- NGROK -->
                <div class="setup-section">
                    <div class="setup-section-title">
                        üöÄ OPTION 1: NGROK
                        <span class="setup-section-time">‚è±Ô∏è 5 Minuten</span>
                    </div>
                    <div class="setup-steps">
                        <div class="setup-step">
                            <span class="setup-step-number">1</span>
                            ngrok installieren: <a href="https://ngrok.com/download" target="_blank">https://ngrok.com/download</a>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">2</span>
                            Python-Server starten:
                            <div class="setup-code">python -m http.server 8000</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">3</span>
                            ngrok starten (neues Terminal):
                            <div class="setup-code">ngrok http 8000</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">4</span>
                            URL am Handy √∂ffnen: <code>https://abc123.ngrok-free.app/baustellenbericht_v1_15.html</code>
                        </div>
                    </div>
                    <div class="setup-note">
                        <strong>‚úÖ Vorteil:</strong> Sofort verf√ºgbar, keine Account-Erstellung n√∂tig
                    </div>
                </div>
                
                <!-- GITHUB PAGES -->
                <div class="setup-section">
                    <div class="setup-section-title">
                        üì¶ OPTION 2: GITHUB PAGES
                        <span class="setup-section-time">‚è±Ô∏è 10 Minuten</span>
                    </div>
                    <div class="setup-steps">
                        <div class="setup-step">
                            <span class="setup-step-number">1</span>
                            GitHub Account erstellen (kostenlos): <a href="https://github.com" target="_blank">github.com</a>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">2</span>
                            Neues Repository: "baustellenbericht"
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">3</span>
                            Datei hochladen (baustellenbericht_v1_15.html)
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">4</span>
                            Settings ‚Üí Pages ‚Üí Source: main branch ‚Üí Save
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">5</span>
                            URL: <code>https://DEIN-USERNAME.github.io/baustellenbericht/</code>
                        </div>
                    </div>
                    <div class="setup-note">
                        <strong>‚úÖ Vorteil:</strong> Permanent verf√ºgbar, kostenlos, keine laufenden Kosten
                    </div>
                </div>
                
                <!-- MKCERT -->
                <div class="setup-section">
                    <div class="setup-section-title">
                        ‚öô OPTION 3: MKCERT (F√úR ENTWICKLUNG)
                        <span class="setup-section-time">‚è±Ô∏è 15 Minuten</span>
                    </div>
                    <div class="setup-steps">
                        <div class="setup-step">
                            <span class="setup-step-number">1</span>
                            mkcert installieren:
                            <div class="setup-code"># Windows
choco install mkcert

# Mac
brew install mkcert</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">2</span>
                            Root CA installieren:
                            <div class="setup-code">mkcert -install</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">3</span>
                            Zertifikat erstellen:
                            <div class="setup-code">mkcert localhost 127.0.0.1 192.168.1.XXX</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">4</span>
                            HTTPS-Server starten:
                            <div class="setup-code">python -m http.server 8000 \
  --cert localhost+2.pem \
  --key localhost+2-key.pem</div>
                        </div>
                        <div class="setup-step">
                            <span class="setup-step-number">5</span>
                            √ñffnen: <code>https://192.168.1.XXX:8000</code>
                        </div>
                    </div>
                    <div class="setup-note">
                        <strong>‚ö†Ô∏è Hinweis:</strong> Nur f√ºr lokale Entwicklung, Zertifikat auf Handy installieren n√∂tig
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-close" onclick="closeHTTPSSetupModal()">Schlie√üen</button>
            </div>
        </div>
    </div>
    
    <!-- ===== v2.0: CAPACITOR NATIVE APP INTEGRATION ===== -->
    <script>
        // ===== v2.0: CAPACITOR INTEGRATION =====
        // Dieser Block erweitert die bestehenden Funktionen f√ºr Native-App-Nutzung
        
        (function() {
            'use strict';
            
            // Warte auf DOM und pr√ºfe dann Capacitor
            document.addEventListener('DOMContentLoaded', function() {
                // Timeout um sicherzustellen dass Capacitor geladen ist
                setTimeout(initCapacitorFeatures, 500);
            });
            
            async function initCapacitorFeatures() {
                const isNative = typeof window.Capacitor !== 'undefined' && 
                                 window.Capacitor.isNativePlatform && 
                                 window.Capacitor.isNativePlatform();
                
                console.log('üöÄ v2.0 Capacitor Init:', isNative ? 'NATIVE APP' : 'BROWSER');
                
                if (!isNative) {
                    // Browser-Modus: Zeige Status-Banner wenn nicht sicher
                    showBrowserStatusBanner();
                    return;
                }
                
                // === NATIVE APP MODUS ===
                console.log('üì± Native App erkannt - Aktiviere erweiterte Features');
                
                // Status-Banner aktualisieren
                showNativeAppBanner();
                
                // Alle Berechtigungen automatisch anfordern
                await requestAllPermissions();
            }
            
            // === BROWSER STATUS BANNER ===
            function showBrowserStatusBanner() {
                // Fallback falls browserCaps nicht verf√ºgbar
                if (!window.browserCaps) {
                    console.log('‚ö†Ô∏è browserCaps nicht verf√ºgbar, pr√ºfe isSecureContext direkt');
                    if (window.isSecureContext) {
                        console.log('‚úÖ Sicherer Kontext - alle Features verf√ºgbar');
                        return;
                    }
                    // Ohne browserCaps kein Banner erstellen (verhindert Fehler)
                    return;
                }

                const protocol = window.browserCaps.protocol;

                // Nur Banner zeigen wenn nicht sicher
                if (protocol.secure) {
                    console.log('‚úÖ Sicherer Kontext - alle Features verf√ºgbar');
                    return;
                }
                
                // Warning Banner erstellen
                const banner = document.createElement('div');
                banner.id = 'v2StatusBanner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                
                banner.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto;">
                        <strong>${protocol.icon} ${protocol.name}</strong>
                        <span style="margin-left: 10px;">${protocol.message}</span>
                        ${protocol.solution ? `<br><span style="font-size: 12px; opacity: 0.9;">${protocol.solution}</span>` : ''}
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; color: white; font-size: 20px; cursor: pointer;">
                            ‚úï
                        </button>
                    </div>
                `;
                
                document.body.insertBefore(banner, document.body.firstChild);
                
                // Body-Padding anpassen
                document.body.style.paddingTop = (banner.offsetHeight + 20) + 'px';
            }
            
            // === NATIVE APP BANNER ===
            function showNativeAppBanner() {
                const banner = document.createElement('div');
                banner.id = 'v2StatusBanner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 8px 20px;
                    text-align: center;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                `;
                
                banner.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto;">
                        <strong>üì± Native App</strong>
                        <span style="margin-left: 10px;">‚úÖ Alle Funktionen verf√ºgbar!</span>
                        <button onclick="this.parentElement.parentElement.style.display='none'; document.body.style.paddingTop='20px';" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; color: white; font-size: 16px; cursor: pointer;">
                            ‚úï
                        </button>
                    </div>
                `;
                
                document.body.insertBefore(banner, document.body.firstChild);
                document.body.style.paddingTop = (banner.offsetHeight + 20) + 'px';
                
                // Auto-hide nach 3 Sekunden
                setTimeout(() => {
                    if (banner.parentElement) {
                        banner.style.transition = 'opacity 0.5s';
                        banner.style.opacity = '0';
                        setTimeout(() => {
                            banner.remove();
                            document.body.style.paddingTop = '20px';
                        }, 500);
                    }
                }, 3000);
            }
            
            // === ALLE BERECHTIGUNGEN ANFORDERN ===
            async function requestAllPermissions() {
                console.log('üîê Fordere alle Berechtigungen an...');
                
                const results = {
                    gps: 'pending',
                    camera: 'pending',
                    microphone: 'pending'
                };
                
                // GPS Permission
                if (window.Capacitor.Plugins.Geolocation) {
                    try {
                        const gpsStatus = await window.Capacitor.Plugins.Geolocation.requestPermissions();
                        results.gps = gpsStatus.location;
                        console.log('üìç GPS Permission:', results.gps);
                    } catch (e) {
                        console.error('GPS Permission Error:', e);
                        results.gps = 'error';
                    }
                }
                
                // Camera Permission (wenn Plugin verf√ºgbar)
                if (window.Capacitor.Plugins.Camera) {
                    try {
                        const camStatus = await window.Capacitor.Plugins.Camera.requestPermissions();
                        results.camera = camStatus.camera;
                        console.log('üì∑ Camera Permission:', results.camera);
                    } catch (e) {
                        console.error('Camera Permission Error:', e);
                        results.camera = 'error';
                    }
                }
                
                // Speech Recognition Permission (Community Plugin)
                if (window.Capacitor.Plugins.SpeechRecognition) {
                    try {
                        const speechStatus = await window.Capacitor.Plugins.SpeechRecognition.requestPermissions();
                        results.microphone = speechStatus.speechRecognition;
                        console.log('üé§ Speech Permission:', results.microphone);
                    } catch (e) {
                        console.error('Speech Permission Error:', e);
                        results.microphone = 'error';
                    }
                }
                
                console.log('üîê Permission Results:', results);
                
                // Zeige Toast mit Ergebnis
                const granted = Object.values(results).filter(r => r === 'granted').length;
                const total = Object.values(results).filter(r => r !== 'pending').length;
                
                if (granted === total && total > 0) {
                    showToast(`‚úÖ Alle ${granted} Berechtigungen erteilt!`, 'success');
                } else if (granted > 0) {
                    showToast(`‚ö†Ô∏è ${granted}/${total} Berechtigungen erteilt`, 'info');
                }
                
                return results;
            }
            
            // === NATIVE GPS FUNKTION (Override) ===
            // Diese Funktion wird aufgerufen wenn Capacitor GPS Plugin verf√ºgbar ist
            window.getGPSNative = async function() {
                if (!window.Capacitor || !window.Capacitor.Plugins.Geolocation) {
                    console.log('‚ùå Capacitor Geolocation Plugin nicht verf√ºgbar');
                    return null;
                }
                
                try {
                    // Permission anfordern falls noch nicht erteilt
                    await window.Capacitor.Plugins.Geolocation.requestPermissions();
                    
                    // Position holen
                    const position = await window.Capacitor.Plugins.Geolocation.getCurrentPosition({
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    });
                    
                    return {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        source: 'native'
                    };
                } catch (error) {
                    console.error('‚ùå Native GPS Error:', error);
                    return null;
                }
            };
            
            // === NATIVE SPEECH RECOGNITION (Override) ===
            window.startSpeechNative = async function(callback) {
                if (!window.Capacitor || !window.Capacitor.Plugins.SpeechRecognition) {
                    console.log('‚ùå Capacitor Speech Recognition Plugin nicht verf√ºgbar');
                    return false;
                }
                
                try {
                    // Permission anfordern
                    const permStatus = await window.Capacitor.Plugins.SpeechRecognition.requestPermissions();
                    
                    if (permStatus.speechRecognition !== 'granted') {
                        showToast('‚ö†Ô∏è Mikrofon-Berechtigung ben√∂tigt', 'error');
                        return false;
                    }
                    
                    // Verf√ºgbarkeit pr√ºfen
                    const available = await window.Capacitor.Plugins.SpeechRecognition.available();
                    if (!available.available) {
                        showToast('‚ö†Ô∏è Spracherkennung nicht verf√ºgbar auf diesem Ger√§t', 'error');
                        return false;
                    }
                    
                    showToast('üé§ Sprechen Sie jetzt...', 'success');
                    
                    // Listener f√ºr Ergebnisse
                    await window.Capacitor.Plugins.SpeechRecognition.addListener('partialResults', (data) => {
                        if (data.matches && data.matches.length > 0) {
                            callback(data.matches[0]);
                        }
                    });
                    
                    // Starten
                    await window.Capacitor.Plugins.SpeechRecognition.start({
                        language: 'de-DE',
                        maxResults: 1,
                        popup: false,
                        partialResults: true
                    });
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Native Speech Error:', error);
                    showToast('‚ùå Spracherkennung fehlgeschlagen', 'error');
                    return false;
                }
            };
            
            window.stopSpeechNative = async function() {
                if (window.Capacitor && window.Capacitor.Plugins.SpeechRecognition) {
                    try {
                        await window.Capacitor.Plugins.SpeechRecognition.stop();
                    } catch (e) {
                        console.log('Speech stop error:', e);
                    }
                }
            };
            
            // === DEBUG INFO UPDATE ===
            // Aktualisiere Debug-Box f√ºr v2.0
            function updateDebugInfoV2() {
                const debugBox = document.getElementById('debugInfoBox');
                if (!debugBox) return;

                // Fallback falls browserCaps nicht verf√ºgbar
                if (!window.browserCaps) return;

                const isNative = window.browserCaps.isNativeApp;
                const protocol = window.browserCaps.protocol;
                
                // Finde die Debug-Elemente und aktualisiere sie
                const gpsEl = document.getElementById('debugGPS');
                const speechEl = document.getElementById('debugSpeech');
                
                if (isNative) {
                    if (gpsEl) gpsEl.textContent = '‚úÖ (Native)';
                    if (speechEl) speechEl.textContent = '‚úÖ (Native)';
                } else if (protocol.secure) {
                    if (gpsEl) gpsEl.textContent = '‚úÖ';
                    if (speechEl) speechEl.textContent = '‚úÖ';
                } else {
                    if (gpsEl) gpsEl.textContent = '‚ö†Ô∏è blockiert';
                    if (speechEl) speechEl.textContent = '‚ö†Ô∏è blockiert';
                }
            }
            
            // Debug-Info nach kurzer Verz√∂gerung aktualisieren
            setTimeout(updateDebugInfoV2, 1000);
            
        })();
        
        console.log('‚úÖ v3.3 Ultra-Mega-DB Alle Features geladen');
        
        // ===== V3.0 NEUE FUNKTIONEN =====
        
        // Stoppuhr-Variablen
        let stoppuhrRunning = false;
        let stoppuhrSeconds = 0;
        let stoppuhrInterval = null;
        
        // Stoppuhr starten/stoppen
        function toggleStoppuhr() {
            const btn = document.getElementById('stoppuhrStart');
            if (stoppuhrRunning) {
                // Stoppen
                clearInterval(stoppuhrInterval);
                stoppuhrRunning = false;
                btn.textContent = '‚ñ∂Ô∏è Start';
                btn.classList.remove('stop');
                btn.classList.add('start');
            } else {
                // Starten
                stoppuhrInterval = setInterval(() => {
                    stoppuhrSeconds++;
                    updateStoppuhrDisplay();
                }, 1000);
                stoppuhrRunning = true;
                btn.textContent = '‚èπÔ∏è Stop';
                btn.classList.remove('start');
                btn.classList.add('stop');
            }
        }
        
        function updateStoppuhrDisplay() {
            const h = Math.floor(stoppuhrSeconds / 3600);
            const m = Math.floor((stoppuhrSeconds % 3600) / 60);
            const s = stoppuhrSeconds % 60;
            document.getElementById('stoppuhrDisplay').textContent = 
                `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function resetStoppuhr() {
            clearInterval(stoppuhrInterval);
            stoppuhrRunning = false;
            stoppuhrSeconds = 0;
            updateStoppuhrDisplay();
            const btn = document.getElementById('stoppuhrStart');
            btn.textContent = '‚ñ∂Ô∏è Start';
            btn.classList.remove('stop');
            btn.classList.add('start');
        }
        
        function stoppuhrUebernehmen() {
            const hours = (stoppuhrSeconds / 3600).toFixed(2);
            // Finde Arbeitszeit-Feld und f√ºlle es aus
            const stundenInput = document.getElementById('personalStunden');
            if (stundenInput) {
                stundenInput.value = hours;
                showToast(`‚è±Ô∏è ${hours} Stunden √ºbernommen!`, 'success');
            } else {
                showToast(`‚è±Ô∏è Gestoppte Zeit: ${hours} Stunden`, 'info');
            }
        }

        // Navigation zur Baustelle
        function navigateToBaustelle() {
            const lat = document.getElementById('gpsLat')?.value;
            const lon = document.getElementById('gpsLon')?.value;
            const baustelle = document.getElementById('baustelleHelper')?.value || '';
            
            if (lat && lon) {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, '_blank');
            } else if (baustelle) {
                window.open(`https://www.google.com/maps/search/${encodeURIComponent(baustelle)}`, '_blank');
            } else {
                showToast('‚ùå Bitte erst GPS erfassen oder Baustelle eingeben', 'error');
            }
        }
        
        // Schnellfoto
        function schnellFoto() {
            document.getElementById('photoInput')?.click();
        }
        
        // B√ºro anrufen
        function callBuero() {
            window.location.href = 'tel:+4971123456789'; // Anpassen!
            showToast('üìû Rufe B√ºro an...', 'info');
        }
        
        // Abwesenheit melden
        function showAbwesenheit() {
            const choice = prompt('Abwesenheit melden:\\n1 = Urlaub\\n2 = Krank\\n3 = Schlechtwetter\\n4 = Feiertag');
            if (choice) {
                const types = ['', 'Urlaub', 'Krank', 'Schlechtwetter', 'Feiertag'];
                const type = types[parseInt(choice)] || 'Sonstige';
                
                // Speichere Abwesenheit
                const abwesenheiten = JSON.parse(localStorage.getItem('abwesenheiten') || '[]');
                abwesenheiten.push({
                    datum: new Date().toISOString().split('T')[0],
                    typ: type
                });
                localStorage.setItem('abwesenheiten', JSON.stringify(abwesenheiten));
                
                showToast(`üìù ${type} f√ºr heute eingetragen`, 'success');
            }
        }
        
        // Vorlagen
        function loadVorlage(vorlage) {
            if (!vorlage) return;
            
            const vorlagen = {
                'fliesen-standard': {
                    taetigkeiten: ['Fliesen verlegen', 'Fugenmasse aufbringen'],
                    material: ['Fliesen', 'Fliesenkleber', 'Fugenmasse'],
                    werkzeuge: ['Fliesenschneider', 'Zahnspachtel', 'Wasserwaage']
                },
                'fliesen-bad': {
                    taetigkeiten: ['Fliesen verlegen', 'Abdichtung', 'Fugenmasse aufbringen', 'Silikon'],
                    material: ['Fliesen', 'Fliesenkleber', 'Dichtfolie', 'Fugenmasse', 'Silikon'],
                    werkzeuge: ['Fliesenschneider', 'Zahnspachtel', 'Wasserwaage', 'Silikonpresse']
                },
                'fliesen-kueche': {
                    taetigkeiten: ['Fliesenspiegel setzen', 'Fliesen verlegen'],
                    material: ['Wandfliesen', 'Fliesenkleber', 'Fugenmasse'],
                    werkzeuge: ['Fliesenschneider', 'Zahnspachtel']
                },
                'fliesen-boden': {
                    taetigkeiten: ['Bodenfliesen verlegen', 'Nivellieren'],
                    material: ['Bodenfliesen', 'Flexkleber', 'Nivelliermasse'],
                    werkzeuge: ['Fliesenschneider', 'Nivelliersystem', 'Gummihammer']
                },
                'fliesen-wand': {
                    taetigkeiten: ['Wandfliesen verlegen'],
                    material: ['Wandfliesen', 'Fliesenkleber'],
                    werkzeuge: ['Fliesenschneider', 'Zahnspachtel', 'Wasserwaage']
                },
                'naturstein': {
                    taetigkeiten: ['Naturstein verlegen', 'Impr√§gnieren'],
                    material: ['Naturstein', 'Natursteinkleber', 'Impr√§gnierung'],
                    werkzeuge: ['Steintrennmaschine', 'Zahnspachtel']
                },
                'reparatur': {
                    taetigkeiten: ['Fliesen austauschen', 'Ausbesserung'],
                    material: ['Ersatzfliesen', 'Fliesenkleber', 'Fugenmasse'],
                    werkzeuge: ['Mei√üel', 'Hammer', 'Fliesenschneider']
                },
                'aufmass': {
                    taetigkeiten: ['Aufma√ü nehmen', 'Bestandsaufnahme'],
                    material: [],
                    werkzeuge: ['Laser-Entfernungsmesser', 'Zollstock']
                }
            };
            
            const v = vorlagen[vorlage];
            if (v) {
                showToast(`üìã Vorlage "${vorlage}" geladen!`, 'success');
                // Hier k√∂nnten die Werte in die Felder √ºbernommen werden
            }
            
            document.getElementById('vorlageSelect').value = '';
        }
        
        // Projekte verwalten
        function addProjekt() {
            const name = document.getElementById('newProjektName')?.value?.trim();
            const nr = document.getElementById('newProjektNr')?.value?.trim();
            
            if (!name) {
                showToast('‚ùå Bitte Projektname eingeben', 'error');
                return;
            }
            
            const projekte = JSON.parse(localStorage.getItem('projekte') || '[]');
            projekte.push({
                id: Date.now(),
                name: name,
                nr: nr || 'P-' + Date.now(),
                erstelltAm: new Date().toISOString(),
                aktiv: true
            });
            localStorage.setItem('projekte', JSON.stringify(projekte));
            
            document.getElementById('newProjektName').value = '';
            document.getElementById('newProjektNr').value = '';
            
            loadProjekte();
            showToast(`‚úÖ Projekt "${name}" angelegt!`, 'success');
        }
        
        function loadProjekte() {
            const container = document.getElementById('projektListe');
            if (!container) return;
            
            const projekte = JSON.parse(localStorage.getItem('projekte') || '[]');
            
            if (projekte.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">Noch keine Projekte angelegt.</p>';
                return;
            }
            
            container.innerHTML = projekte.map(p => `
                <div class="projekt-card ${p.aktiv ? 'aktiv' : ''}">
                    <div class="projekt-info">
                        <h4>${p.aktiv ? 'üèóÔ∏è' : '‚úÖ'} ${p.name}</h4>
                        <span>${p.nr} | Erstellt: ${new Date(p.erstelltAm).toLocaleDateString('de-DE')}</span>
                    </div>
                    <div class="projekt-actions">
                        <button onclick="selectProjekt('${p.id}')" style="background: #22c55e; color: white;">Ausw√§hlen</button>
                        <button onclick="deleteProjekt('${p.id}')" style="background: #ef4444; color: white;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function selectProjekt(id) {
            const projekte = JSON.parse(localStorage.getItem('projekte') || '[]');
            const projekt = projekte.find(p => p.id == id);
            if (projekt) {
                document.getElementById('projektnummerHelper').value = projekt.nr;
                document.getElementById('baustelleHelper').value = projekt.name;
                switchToTab('neu');
                showToast(`üìÅ Projekt "${projekt.name}" ausgew√§hlt`, 'success');
            }
        }
        
        function deleteProjekt(id) {
            if (!confirm('Projekt wirklich l√∂schen?')) return;
            let projekte = JSON.parse(localStorage.getItem('projekte') || '[]');
            projekte = projekte.filter(p => p.id != id);
            localStorage.setItem('projekte', JSON.stringify(projekte));
            loadProjekte();
            showToast('üóëÔ∏è Projekt gel√∂scht', 'info');
        }
        
        // Statistiken
        function loadStats(zeitraum) {
            // Button-Status aktualisieren
            document.querySelectorAll('.stats-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('stats-' + zeitraum)?.classList.add('active');
            
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const now = new Date();
            
            // Zeitraum filtern
            let filtered = berichte;
            if (zeitraum === 'woche') {
                const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                filtered = berichte.filter(b => new Date(b.timestamp) >= weekAgo);
            } else if (zeitraum === 'monat') {
                filtered = berichte.filter(b => {
                    const d = new Date(b.timestamp);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if (zeitraum === 'jahr') {
                filtered = berichte.filter(b => new Date(b.timestamp).getFullYear() === now.getFullYear());
            }
            
            // Statistiken berechnen
            let totalStunden = 0;
            let totalKm = 0;
            const baustellen = new Set();
            
            filtered.forEach(b => {
                // Versuche Stunden aus verschiedenen Feldern zu extrahieren
                const stunden = parseFloat(b.arbeitszeit || b.stunden || 0);
                totalStunden += isNaN(stunden) ? 0 : stunden;
                
                const km = parseFloat(b.km || 0);
                totalKm += isNaN(km) ? 0 : km;
                
                if (b.baustelle) baustellen.add(b.baustelle);
            });
            
            // UI aktualisieren
            document.getElementById('statStunden').textContent = totalStunden.toFixed(1);
            document.getElementById('statBerichte').textContent = filtered.length;
            document.getElementById('statProjekte').textContent = baustellen.size;
            document.getElementById('statKm').textContent = totalKm.toFixed(0);
            
            // Top Baustellen
            const baustellenStats = {};
            filtered.forEach(b => {
                if (b.baustelle) {
                    baustellenStats[b.baustelle] = (baustellenStats[b.baustelle] || 0) + parseFloat(b.stunden || 8);
                }
            });
            
            const topContainer = document.getElementById('topBaustellen');
            if (topContainer) {
                const sorted = Object.entries(baustellenStats).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const maxHours = sorted[0]?.[1] || 1;
                
                topContainer.innerHTML = sorted.length ? sorted.map((item, i) => `
                    <div class="top-baustelle-bar">
                        <span class="rank">#${i + 1}</span>
                        <span class="name">${item[0]}</span>
                        <span class="hours">${item[1].toFixed(1)}h</span>
                        <div class="bar" style="width: ${(item[1] / maxHours * 100)}px;"></div>
                    </div>
                `).join('') : '<p style="color: #64748b;">Keine Daten vorhanden</p>';
            }
        }
        
        // Kalender
        let currentKalenderDate = new Date();
        
        function renderKalender() {
            const grid = document.getElementById('kalenderGrid');
            if (!grid) return;
            
            const year = currentKalenderDate.getFullYear();
            const month = currentKalenderDate.getMonth();
            
            // Monat-Anzeige aktualisieren
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 
                               'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('kalenderMonat').textContent = `${monthNames[month]} ${year}`;
            
            // Berichte f√ºr diesen Monat holen
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const berichtDaten = new Set();
            berichte.forEach(b => {
                const d = new Date(b.timestamp);
                if (d.getMonth() === month && d.getFullYear() === year) {
                    berichtDaten.add(d.getDate());
                }
            });
            
            // Kalender-Header (Wochentage)
            const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            let html = weekDays.map(d => `<div class="kalender-header">${d}</div>`).join('');
            
            // Erster Tag des Monats
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1; // Montag = 0
            if (startDay < 0) startDay = 6;
            
            // Leere Felder vor dem 1.
            for (let i = 0; i < startDay; i++) {
                html += '<div class="kalender-tag leer"></div>';
            }
            
            // Tage des Monats
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const hatBericht = berichtDaten.has(day);
                
                html += `<div class="kalender-tag ${isToday ? 'heute' : ''} ${hatBericht ? 'hat-bericht' : ''}" 
                         onclick="showKalenderTag(${year}, ${month}, ${day})">
                         ${day}
                         </div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function changeMonth(delta) {
            currentKalenderDate.setMonth(currentKalenderDate.getMonth() + delta);
            renderKalender();
        }
        
        function showKalenderTag(year, month, day) {
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const tagesBerichte = berichte.filter(b => {
                const d = new Date(b.timestamp);
                return d.getDate() === day && d.getMonth() === month && d.getFullYear() === year;
            });
            
            if (tagesBerichte.length > 0) {
                alert(`${day}.${month + 1}.${year}:\\n${tagesBerichte.length} Bericht(e) vorhanden`);
            }
        }
        
        // Suche in Berichten
        function filterBerichte(query) {
            const container = document.getElementById('berichteListe');
            const berichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            
            const filtered = query ? berichte.filter(b => {
                const searchStr = JSON.stringify(b).toLowerCase();
                return searchStr.includes(query.toLowerCase());
            }) : berichte;
            
            // Hier m√ºsste die existierende loadBerichteList-Funktion mit gefilterten Daten aufgerufen werden
            // F√ºr jetzt nur die Anzahl anzeigen
            if (query && filtered.length !== berichte.length) {
                showToast(`üîç ${filtered.length} von ${berichte.length} Berichten`, 'info');
            }
        }
        
        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.dark-mode-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
        
        // Dark Mode beim Laden pr√ºfen
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Tab-Switching erweitern f√ºr neue Tabs
        const originalSwitchToTab = window.switchToTab;
        window.switchToTab = function(tabName) {
            // Original-Funktion aufrufen wenn vorhanden
            if (typeof originalSwitchToTab === 'function') {
                originalSwitchToTab(tabName);
            }
            
            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Aktiven Tab und Content aktivieren
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.toLowerCase().includes(tabName.substring(0, 3)) || 
                    t.onclick?.toString().includes(tabName)) {
                    t.classList.add('active');
                }
            });
            
            const content = document.getElementById('tab-' + tabName);
            if (content) content.classList.add('active');
            
            // Spezielle Initialisierungen
            if (tabName === 'projekte') loadProjekte();
            if (tabName === 'statistiken') loadStats('monat');
            if (tabName === 'kalender') renderKalender();
        };
        
        // Beim Laden initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            // loadWetter wird bereits von autoLoadLocation() aufgerufen

            // Dark Mode Button
            if (!document.querySelector('.dark-mode-toggle')) {
                const btn = document.createElement('button');
                btn.className = 'dark-mode-toggle';
                btn.textContent = localStorage.getItem('darkMode') === 'true' ? '‚òÄÔ∏è' : 'üåô';
                btn.onclick = toggleDarkMode;
                document.body.appendChild(btn);
            }
        });
        
        // ===== v3.3 Ultra-Mega-DB: INTELLIGENTES TEXTVERBESSERUNGS-SYSTEM =====
        // Kombiniert: Gro√üe lokale Datenbank + Kostenlose KI (Puter.js) + Stundenerkennung
        
        // ===== RIESIGE LOKALE DATENBANK F√úR FLIESENLEGER =====
        // ===== ULTRA-MEGA-DATENBANK v3.3 =====
        // 648 Autokorrekturen + 599 Formulierungen
        const baustellenDatenbank = {
            
            // === AUTOKORREKTUR (648 Eintr√§ge) ===
            autokorrektur: {
                // --- Fliesen & Platten (80+) ---
                'fliessen': 'Fliesen', 'flie√üen': 'Fliesen', 'fliesen': 'Fliesen',
                'fliese': 'Fliese', 'flies': 'Fliese', 'fliesse': 'Fliese',
                'bodenfliessen': 'Bodenfliesen', 'bodenflie√üen': 'Bodenfliesen',
                'wandfliessen': 'Wandfliesen', 'wandflie√üen': 'Wandfliesen',
                'mosaikfliessen': 'Mosaikfliesen', 'mosaikflie√üen': 'Mosaikfliesen',
                'feinsteinzeug': 'Feinsteinzeug', 'feinstein': 'Feinsteinzeug',
                'steinzeug': 'Steinzeug', 'steingut': 'Steingut',
                'naturstein': 'Naturstein', 'natur stein': 'Naturstein',
                'marmor': 'Marmor', 'marmorplatte': 'Marmorplatte',
                'granit': 'Granit', 'granitplatte': 'Granitplatte',
                'schiefer': 'Schiefer', 'schieferplatte': 'Schieferplatte',
                'travertin': 'Travertin', 'travertinplatte': 'Travertinplatte',
                'terrakotta': 'Terrakotta', 'terracotta': 'Terrakotta',
                'cotto': 'Cotto', 'cottofliese': 'Cottofliese',
                'klinker': 'Klinker', 'klinkerfliese': 'Klinkerfliese',
                'spaltplatte': 'Spaltplatte', 'spaltplatten': 'Spaltplatten',
                'riemchen': 'Riemchen', 'klinkerriemchen': 'Klinkerriemchen',
                'gro√üformat': 'Gro√üformat', 'grossformat': 'Gro√üformat',
                'gro√üformatfliese': 'Gro√üformatfliese', 'xxl fliese': 'XXL-Fliese',
                'rektifiziert': 'rektifiziert', 'rectifiziert': 'rektifiziert',
                'kalibriert': 'kalibriert', 'kallibriert': 'kalibriert',
                'glasiert': 'glasiert', 'glasur': 'Glasur',
                'unglasiert': 'unglasiert', 'matt': 'matt',
                'poliert': 'poliert', 'gl√§nzend': 'gl√§nzend',
                'rutschhemmend': 'rutschhemmend', 'rutschfest': 'rutschfest',
                'r9': 'R9', 'r10': 'R10', 'r11': 'R11', 'r12': 'R12', 'r13': 'R13',
                'trittsicher': 'trittsicher', 'rutschklasse': 'Rutschklasse',
                'abriebklasse': 'Abriebklasse', 'pei': 'PEI',
                'frostfest': 'frostfest', 'frostsicher': 'frostsicher',
                'frostbest√§ndig': 'frostbest√§ndig', 'aussenbereich': 'Au√üenbereich',
                'innenbereich': 'Innenbereich', 'nasszelle': 'Nasszelle',
                'feuchtraum': 'Feuchtraum', 'nassraum': 'Nassraum',
                'sockel': 'Sockel', 'sockelfliese': 'Sockelfliese',
                'bord√ºre': 'Bord√ºre', 'borduere': 'Bord√ºre',
                'dekorfliese': 'Dekorfliese', 'dekor': 'Dekor',
                'einleger': 'Einleger', 'flieseneinleger': 'Flieseneinleger',
                'mosaik': 'Mosaik', 'mosaikplatte': 'Mosaikplatte',
                'glasmosaik': 'Glasmosaik', 'natursteinmosaik': 'Natursteinmosaik',
                'holzoptik': 'Holzoptik', 'holzfliese': 'Holzfliese',
                'betonoptik': 'Betonoptik', 'steinoptik': 'Steinoptik',
                'marmoroptik': 'Marmoroptik', 'schieferoptik': 'Schieferoptik',
                
                // --- Verlegung & Verlegetechniken (100+) ---
                'ferlegung': 'Verlegung', 'verlegund': 'Verlegung', 'verlegung': 'Verlegung',
                'ferlegt': 'verlegt', 'verlegt': 'verlegt', 'verleg': 'verlegt',
                'verlegen': 'verlegen', 'ferleg': 'verlegen',
                'd√ºnnbett': 'D√ºnnbett', 'd√ºnnbet': 'D√ºnnbett', 'duennbett': 'D√ºnnbett',
                'd√ºnnbettverfahren': 'D√ºnnbettverfahren', 'd√ºnnbettm√∂rtel': 'D√ºnnbettm√∂rtel',
                'mittelbett': 'Mittelbett', 'mittelbettverfahren': 'Mittelbettverfahren',
                'mittelbettm√∂rtel': 'Mittelbettm√∂rtel', 'mittelbet': 'Mittelbett',
                'dickbett': 'Dickbett', 'dickbettverfahren': 'Dickbettverfahren',
                'dickbettm√∂rtel': 'Dickbettm√∂rtel', 'dickbet': 'Dickbett',
                'buttering': 'Buttering', 'floating': 'Floating',
                'buttering floating': 'Buttering-Floating', 'kombiniert': 'kombiniert',
                'halbverband': 'Halbverband', 'halb verband': 'Halbverband',
                'drittelverband': 'Drittelverband', 'drittel verband': 'Drittelverband',
                'viertelverband': 'Viertelverband', 'viertel verband': 'Viertelverband',
                'kreuzfuge': 'Kreuzfuge', 'kreuz fuge': 'Kreuzfuge',
                'parallelverband': 'Parallelverband', 'parallel verband': 'Parallelverband',
                'diagonalverlegung': 'Diagonalverlegung', 'diagonal': 'diagonal',
                'fischgr√§t': 'Fischgr√§t', 'fischgr√§te': 'Fischgr√§t',
                'fischgraet': 'Fischgr√§t', 'fischgrat': 'Fischgr√§t',
                'r√∂mischer verband': 'R√∂mischer Verband', 'roemischer verband': 'R√∂mischer Verband',
                'wilder verband': 'Wilder Verband', 'wildverband': 'Wildverband',
                'bahnenverlegung': 'Bahnenverlegung', 'bahnen': 'Bahnen',
                'modulverlegung': 'Modulverlegung', 'modular': 'modular',
                'vollfl√§chig': 'vollfl√§chig', 'vollflaechig': 'vollfl√§chig',
                'teilfl√§che': 'Teilfl√§che', 'teilflaeche': 'Teilfl√§che',
                'punktuell': 'punktuell', 'punkt f√ºr punkt': 'punktuell',
                'einbettung': 'Einbettung', 'eingebettet': 'eingebettet',
                'verklebt': 'verklebt', 'geklebt': 'geklebt',
                'verklebung': 'Verklebung', 'klebung': 'Klebung',
                'ansetzen': 'ansetzen', 'angesetzt': 'angesetzt',
                'ansetzarbeiten': 'Ansetzarbeiten', 'ansatztechnik': 'Ansatztechnik',
                'entkopplungsmatte': 'Entkopplungsmatte', 'entkopplung': 'Entkopplung',
                'entkopplungsbahn': 'Entkopplungsbahn', 'ditra': 'DITRA',
                'trittschalld√§mmung': 'Trittschalld√§mmung', 'trittschall': 'Trittschall',
                'w√§rmed√§mmung': 'W√§rmed√§mmung', 'd√§mmung': 'D√§mmung',
                'fu√übodenheizung': 'Fu√übodenheizung', 'fussbodenheizung': 'Fu√übodenheizung',
                'heizestrich': 'Heizestrich', 'heiz estrich': 'Heizestrich',
                'aufheizprotokoll': 'Aufheizprotokoll', 'belegreife': 'Belegreife',
                'restfeuchte': 'Restfeuchte', 'cm messung': 'CM-Messung',
                'cm wert': 'CM-Wert', 'feuchtemessung': 'Feuchtemessung',
                
                // --- Fugen & Verfugung (80+) ---
                'fugen': 'Fugen', 'fuggen': 'Fugen', 'fuge': 'Fuge',
                'verfugen': 'verfugen', 'verfugt': 'verfugt', 'ferfugt': 'verfugt',
                'verfugung': 'Verfugung', 'ferfugung': 'Verfugung',
                'fugenm√∂rtel': 'Fugenm√∂rtel', 'fugenmoertel': 'Fugenm√∂rtel',
                'fugenmasse': 'Fugenmasse', 'fugen masse': 'Fugenmasse',
                'flexfuge': 'Flexfuge', 'flex fuge': 'Flexfuge',
                'flexfugenm√∂rtel': 'Flexfugenm√∂rtel', 'flexfugenmoertel': 'Flexfugenm√∂rtel',
                'zementfuge': 'Zementfuge', 'zement fuge': 'Zementfuge',
                'epoxidfuge': 'Epoxidfuge', 'epoxid fuge': 'Epoxidfuge',
                'epoxidharz': 'Epoxidharz', 'epoxy': 'Epoxid',
                'reaktionsharz': 'Reaktionsharz', 'reaktionsharzfuge': 'Reaktionsharzfuge',
                'fugenbrett': 'Fugenbrett', 'fugen brett': 'Fugenbrett',
                'fugengummi': 'Fugengummi', 'fugen gummi': 'Fugengummi',
                'fugenschwamm': 'Fugenschwamm', 'fugen schwamm': 'Fugenschwamm',
                'fugenbreite': 'Fugenbreite', 'fugen breite': 'Fugenbreite',
                'schmale fuge': 'schmale Fuge', 'breite fuge': 'breite Fuge',
                'fugenbild': 'Fugenbild', 'fugen bild': 'Fugenbild',
                'eingeschl√§mmt': 'eingeschl√§mmt', 'einschlaemmt': 'eingeschl√§mmt',
                'ausgewaschen': 'ausgewaschen', 'aus gewaschen': 'ausgewaschen',
                'diagonal gewaschen': 'diagonal gewaschen', 'fugenreinigung': 'Fugenreinigung',
                'randfuge': 'Randfuge', 'rand fuge': 'Randfuge',
                'anschlussfuge': 'Anschlussfuge', 'anschluss fuge': 'Anschlussfuge',
                'bewegungsfuge': 'Bewegungsfuge', 'bewegungs fuge': 'Bewegungsfuge',
                'dehnfuge': 'Dehnfuge', 'dehn fuge': 'Dehnfuge',
                'dehnungsfuge': 'Dehnungsfuge', 'dehnungs fuge': 'Dehnungsfuge',
                'wartungsfuge': 'Wartungsfuge', 'wartungs fuge': 'Wartungsfuge',
                'schattenfuge': 'Schattenfuge', 'schatten fuge': 'Schattenfuge',
                'feldbegrenzung': 'Feldbegrenzung', 'feld begrenzung': 'Feldbegrenzung',
                'fugenkreuz': 'Fugenkreuz', 'fugen kreuz': 'Fugenkreuz',
                'fugenkeile': 'Fugenkeile', 'fugen keile': 'Fugenkeile',
                'nivelliersystem': 'Nivelliersystem', 'nivellier system': 'Nivelliersystem',
                'fliesenlaschen': 'Fliesenlaschen', 'fliesen laschen': 'Fliesenlaschen',
                'fliesenkeile': 'Fliesenkeile', 'fliesen keile': 'Fliesenkeile',
                
                // --- Grundierung & Voranstrich (50+) ---
                'grundirung': 'Grundierung', 'grundierung': 'Grundierung',
                'grundiert': 'grundiert', 'grundirt': 'grundiert',
                'grundieren': 'grundieren', 'grundiren': 'grundieren',
                'tiefengrund': 'Tiefengrund', 'tiefen grund': 'Tiefengrund',
                'tiefgrund': 'Tiefgrund', 'tief grund': 'Tiefgrund',
                'haftgrund': 'Haftgrund', 'haft grund': 'Haftgrund',
                'haftbr√ºcke': 'Haftbr√ºcke', 'haft br√ºcke': 'Haftbr√ºcke',
                'haftbruecke': 'Haftbr√ºcke', 'haftanstrich': 'Haftanstrich',
                'voranstrich': 'Voranstrich', 'vor anstrich': 'Voranstrich',
                'sperrgrund': 'Sperrgrund', 'sperr grund': 'Sperrgrund',
                'sperrgrundierung': 'Sperrgrundierung', 'absperrung': 'Absperrung',
                'isoliergrund': 'Isoliergrund', 'isolier grund': 'Isoliergrund',
                'kontaktgrund': 'Kontaktgrund', 'kontakt grund': 'Kontaktgrund',
                'betonkontakt': 'Betonkontakt', 'beton kontakt': 'Betonkontakt',
                'quarzsand': 'Quarzsand', 'quarz sand': 'Quarzsand',
                'aufbrennsperre': 'Aufbrennsperre', 'aufbrenn sperre': 'Aufbrennsperre',
                'trocknen': 'trocknen', 'getrocknet': 'getrocknet',
                'trocknungszeit': 'Trocknungszeit', 'abl√ºftzeit': 'Abl√ºftzeit',
                'staubbindend': 'staubbindend', 'staub bindend': 'staubbindend',
                'saugf√§hig': 'saugf√§hig', 'saug f√§hig': 'saugf√§hig',
                'saugend': 'saugend', 'nicht saugend': 'nicht saugend',
                'verd√ºnnt': 'verd√ºnnt', 'unverd√ºnnt': 'unverd√ºnnt',
                'aufgetragen': 'aufgetragen', 'aufgestrichen': 'aufgestrichen',
                'aufgerollt': 'aufgerollt', 'eingearbeitet': 'eingearbeitet',
                
                // --- Abdichtung (80+) ---
                'abdichtung': 'Abdichtung', 'abdichtun': 'Abdichtung',
                'abgedichtet': 'abgedichtet', 'abgedichted': 'abgedichtet',
                'abdichten': 'abdichten', 'dichten': 'dichten',
                'dichtband': 'Dichtband', 'dicht band': 'Dichtband',
                'dichtbahn': 'Dichtbahn', 'dicht bahn': 'Dichtbahn',
                'dichtmanschette': 'Dichtmanschette', 'dicht manschette': 'Dichtmanschette',
                'dichtecke': 'Dichtecke', 'dicht ecke': 'Dichtecke',
                'innenecke': 'Innenecke', 'innen ecke': 'Innenecke',
                'au√üenecke': 'Au√üenecke', 'aussenecke': 'Au√üenecke',
                'aussen ecke': 'Au√üenecke', 'rohrdurchf√ºhrung': 'Rohrdurchf√ºhrung',
                'verbundabdichtung': 'Verbundabdichtung', 'verbund abdichtung': 'Verbundabdichtung',
                'fl√ºssigfolie': 'Fl√ºssigfolie', 'fluessigfolie': 'Fl√ºssigfolie',
                'dichtschl√§mme': 'Dichtschl√§mme', 'dichtschlaemme': 'Dichtschl√§mme',
                'reaktivabdichtung': 'Reaktivabdichtung', 'reaktiv abdichtung': 'Reaktivabdichtung',
                'bitumen': 'Bitumen', 'bitumenanstrich': 'Bitumenanstrich',
                'bitumenbahn': 'Bitumenbahn', 'bitumen bahn': 'Bitumenbahn',
                'schwei√übahn': 'Schwei√übahn', 'schweissbahn': 'Schwei√übahn',
                'kaltselbstklebend': 'kaltselbstklebend', 'kalt selbstklebend': 'kaltselbstklebend',
                'wassersperre': 'Wassersperre', 'wasser sperre': 'Wassersperre',
                'wasserundurchl√§ssig': 'wasserundurchl√§ssig', 'wasserdicht': 'wasserdicht',
                'wasserbest√§ndig': 'wasserbest√§ndig', 'wasser best√§ndig': 'wasserbest√§ndig',
                'druckwasser': 'Druckwasser', 'druck wasser': 'Druckwasser',
                'spritzwasser': 'Spritzwasser', 'spritz wasser': 'Spritzwasser',
                'nassbereiche': 'Nassbereiche', 'nass bereiche': 'Nassbereiche',
                'duschbereich': 'Duschbereich', 'dusch bereich': 'Duschbereich',
                'wannenbereich': 'Wannenbereich', 'wannen bereich': 'Wannenbereich',
                'bodengleich': 'bodengleich', 'boden gleich': 'bodengleich',
                'barrierefrei': 'barrierefrei', 'barriere frei': 'barrierefrei',
                'gef√§lleestrich': 'Gef√§lleestrich', 'gef√§lle estrich': 'Gef√§lleestrich',
                'gefaelleestrich': 'Gef√§lleestrich', 'gef√§lle': 'Gef√§lle',
                'gefaelle': 'Gef√§lle', 'ablauf': 'Ablauf',
                'duschrinne': 'Duschrinne', 'dusch rinne': 'Duschrinne',
                'bodenablauf': 'Bodenablauf', 'boden ablauf': 'Bodenablauf',
                'punktablauf': 'Punktablauf', 'punkt ablauf': 'Punktablauf',
                'linienablauf': 'Linienablauf', 'linien ablauf': 'Linienablauf',
                'din 18534': 'DIN 18534', 'din18534': 'DIN 18534',
                'wassereinwirkungsklasse': 'Wassereinwirkungsklasse', 'w0': 'W0',
                'w1': 'W1', 'w2': 'W2', 'w3': 'W3',
                'w0-i': 'W0-I', 'w1-i': 'W1-I', 'w2-i': 'W2-I', 'w3-i': 'W3-I',
                
                // --- Untergrund & Estrich (80+) ---
                'estrich': 'Estrich', 'esstrich': 'Estrich', 'estrich': 'Estrich',
                'untergrund': 'Untergrund', 'unter grund': 'Untergrund',
                'unterboden': 'Unterboden', 'unter boden': 'Unterboden',
                'untergrundvorbereitung': 'Untergrundvorbereitung', 'untergrund vorbereitung': 'Untergrundvorbereitung',
                'zementestrich': 'Zementestrich', 'zement estrich': 'Zementestrich',
                'calciumsulfatestrich': 'Calciumsulfatestrich', 'calcium sulfat estrich': 'Calciumsulfatestrich',
                'anhydritestrich': 'Anhydritestrich', 'anhydrit estrich': 'Anhydritestrich',
                'gussasphalt': 'Gussasphalt', 'guss asphalt': 'Gussasphalt',
                'trockenestrich': 'Trockenestrich', 'trocken estrich': 'Trockenestrich',
                'flie√üestrich': 'Flie√üestrich', 'fliess estrich': 'Flie√üestrich',
                'schnellestrich': 'Schnellestrich', 'schnell estrich': 'Schnellestrich',
                'ct': 'CT', 'ca': 'CA', 'as': 'AS', 'sr': 'SR',
                'estrichdicke': 'Estrichdicke', 'estrich dicke': 'Estrichdicke',
                'estrichfl√§che': 'Estrichfl√§che', 'estrich fl√§che': 'Estrichfl√§che',
                'estrichfeld': 'Estrichfeld', 'estrich feld': 'Estrichfeld',
                'randd√§mmstreifen': 'Randd√§mmstreifen', 'rand d√§mmstreifen': 'Randd√§mmstreifen',
                'd√§mmschicht': 'D√§mmschicht', 'd√§mm schicht': 'D√§mmschicht',
                'ausgleichsmasse': 'Ausgleichsmasse', 'ausgleichs masse': 'Ausgleichsmasse',
                'nivelliermasse': 'Nivelliermasse', 'nivellier masse': 'Nivelliermasse',
                'selbstverlaufend': 'selbstverlaufend', 'selbst verlaufend': 'selbstverlaufend',
                'selbstnivellierend': 'selbstnivellierend', 'selbst nivellierend': 'selbstnivellierend',
                'spachtelmasse': 'Spachtelmasse', 'spachtel masse': 'Spachtelmasse',
                'ausgleichsspachtel': 'Ausgleichsspachtel', 'ausgleichs spachtel': 'Ausgleichsspachtel',
                'reparaturm√∂rtel': 'Reparaturm√∂rtel', 'reparatur m√∂rtel': 'Reparaturm√∂rtel',
                'reprofilierung': 'Reprofilierung', 'repro filierung': 'Reprofilierung',
                'altbelag': 'Altbelag', 'alt belag': 'Altbelag',
                'altkleber': 'Altkleber', 'alt kleber': 'Altkleber',
                'kleberreste': 'Kleberreste', 'kleber reste': 'Kleberreste',
                'schleifen': 'schleifen', 'geschliffen': 'geschliffen',
                'anschleifen': 'anschleifen', 'angeschliffen': 'angeschliffen',
                'kugelstrahlen': 'kugelstrahlen', 'kugelgestrahlt': 'kugelgestrahlt',
                'fr√§sen': 'fr√§sen', 'gefr√§st': 'gefr√§st',
                'absaugen': 'absaugen', 'abgesaugt': 'abgesaugt',
                'reinigen': 'reinigen', 'gereinigt': 'gereinigt',
                'saugen': 'saugen', 'entstaubt': 'entstaubt',
                'tragf√§hig': 'tragf√§hig', 'trag f√§hig': 'tragf√§hig',
                'belastbar': 'belastbar', 'druckfest': 'druckfest',
                'zugfest': 'zugfest', 'rissfrei': 'rissfrei',
                'rissarm': 'rissarm', 'schwundrisse': 'Schwundrisse',
                'schwindrisse': 'Schwindrisse', 'riss√ºberbr√ºckend': 'riss√ºberbr√ºckend',
                
                // --- Kleber & M√∂rtel (60+) ---
                'fliesenkleber': 'Fliesenkleber', 'fliesen kleber': 'Fliesenkleber',
                'flexkleber': 'Flexkleber', 'flex kleber': 'Flexkleber',
                'dispersionskleber': 'Dispersionskleber', 'dispersions kleber': 'Dispersionskleber',
                'zementkleber': 'Zementkleber', 'zement kleber': 'Zementkleber',
                'reaktionsharzkleber': 'Reaktionsharzkleber', 'reaktionsharz kleber': 'Reaktionsharzkleber',
                'natursteinkleber': 'Natursteinkleber', 'naturstein kleber': 'Natursteinkleber',
                'schnellkleber': 'Schnellkleber', 'schnell kleber': 'Schnellkleber',
                'c1': 'C1', 'c2': 'C2', 'c2te': 'C2TE', 'c2tes1': 'C2TES1',
                's1': 'S1', 's2': 'S2', 'te': 'TE', 'f': 'F',
                'standfest': 'standfest', 'stand fest': 'standfest',
                'thixotrop': 'thixotrop', 'standsicher': 'standsicher',
                'verformbar': 'verformbar', 'hochflexibel': 'hochflexibel',
                'spachtel': 'Spachtel', 'schpachtel': 'Spachtel',
                'spachteln': 'spachteln', 'gespachtelt': 'gespachtelt',
                'aufziehen': 'aufziehen', 'aufgezogen': 'aufgezogen',
                'ausk√§mmen': 'ausk√§mmen', 'ausgek√§mmt': 'ausgek√§mmt',
                'eindr√ºcken': 'eindr√ºcken', 'eingedr√ºckt': 'eingedr√ºckt',
                'andr√ºcken': 'andr√ºcken', 'angedr√ºckt': 'angedr√ºckt',
                'einklopfen': 'einklopfen', 'eingeklopft': 'eingeklopft',
                'hohlraumfrei': 'hohlraumfrei', 'hohlraum frei': 'hohlraumfrei',
                'vollsatt': 'vollsatt', 'satt': 'satt',
                'benetzung': 'Benetzung', 'kontaktfl√§che': 'Kontaktfl√§che',
                'topfzeit': 'Topfzeit', 'verarbeitungszeit': 'Verarbeitungszeit',
                'offene zeit': 'offene Zeit', 'hautbildung': 'Hautbildung',
                'korrigierbar': 'korrigierbar', 'korrigierzeit': 'Korrigierzeit',
                'anmischen': 'anmischen', 'angemischt': 'angemischt',
                'r√ºhren': 'r√ºhren', 'ger√ºhrt': 'ger√ºhrt',
                'reifen': 'reifen', 'reifezeit': 'Reifezeit',
                'sumpfzeit': 'Sumpfzeit', 'quellen': 'quellen',
                
                // --- Silikon & Dichtstoffe (40+) ---
                'silikon': 'Silikon', 'silikoon': 'Silikon', 'silicon': 'Silikon',
                'silikonfuge': 'Silikonfuge', 'silikon fuge': 'Silikonfuge',
                'sanit√§rsilikon': 'Sanit√§rsilikon', 'sanitaersilikon': 'Sanit√§rsilikon',
                'natursteinsilikon': 'Natursteinsilikon', 'naturstein silikon': 'Natursteinsilikon',
                'neutralsilikon': 'Neutralsilikon', 'neutral silikon': 'Neutralsilikon',
                'acetatsilikon': 'Acetatsilikon', 'acetat silikon': 'Acetatsilikon',
                'fungizid': 'fungizid', 'schimmelresistent': 'schimmelresistent',
                'schimmelhemmend': 'schimmelhemmend', 'pilzhemmend': 'pilzhemmend',
                'acryl': 'Acryl', 'acrylfuge': 'Acrylfuge',
                'ms polymer': 'MS-Polymer', 'hybrid': 'Hybrid',
                'polyurethan': 'Polyurethan', 'pu': 'PU',
                'kartusche': 'Kartusche', 'kartuschen': 'Kartuschen',
                'schlauchbeutel': 'Schlauchbeutel', 'schlauch beutel': 'Schlauchbeutel',
                'kartuschenpresse': 'Kartuschenpresse', 'kartuschen presse': 'Kartuschenpresse',
                'silikonpresse': 'Silikonpresse', 'silikon presse': 'Silikonpresse',
                'fugengl√§tter': 'Fugengl√§tter', 'fugen gl√§tter': 'Fugengl√§tter',
                'abziehmittel': 'Abziehmittel', 'abzieh mittel': 'Abziehmittel',
                'gl√§ttmittel': 'Gl√§ttmittel', 'gl√§tt mittel': 'Gl√§ttmittel',
                'hinterf√ºllmaterial': 'Hinterf√ºllmaterial', 'hinterfuellmaterial': 'Hinterf√ºllmaterial',
                'rundschnur': 'Rundschnur', 'rund schnur': 'Rundschnur',
                'pe schnur': 'PE-Schnur', 'hinterf√ºllschnur': 'Hinterf√ºllschnur',
                'primer': 'Primer', 'silikonprimer': 'Silikonprimer',
                'haftverbesserer': 'Haftverbesserer', 'haft verbesserer': 'Haftverbesserer',
                
                // --- Werkzeuge (100+) ---
                'fliesenschneider': 'Fliesenschneider', 'fliesen schneider': 'Fliesenschneider',
                'nassschneider': 'Nassschneider', 'nass schneider': 'Nassschneider',
                'schneidmaschine': 'Schneidmaschine', 'schneid maschine': 'Schneidmaschine',
                'winkelschleifer': 'Winkelschleifer', 'winkel schleifer': 'Winkelschleifer',
                'flex': 'Flex', 'trennschleifer': 'Trennschleifer',
                'diamantscheibe': 'Diamantscheibe', 'diamant scheibe': 'Diamantscheibe',
                'diamanttrennscheibe': 'Diamanttrennscheibe', 'trennscheibe': 'Trennscheibe',
                'bohrkrone': 'Bohrkrone', 'bohr krone': 'Bohrkrone',
                'diamantbohrkrone': 'Diamantbohrkrone', 'diamant bohrkrone': 'Diamantbohrkrone',
                'lochs√§ge': 'Lochs√§ge', 'loch s√§ge': 'Lochs√§ge',
                'lochschneider': 'Lochschneider', 'loch schneider': 'Lochschneider',
                'papageienschnabel': 'Papageienschnabel', 'fliesenzange': 'Fliesenzange',
                'fliesenknipser': 'Fliesenknipser', 'fliesen knipser': 'Fliesenknipser',
                'brechzange': 'Brechzange', 'brech zange': 'Brechzange',
                'zahnspachtel': 'Zahnspachtel', 'zahn spachtel': 'Zahnspachtel',
                'zahnkelle': 'Zahnkelle', 'zahn kelle': 'Zahnkelle',
                'zahnung': 'Zahnung', 'zahnh√∂he': 'Zahnh√∂he',
                '6mm zahnung': '6mm Zahnung', '8mm zahnung': '8mm Zahnung',
                '10mm zahnung': '10mm Zahnung', '12mm zahnung': '12mm Zahnung',
                'gl√§ttekelle': 'Gl√§ttekelle', 'glaettekelle': 'Gl√§ttekelle',
                'gl√§ttkelle': 'Gl√§ttkelle', 'glaettkelle': 'Gl√§ttkelle',
                'traufel': 'Traufel', 'venezianerkelle': 'Venezianerkelle',
                'gummikelle': 'Gummikelle', 'gummi kelle': 'Gummikelle',
                'reibebrett': 'Reibebrett', 'reibe brett': 'Reibebrett',
                'schwammbrett': 'Schwammbrett', 'schwamm brett': 'Schwammbrett',
                'filzbrett': 'Filzbrett', 'filz brett': 'Filzbrett',
                'wasserwaage': 'Wasserwaage', 'wasser waage': 'Wasserwaage',
                'richtlatte': 'Richtlatte', 'richt latte': 'Richtlatte',
                'lasernivellier': 'Lasernivellier', 'laser nivellier': 'Lasernivellier',
                'kreuzlaser': 'Kreuzlaser', 'kreuz laser': 'Kreuzlaser',
                'linienlaser': 'Linienlaser', 'linien laser': 'Linienlaser',
                'rotationslaser': 'Rotationslaser', 'rotations laser': 'Rotationslaser',
                'empf√§nger': 'Empf√§nger', 'laserempf√§nger': 'Laserempf√§nger',
                'stativ': 'Stativ', 'laserstativ': 'Laserstativ',
                'messrad': 'Messrad', 'mess rad': 'Messrad',
                'zollstock': 'Zollstock', 'gliederma√üstab': 'Gliederma√üstab',
                'bandma√ü': 'Bandma√ü', 'ma√üband': 'Ma√üband',
                'massband': 'Ma√üband', 'rollmeter': 'Rollmeter',
                'winkelmesser': 'Winkelmesser', 'winkel messer': 'Winkelmesser',
                'schmiege': 'Schmiege', 'winkellehre': 'Winkellehre',
                'r√ºhrwerk': 'R√ºhrwerk', 'ruehrwerk': 'R√ºhrwerk',
                'r√ºhrquirl': 'R√ºhrquirl', 'ruehrquirl': 'R√ºhrquirl',
                'mischmaschine': 'Mischmaschine', 'misch maschine': 'Mischmaschine',
                'm√∂rtelmischer': 'M√∂rtelmischer', 'moertelmischer': 'M√∂rtelmischer',
                'gummihammer': 'Gummihammer', 'gummi hammer': 'Gummihammer',
                'schonhammer': 'Schonhammer', 'schon hammer': 'Schonhammer',
                'fliesenhammer': 'Fliesenhammer', 'fliesen hammer': 'Fliesenhammer',
                'saugheber': 'Saugheber', 'saug heber': 'Saugheber',
                'vakuumsauger': 'Vakuumsauger', 'vakuum sauger': 'Vakuumsauger',
                'plattenheber': 'Plattenheber', 'platten heber': 'Plattenheber',
                'fliesenwaschset': 'Fliesenwaschset', 'waschset': 'Waschset',
                'waschboy': 'Waschboy', 'wash boy': 'Waschboy',
                'fugenw√§sche': 'Fugenw√§sche', 'fugen w√§sche': 'Fugenw√§sche',
                'reinigungsschwamm': 'Reinigungsschwamm', 'reinigungs schwamm': 'Reinigungsschwamm',
                'fliesenwaschbrett': 'Fliesenwaschbrett', 'waschbrett': 'Waschbrett',
                
                // --- R√§ume & Bereiche (60+) ---
                'badezimmer': 'Badezimmer', 'bad': 'Bad',
                'k√ºche': 'K√ºche', 'kuche': 'K√ºche', 'kueche': 'K√ºche',
                'terrasse': 'Terrasse', 'terase': 'Terrasse', 'terasse': 'Terrasse',
                'balkon': 'Balkon', 'balkong': 'Balkon',
                'dusche': 'Dusche', 'duschbereich': 'Duschbereich',
                'wc': 'WC', 'toilette': 'Toilette', 'g√§ste wc': 'G√§ste-WC',
                'gaeste wc': 'G√§ste-WC', 'g√§stebad': 'G√§stebad',
                'flur': 'Flur', 'diele': 'Diele', 'eingangsbereich': 'Eingangsbereich',
                'wohnzimmer': 'Wohnzimmer', 'wohn zimmer': 'Wohnzimmer',
                'schlafzimmer': 'Schlafzimmer', 'schlaf zimmer': 'Schlafzimmer',
                'esszimmer': 'Esszimmer', 'ess zimmer': 'Esszimmer',
                'kinderzimmer': 'Kinderzimmer', 'kinder zimmer': 'Kinderzimmer',
                'arbeitszimmer': 'Arbeitszimmer', 'arbeits zimmer': 'Arbeitszimmer',
                'b√ºro': 'B√ºro', 'buero': 'B√ºro',
                'keller': 'Keller', 'kellerraum': 'Kellerraum',
                'garage': 'Garage', 'carport': 'Carport',
                'hauswirtschaftsraum': 'Hauswirtschaftsraum', 'hwp': 'HWR',
                'hwr': 'HWR', 'abstellraum': 'Abstellraum',
                'technikraum': 'Technikraum', 'technik raum': 'Technikraum',
                'heizungsraum': 'Heizungsraum', 'heizungs raum': 'Heizungsraum',
                'treppenhaus': 'Treppenhaus', 'treppen haus': 'Treppenhaus',
                'treppe': 'Treppe', 'stufe': 'Stufe', 'stufen': 'Stufen',
                'podest': 'Podest', 'treppenpodest': 'Treppenpodest',
                'wintergarten': 'Wintergarten', 'winter garten': 'Wintergarten',
                'schwimmbad': 'Schwimmbad', 'schwimm bad': 'Schwimmbad',
                'pool': 'Pool', 'poolbereich': 'Poolbereich',
                'poolumgang': 'Poolumgang', 'poolumrandung': 'Poolumrandung',
                'sauna': 'Sauna', 'saunabereich': 'Saunabereich',
                'wellnessbereich': 'Wellnessbereich', 'wellness bereich': 'Wellnessbereich',
                'spa': 'Spa', 'spabereich': 'Spa-Bereich',
                'empfang': 'Empfang', 'empfangsbereich': 'Empfangsbereich',
                'rezeption': 'Rezeption', 'foyer': 'Foyer',
                'verkaufsraum': 'Verkaufsraum', 'verkaufs raum': 'Verkaufsraum',
                'ladenfl√§che': 'Ladenfl√§che', 'ladenflaeche': 'Ladenfl√§che',
                'gewerbe': 'Gewerbe', 'gewerbefl√§che': 'Gewerbefl√§che',
                'praxis': 'Praxis', 'arztpraxis': 'Arztpraxis',
                'restaurant': 'Restaurant', 'gastronomie': 'Gastronomie',
                'gro√ük√ºche': 'Gro√ük√ºche', 'grosskueche': 'Gro√ük√ºche',
                'produktionshalle': 'Produktionshalle', 'produktions halle': 'Produktionshalle',
                'lagerhalle': 'Lagerhalle', 'lager halle': 'Lagerhalle',
                
                // --- T√§tigkeiten & Aktionen (120+) ---
                'abgestemmt': 'abgestemmt', 'abgestemt': 'abgestemmt',
                'abgerissen': 'abgerissen', 'abriss': 'Abriss',
                'abgebrochen': 'abgebrochen', 'abbruch': 'Abbruch',
                'entfernt': 'entfernt', 'entfernen': 'entfernen',
                'demontiert': 'demontiert', 'demontage': 'Demontage',
                'ausgebaut': 'ausgebaut', 'ausbau': 'Ausbau',
                'r√ºckbau': 'R√ºckbau', 'rueckbau': 'R√ºckbau',
                'r√ºckgebaut': 'r√ºckgebaut', 'rueckgebaut': 'r√ºckgebaut',
                'vorbereitet': 'vorbereitet', 'vorbereitung': 'Vorbereitung',
                'vorarbeiten': 'Vorarbeiten', 'vor arbeiten': 'Vorarbeiten',
                'grundiert': 'grundiert', 'grundieren': 'grundieren',
                'gespachtelt': 'gespachtelt', 'spachteln': 'spachteln',
                'ausgeglichen': 'ausgeglichen', 'ausgleichen': 'ausgleichen',
                'nivelliert': 'nivelliert', 'nivellieren': 'nivellieren',
                'abgedichtet': 'abgedichtet', 'abdichten': 'abdichten',
                'geschnitten': 'geschnitten', 'schneiden': 'schneiden',
                'zugeschnitten': 'zugeschnitten', 'zuschnitt': 'Zuschnitt',
                'angepasst': 'angepasst', 'anpassen': 'anpassen',
                'verlegt': 'verlegt', 'verlegen': 'verlegen',
                'geklebt': 'geklebt', 'kleben': 'kleben',
                'angesetzt': 'angesetzt', 'ansetzen': 'ansetzen',
                'verfugt': 'verfugt', 'verfugen': 'verfugen',
                'versiegelt': 'versiegelt', 'versiegeln': 'versiegeln',
                'impr√§gniert': 'impr√§gniert', 'impraegniert': 'impr√§gniert',
                'impr√§gnieren': 'impr√§gnieren', 'impraegnieren': 'impr√§gnieren',
                'gereinigt': 'gereinigt', 'reinigen': 'reinigen',
                'ges√§ubert': 'ges√§ubert', 's√§ubern': 's√§ubern',
                'abgesaugt': 'abgesaugt', 'absaugen': 'absaugen',
                'ausgemessen': 'ausgemessen', 'ausmessen': 'ausmessen',
                'aufgemessen': 'aufgemessen', 'aufmessen': 'aufmessen',
                'aufgeteilt': 'aufgeteilt', 'aufteilen': 'aufteilen',
                'eingemessen': 'eingemessen', 'einmessen': 'einmessen',
                'angezeichnet': 'angezeichnet', 'anzeichnen': 'anzeichnen',
                'markiert': 'markiert', 'markieren': 'markieren',
                'ausgerichtet': 'ausgerichtet', 'ausrichten': 'ausrichten',
                'eingebaut': 'eingebaut', 'einbauen': 'einbauen',
                'montiert': 'montiert', 'montieren': 'montieren',
                'befestigt': 'befestigt', 'befestigen': 'befestigen',
                'verankert': 'verankert', 'verankern': 'verankern',
                'verd√ºbelt': 'verd√ºbelt', 'verduebelt': 'verd√ºbelt',
                'verschraubt': 'verschraubt', 'verschrauben': 'verschrauben',
                'verklebt': 'verklebt', 'verkleben': 'verkleben',
                'abgeklebt': 'abgeklebt', 'abkleben': 'abkleben',
                'abgedeckt': 'abgedeckt', 'abdecken': 'abdecken',
                'gesch√ºtzt': 'gesch√ºtzt', 'schuetzen': 'sch√ºtzen',
                'fertiggestellt': 'fertiggestellt', 'fertigstellen': 'fertigstellen',
                'abgeschlossen': 'abgeschlossen', 'abschlie√üen': 'abschlie√üen',
                '√ºbergeben': '√ºbergeben', 'uebergeben': '√ºbergeben',
                'dokumentiert': 'dokumentiert', 'dokumentieren': 'dokumentieren',
                'protokolliert': 'protokolliert', 'protokollieren': 'protokollieren',
                'kontrolliert': 'kontrolliert', 'kontrollieren': 'kontrollieren',
                'gepr√ºft': 'gepr√ºft', 'geprueft': 'gepr√ºft',
                'gemessen': 'gemessen', 'messen': 'messen',
                'besichtigt': 'besichtigt', 'besichtigen': 'besichtigen',
                'aufgenommen': 'aufgenommen', 'aufnehmen': 'aufnehmen',
                'begutachtet': 'begutachtet', 'begutachten': 'begutachten',
                'beurteilt': 'beurteilt', 'beurteilen': 'beurteilen',
                'bewertet': 'bewertet', 'bewerten': 'bewerten',
                
                // --- Zahlen & Einheiten (50+) ---
                'quadratmeter': 'Quadratmeter', 'qm': 'qm', 'm¬≤': 'm¬≤', 'm2': 'm¬≤',
                'laufmeter': 'Laufmeter', 'lfm': 'lfm', 'lfdm': 'lfdm',
                'st√ºck': 'St√ºck', 'stueck': 'St√ºck', 'stk': 'Stk.',
                'stunden': 'Stunden', 'stunde': 'Stunde', 'std': 'Std.',
                'minuten': 'Minuten', 'minute': 'Minute', 'min': 'Min.',
                'meter': 'Meter', 'zentimeter': 'Zentimeter', 'cm': 'cm',
                'millimeter': 'Millimeter', 'mm': 'mm',
                'kilogramm': 'Kilogramm', 'kg': 'kg',
                'gramm': 'Gramm', 'g': 'g',
                'liter': 'Liter', 'l': 'l',
                'eimer': 'Eimer', 'sack': 'Sack', 's√§cke': 'S√§cke',
                'palette': 'Palette', 'paletten': 'Paletten',
                'karton': 'Karton', 'kartons': 'Kartons',
                'packung': 'Packung', 'paket': 'Paket',
                'rolle': 'Rolle', 'rollen': 'Rollen',
                'einhalb': 'einhalb', 'anderthalb': 'anderthalb',
                'zweieinhalb': 'zweieinhalb', 'dreieinhalb': 'dreieinhalb',
                'viereinhalb': 'viereinhalb', 'f√ºnfeinhalb': 'f√ºnfeinhalb',
                'fuenfeinhalb': 'f√ºnfeinhalb', 'einviertel': 'einviertel',
                'dreiviertel': 'dreiviertel', 'ca': 'ca.', 'circa': 'ca.',
                'etwa': 'etwa', 'ungef√§hr': 'ungef√§hr', 'ungefaehr': 'ungef√§hr',
                
                // --- Spracherkennung-Fehler (100+) ---
                'flie√üe': 'Fliese', 'fliesse': 'Fliese',
                'flies verlegt': 'Fliesen verlegt', 'fliessen verlegt': 'Fliesen verlegt',
                'die flie√üen': 'die Fliesen', 'flie√üen leg': 'Fliesen leg',
                'f√ºgen': 'Fugen', 'fuken': 'Fugen',
                'fer fugt': 'verfugt', 'ver fugt': 'verfugt',
                'grundi rung': 'Grundierung', 'grund ierung': 'Grundierung',
                'ab dichtung': 'Abdichtung', 'abdichtunk': 'Abdichtung',
                'est rich': 'Estrich', 'estrisch': 'Estrich',
                'spachte ln': 'spachteln', 'schpachtel': 'Spachtel',
                'silikohn': 'Silikon', 'sillikonn': 'Silikon',
                'dehnungs fuge': 'Dehnungsfuge', 'dehnungsfuche': 'Dehnungsfuge',
                'nasschnei der': 'Nassschneider', 'nass schneider': 'Nassschneider',
                'winkelsleifer': 'Winkelschleifer', 'winkel schlefer': 'Winkelschleifer',
                'flegs': 'Flex', 'fleks': 'Flex',
                'waserwaage': 'Wasserwaage', 'wasser wage': 'Wasserwaage',
                'kreuz laser': 'Kreuzlaser', 'kreuzlazer': 'Kreuzlaser',
                'bade zimmer': 'Badezimmer', 'baad': 'Bad',
                'k√ºsche': 'K√ºche', 'k√ºhche': 'K√ºche',
                'terassse': 'Terrasse', 'terrasse': 'Terrasse',
                'dussche': 'Dusche', 'dushce': 'Dusche',
                'abge stemmt': 'abgestemmt', 'abgest√§mmt': 'abgestemmt',
                'abgeri ssen': 'abgerissen', 'ab gerissen': 'abgerissen',
                'vor bereitet': 'vorbereitet', 'forberreitet': 'vorbereitet',
                'grund iert': 'grundiert', 'grundirt': 'grundiert',
                'abge dichtet': 'abgedichtet', 'ab gedichtet': 'abgedichtet',
                'ge schnitten': 'geschnitten', 'geschnieten': 'geschnitten',
                'gerei nigt': 'gereinigt', 'gereinicht': 'gereinigt',
                'quadrad meter': 'Quadratmeter', 'quadratme ter': 'Quadratmeter',
                'qwadratmeter': 'Quadratmeter', 'quadratmete': 'Quadratmeter',
                '1 stunde': '1 Stunde', '2 stunden': '2 Stunden',
                '3 stunden': '3 Stunden', '4 stunden': '4 Stunden',
                '5 stunden': '5 Stunden', '6 stunden': '6 Stunden',
                '7 stunden': '7 Stunden', '8 stunden': '8 Stunden',
                'halb e stunde': 'halbe Stunde', 'eine halbe stunde': 'eine halbe Stunde',
                'einein halb stunden': 'eineinhalb Stunden',
                'eins komma f√ºnf stunden': '1,5 Stunden',
                'zwei komma f√ºnf stunden': '2,5 Stunden',
                'fliesn': 'Fliesen', 'flisen': 'Fliesen',
                'bodenflies': 'Bodenfliesen', 'wandflies': 'Wandfliesen',
                'fertigestellt': 'fertiggestellt', 'fertig gestelt': 'fertiggestellt',
                'abgeschlo√üen': 'abgeschlossen', 'abgeschlosen': 'abgeschlossen',
                
                // --- Marken & Hersteller ---
                'mapei': 'Mapei', 'kerakoll': 'Kerakoll',
                'sopro': 'Sopro', 'lugato': 'Lugato',
                'pci': 'PCI', 'sakret': 'Sakret',
                'sch√∂nox': 'Sch√∂nox', 'schoenox': 'Sch√∂nox',
                'botament': 'Botament', 'ceresit': 'Ceresit',
                'sika': 'Sika', 'ardex': 'Ardex',
                'weber': 'Weber', 'knauf': 'Knauf',
                'rako': 'Rako', 'villeroy': 'Villeroy',
                'agrob buchtal': 'Agrob Buchtal', 'steuler': 'Steuler',
                'deutsche steinzeug': 'Deutsche Steinzeug',
                
                // --- Baustelle & Organisation ---
                'baustelle': 'Baustelle', 'bau stelle': 'Baustelle',
                'bauvorhaben': 'Bauvorhaben', 'bau vorhaben': 'Bauvorhaben',
                'bauherr': 'Bauherr', 'bau herr': 'Bauherr',
                'auftraggeber': 'Auftraggeber', 'auftrag geber': 'Auftraggeber',
                'bauleiter': 'Bauleiter', 'bau leiter': 'Bauleiter',
                'baustelleneinrichtung': 'Baustelleneinrichtung',
                'baustellenreinigung': 'Baustellenreinigung',
                'bauendreinigung': 'Bauendreinigung', 'bau endreinigung': 'Bauendreinigung',
                'besenrein': 'besenrein', 'besen rein': 'besenrein',
                'staubfrei': 'staubfrei', 'staub frei': 'staubfrei',
                '√ºbergabe': '√úbergabe', 'uebergabe': '√úbergabe',
                'abnahme': 'Abnahme', 'ab nahme': 'Abnahme',
                'aufma√ü': 'Aufma√ü', 'aufmass': 'Aufma√ü',
                'rapport': 'Rapport', 'raport': 'Rapport',
                'tagesbericht': 'Tagesbericht', 'tages bericht': 'Tagesbericht',
                'wochenbericht': 'Wochenbericht', 'wochen bericht': 'Wochenbericht',
                'regiearbeit': 'Regiearbeit', 'regie arbeit': 'Regiearbeit',
                'regiestunden': 'Regiestunden', 'regie stunden': 'Regiestunden',
                'nacharbeit': 'Nacharbeit', 'nach arbeit': 'Nacharbeit',
                'm√§ngelbeseitigung': 'M√§ngelbeseitigung', 'maengelbeseitigung': 'M√§ngelbeseitigung',
                'nachbesserung': 'Nachbesserung', 'nach besserung': 'Nachbesserung',
                'gew√§hrleistung': 'Gew√§hrleistung', 'gewaehrleistung': 'Gew√§hrleistung'
            },
            
            // === PROFESSIONELLE FORMULIERUNGEN (599 Eintr√§ge) ===
            formulierungen: {
                'fliesen': [
                    'Fliesen fachgerecht im D√ºnnbettverfahren verlegt',
                    'Fliesenbelag nach Herstellervorgaben verlegt',
                    'Wandfliesen im Verbund mit Kreuzfuge gesetzt',
                    'Bodenfliesen mit Nivellierung verlegt',
                    'Gro√üformatfliesen fachgerecht verlegt',
                    'Fliesenverlegung nach DIN 18157 ausgef√ºhrt',
                    'Feinsteinzeug im D√ºnnbett verlegt',
                    'Mosaikfliesen im Papiervlies gesetzt',
                    'Fliesenbelag mit Dehnungsfugen erstellt',
                    'Rektifizierte Fliesen mit 2mm Fuge verlegt',
                    'Gro√üformat 120x60 im Halbverband verlegt',
                    'Bodenfliesen R10 rutschhemmend verlegt',
                    'Wandfliesen vollfl√§chig im Buttering-Floating verlegt',
                    'Feinsteinzeug poliert fachgerecht verlegt',
                    'Natursteinoptik-Fliesen diagonal verlegt',
                    'Holzoptik-Fliesen im Drittelverband verlegt',
                    'Betonoptik-Fliesen fugenlos verlegt',
                    'Metro-Fliesen im Halbverband gesetzt',
                    'Hexagon-Mosaik fachgerecht verlegt',
                    'Fischgr√§tmuster fachgerecht ausgef√ºhrt',
                    'Bord√ºre als gestalterisches Element eingearbeitet',
                    'Sockelfliesen umlaufend montiert',
                    'Dekorfliesen nach Mustervorlage verlegt',
                    'Fliesen mit Gef√§lle zum Ablauf verlegt',
                    'Antirutsch-Fliesen R11 im Nassbereich verlegt',
                    'Treppenfliesen mit Sicherheitskante verlegt',
                    'Eckschutzschienen eingearbeitet',
                    'Abschlussprofile fachgerecht montiert',
                    '√úbergangsprofil zum Parkett eingebaut',
                    'Fliesenbelag mit Bewegungsfugen angelegt'
                ],
                'verlegt': [
                    'Belag fachgerecht verlegt',
                    'Verlegung nach Herstellerangaben durchgef√ºhrt',
                    'Material im D√ºnnbettverfahren verlegt',
                    'Fliesen mit Zahnspachtel aufgezogen',
                    'Bodenbelag vollfl√§chig verlegt',
                    'Fliesenverlegung im Verbund ausgef√ºhrt',
                    'Diagonal verlegt nach Kundenwunsch',
                    'Im Halbverband fachgerecht verlegt',
                    'Mit Nivelliersystem planeben verlegt',
                    'Kreuzfuge exakt ausgef√ºhrt',
                    'Wandverlegung von unten nach oben',
                    'Bodenverlegung von der T√ºr ausgehend',
                    'Symmetrische Verlegung von der Mitte aus',
                    'Verlegung mit minimalem Verschnitt durchgef√ºhrt',
                    'Gro√üformat mit Saugheber verlegt',
                    'Schwimmende Verlegung auf Trittschalld√§mmung',
                    'Entkoppelte Verlegung auf Problemuntergrund',
                    'Verlegung auf Fu√übodenheizung nach Aufheizprotokoll',
                    'Belag im Gef√§lle zum Bodenablauf verlegt',
                    'Verlegung mit durchgehender Optik ausgef√ºhrt'
                ],
                'fugen': [
                    'Fugenarbeiten fachgerecht ausgef√ºhrt',
                    'Fugenm√∂rtel eingeschl√§mmt',
                    'Fugen diagonal ausgewaschen',
                    'Randfugen mit Silikon geschlossen',
                    'Dehnungsfugen nach DIN erstellt',
                    'Flexfugenm√∂rtel verarbeitet',
                    'Fugen mit Epoxidharz ausgef√ºhrt',
                    'Fugenbreite 3mm exakt eingehalten',
                    'Bewegungsfugen fachgerecht angelegt',
                    'Wartungsfugen elastisch verfugt',
                    'Bodenfugen mit Fugenm√∂rtel gef√ºllt',
                    'Wandfugen sauber ausgearbeitet',
                    'Fugenbild gleichm√§√üig hergestellt',
                    'Eckfugen elastisch ausgef√ºhrt',
                    'Anschlussfugen dauerelastisch verschlossen',
                    'Fugenreinigung vor Neuverfugung',
                    'Altfugen ausgekratzt und erneuert',
                    'Fugen impr√§gniert gegen Verschmutzung',
                    'Sichtfugen sauber nachgearbeitet',
                    'Fugenfarbe nach Kundenwunsch gew√§hlt',
                    'Kontrastfuge als Gestaltungselement',
                    'Fugenkreuze verwendet f√ºr gleichm√§√üiges Fugenbild',
                    'Fugen diagonal mit Schwammbrett ausgewaschen',
                    'Zementschleier entfernt',
                    'Epoxidharzfugen in Gro√ük√ºche eingebaut'
                ],
                'verfugt': [
                    'Fl√§che komplett verfugt',
                    'Bodenfliesen verfugt und gereinigt',
                    'Wandfliesen sauber verfugt',
                    'Verfugung mit Flexfuge ausgef√ºhrt',
                    'Zement√§r verfugt nach Herstellerangaben',
                    'Mit 2K-Epoxid verfugt f√ºr erh√∂hte Belastung',
                    'Fl√§che verfugt und zementschleierentfernt',
                    'Feinsteinzeug mit passender Fugenfarbe verfugt',
                    'Verfugung im Nassbereich fungizid ausgef√ºhrt',
                    'Naturstein mit Spezialfuge verfugt',
                    'Mosaik mit Flexfuge sauber verfugt',
                    'Gro√üformat mit 3mm Fuge verfugt',
                    'Terrassenbelag frostfest verfugt',
                    'Treppen mit rutschhemmender Fuge verfugt',
                    'Verfugungsarbeiten abgeschlossen'
                ],
                'silikon': [
                    'Silikonfugen fachgerecht gezogen',
                    'Sanit√§rsilikon in Nassbereich eingebracht',
                    'Dehnungsfugen mit Silikon geschlossen',
                    'Eckfugen mit dauerelastischem Silikon verfugt',
                    'Anschl√ºsse an Sanit√§robjekten abgedichtet',
                    'Wandanschluss mit Silikon verschlossen',
                    'Bewegungsfugen elastisch ausgef√ºhrt',
                    'Randfugen umlaufend mit Silikon',
                    'Silikonfuge an Duschwanne erstellt',
                    'Wannenrand fachgerecht abgedichtet',
                    'Waschbeckenanschluss versiegelt',
                    'Sp√ºlenbecken einsiliert',
                    'Silikon mit Gl√§ttmittel abgezogen',
                    'Altsilikon restlos entfernt und erneuert',
                    'Natursteinsilikon verwendet (verf√§rbungsfrei)'
                ],
                'grundierung': [
                    'Untergrund fachgerecht grundiert',
                    'Tiefengrund aufgetragen',
                    'Haftgrund vor Verlegung aufgebracht',
                    'Grundierung nach Herstellervorgabe',
                    'Sperrgrundierung auf kritischem Untergrund',
                    'Betonkontakt vollfl√§chig aufgetragen',
                    'Grundierung f√ºr Verbundabdichtung',
                    'Estrich mit Tiefengrund vorbereitet',
                    'Altbelag mit Haftbr√ºcke vorbereitet',
                    'Grundierung zweifach aufgerollt',
                    'Saugenden Untergrund grundiert',
                    'Gipsputz mit Sperrgrund behandelt',
                    'Calciumsulfatestrich fachgerecht grundiert',
                    'Zementestrich grundiert nach Trocknungspr√ºfung',
                    'Grundierung abgetrocknet, belegreif',
                    'Untergrund saugf√§higkeitsausgleichend grundiert',
                    'Gipsfaserplatten mit Tiefengrund vorbereitet',
                    'Quarzsandgef√ºllte Grundierung aufgetragen',
                    'Estrich 2x grundiert f√ºr optimale Haftung',
                    'Altfliesen mit Spezialgrund vorbereitet'
                ],
                'grundiert': [
                    'Fl√§che vorbehandelt und grundiert',
                    'Estrich grundiert - belegreif',
                    'Untergrund fachgerecht grundiert',
                    'Wand vollfl√§chig grundiert',
                    'Boden nach Reinigung grundiert',
                    'Altfliesen angeschliffen und grundiert',
                    'Putz grundiert nach Trocknungszeit',
                    'Gipskarton grundiert f√ºr Abdichtung',
                    'Anhydrit grundiert und belegreif',
                    'Zementestrich grundiert nach CM-Messung',
                    'Trockenbauwand grundiert',
                    'Gipsfaserplatten grundiert',
                    'Untergrund 2x grundiert f√ºr Haftung',
                    'Fl√§che grundiert - Verlegung m√∂glich',
                    'Estrichfl√§che vollst√§ndig grundiert'
                ],
                'abdichtung': [
                    'Verbundabdichtung fachgerecht ausgef√ºhrt',
                    'Abdichtung im Duschbereich nach DIN 18534',
                    'Fl√ºssigfolie zweilagig aufgetragen',
                    'Dichtband in Ecken eingearbeitet',
                    'Bodenfl√§che wasserundurchl√§ssig abgedichtet',
                    'Wandfl√§che im Spritzwasserbereich abgedichtet',
                    'Durchdringungen mit Manschetten abgedichtet',
                    'Bodengleiche Dusche fachgerecht abgedichtet',
                    'Abdichtung bis 20cm √ºber OKFF hochgezogen',
                    'Gef√§lleestrich vor Abdichtung erstellt',
                    'Duschrinne eingebaut und abgedichtet',
                    'Ablauf angeschlossen und abgedichtet',
                    'Verbundabdichtung W2-I ausgef√ºhrt',
                    'Abdichtung im Wannenbereich erstellt',
                    'Komplett abgedichtet nach DIN 18534',
                    'Fl√§chenabdichtung mit Reaktionsharz',
                    'Bahnenabdichtung vollfl√§chig verklebt',
                    'Ecken mit Formteilen abgedichtet',
                    'Rohrdurchf√ºhrungen fachgerecht abgedichtet',
                    'Estrich vor Abdichtung gepr√ºft',
                    'Boden- und Wandanschluss abgedichtet',
                    'Duschbereich komplett nach DIN abgedichtet',
                    'Sockelfuge als Wartungsfuge ausgef√ºhrt',
                    'Verbundabdichtung zweilagig aufgetragen',
                    'Schichtdicke dokumentiert und protokolliert'
                ],
                'abgedichtet': [
                    'Duschbereich fachgerecht abgedichtet',
                    'Nassbereich vollst√§ndig abgedichtet',
                    'Wandanschluss wasserundurchl√§ssig abgedichtet',
                    'Durchdringungen mit Manschetten abgedichtet',
                    'Bodenablauf eingebunden und abgedichtet',
                    'Duschrinne angeschlossen und abgedichtet',
                    'Bereich abgedichtet gem√§√ü DIN 18534',
                    'Wandfl√§che bis Oberkante Spritzwasser abgedichtet',
                    'Boden komplett abgedichtet und belegreif',
                    'Ecken und Kanten sicher abgedichtet',
                    'Wannenbereich rundum abgedichtet',
                    'Duschboden mit Gef√§lle abgedichtet',
                    'Sockelfuge dauerelastisch abgedichtet',
                    'Estrich gepr√ºft und abgedichtet',
                    'Fl√§che abgedichtet - Verlegung kann beginnen'
                ],
                'entfernen': [
                    'Altbelag fachgerecht entfernt',
                    'Alten Fliesenbelag abgestemmt',
                    'Bestandsfliesen demontiert',
                    'Sockelfliesen entfernt',
                    'Altkleber abgefr√§st',
                    'Kleberreste beseitigt',
                    'Alte Silikonfugen ausgekratzt',
                    'Defekte Fliesen ausgetauscht',
                    'Besch√§digten Belag entfernt',
                    'Untergrund von Altbelag befreit',
                    'Wandfliesen abgeschlagen',
                    'Bodenfliesen herausgestemmt',
                    'Fliesenreste entsorgt',
                    'Estrichboden freigelegt',
                    'Untergrund f√ºr Neuverlegung vorbereitet',
                    'Mosaik vollst√§ndig entfernt',
                    'Bord√ºren demontiert',
                    'Alte Dichtstoffe entfernt',
                    'Zementschleier beseitigt',
                    'Verschmutzungen gr√ºndlich entfernt',
                    'Altanstrich abgetragen',
                    'Tapeten im Spritzbereich entfernt',
                    'Vorhandene Profile demontiert',
                    'T√ºrschwelle ausgebaut',
                    'Sockelleisten entfernt',
                    'Sanit√§robjekte zur Seite gestellt',
                    'WC f√ºr Fliesenarbeiten demontiert',
                    'Waschbecken abgeh√§ngt',
                    'Heizk√∂rper abmontiert',
                    'Steckdosen und Schalter gesichert',
                    'Bauschutt fachgerecht entsorgt',
                    'Entsorgung inkl. Containerstellung',
                    'Material zur Deponie gebracht',
                    'Demontierte Teile f√ºr Wiederverwendung gesichert',
                    'R√ºckbauarbeiten abgeschlossen'
                ],
                'reinigung': [
                    'Baustelle besenrein gereinigt',
                    'Abschlussreinigung durchgef√ºhrt',
                    'Fliesenbelag gereinigt',
                    'Bauendreinigung ausgef√ºhrt',
                    'Zementschleier entfernt',
                    'Fl√§che f√ºr √úbergabe gereinigt',
                    'Fugen nachgereinigt',
                    'Silikonfugen ges√§ubert',
                    'Baustelle aufger√§umt und gereinigt',
                    'Arbeitsbereich sauber hinterlassen',
                    'Reinigung nach Verfugung durchgef√ºhrt',
                    'Fenster und Fl√§chen abgewischt',
                    'Baustaub entfernt',
                    'Schutzfolien entfernt und entsorgt',
                    'Fliesenbelag poliert',
                    'Naturstein impr√§gniert und gereinigt',
                    'Feinsteinzeug pflegeleicht versiegelt',
                    'Sanit√§robjekte gereinigt',
                    'Armaturen poliert',
                    'Glatte Fl√§chen streifenfrei gereinigt',
                    'Fugenreinigung mit Spezialreiniger',
                    'Epoxidharzschleier entfernt',
                    'Kalkflecken beseitigt',
                    'Fliesenfl√§che f√ºr Nutzung freigegeben',
                    'Zement√§re Verschmutzungen entfernt',
                    'Fliesenbelag √ºbergabefertig gereinigt',
                    'Oberfl√§chen abschlie√üend gereinigt',
                    'Bauschutt komplett entfernt',
                    'Restmaterial abtransportiert',
                    'Werkzeug und Material ger√§umt',
                    'Baustelle begehbar und sauber',
                    'Reinigung protokolliert',
                    'Fl√§che zur Abnahme vorbereitet',
                    '√úbergabereinigung abgeschlossen',
                    'Endreinigung komplett durchgef√ºhrt'
                ],
                'gereinigt': [
                    'Fl√§che gereinigt und √ºbergeben',
                    'Belag abschlie√üend gereinigt',
                    'Baustelle aufger√§umt',
                    'Fliesenbelag zementfrei gereinigt',
                    'Oberfl√§chen gereinigt',
                    'Feinsteinzeug poliert gereinigt',
                    'Naturstein schonend gereinigt',
                    'Fugen nachgereinigt',
                    'Sanit√§rbereich gereinigt',
                    'Boden wischbereit gereinigt',
                    'W√§nde staubfrei gereinigt',
                    'Fliesenspiegel streifenfrei gereinigt',
                    'Glasmosaik nachpoliert',
                    'Belag f√ºr Nutzung freigegeben',
                    'Fl√§che gereinigt - Abnahme erfolgt'
                ],
                'vorbereitung': [
                    'Untergrund fachgerecht vorbereitet',
                    'Vorbereitungsarbeiten durchgef√ºhrt',
                    'Untergrundpr√ºfung durchgef√ºhrt',
                    'Vorarbeiten ausgef√ºhrt',
                    'Baustelleneinrichtung durchgef√ºhrt',
                    'Estrich f√ºr Verlegung vorbereitet',
                    'Wand f√ºr Fliesenarbeiten vorbereitet',
                    'Altbelag entfernt und vorbereitet',
                    'Material bereitgestellt',
                    'Werkzeug eingerichtet',
                    'Schutzma√ünahmen getroffen',
                    'Abdeckfolien verlegt',
                    'T√ºren und Fenster gesch√ºtzt',
                    'Materiallager eingerichtet',
                    'Schneidplatz vorbereitet',
                    'Wasserzugang hergestellt',
                    'Stromversorgung gesichert',
                    'Zugang zur Baustelle geschaffen',
                    'Arbeitsger√ºst aufgebaut',
                    'Arbeitsb√ºhne bereitgestellt',
                    'Schuttrutsche installiert',
                    'Container aufgestellt',
                    'Baustellensicherung erfolgt',
                    'Absperrungen errichtet',
                    'Warnschilder aufgestellt',
                    'Schutzausr√ºstung bereitgelegt',
                    'Erste-Hilfe-Material kontrolliert',
                    'Baustellendokumentation begonnen',
                    'Aufma√ü erstellt',
                    'Verlegeplan erstellt',
                    'Material kontrolliert und gez√§hlt',
                    'Farbabgleich durchgef√ºhrt',
                    'Chargen gemischt f√ºr einheitliche Optik',
                    'Untergrund auf Ebenheit gepr√ºft',
                    'Feuchtemessung protokolliert'
                ],
                'vorbereitet': [
                    'Untergrund f√ºr Verlegung vorbereitet',
                    'Fl√§che vorbereitet',
                    'Arbeitsbereich vorbereitet',
                    'Material bereitgestellt',
                    'Baustelle vorbereitet',
                    'Estrich geschliffen und vorbereitet',
                    'Wand gespachtelt und vorbereitet',
                    'Boden ausgeglichen und vorbereitet',
                    'Untergrund grundiert und vorbereitet',
                    'Fl√§che belegreif vorbereitet',
                    'Abdichtung aufgebracht - vorbereitet',
                    'Gef√§lle erstellt - vorbereitet',
                    'Duschbereich abgedichtet und vorbereitet',
                    'Untergrund optimal vorbereitet',
                    'Fl√§che f√ºr Verlegung vorbereitet'
                ],
                'schneiden': [
                    'Fliesen zugeschnitten und angepasst',
                    'Randanpassungen erstellt',
                    'Aussparungen ausgeschnitten',
                    'Gehrungsschnitte ausgef√ºhrt',
                    'Fliesenausschnitte erstellt',
                    'Steckdosenausschnitte geschnitten',
                    'Rohrausschnitte angefertigt',
                    'Eckausschnitte pr√§zise gefertigt',
                    'L-Schnitte f√ºr Ecken erstellt',
                    'Diagonalschnitte ausgef√ºhrt',
                    'Gro√üformat mit Nassschneider zugeschnitten',
                    'Mosaikstreifen angepasst',
                    'Sockelst√ºcke zugeschnitten',
                    'Bord√ºrenenden auf Gehrung geschnitten',
                    'Treppenkanten geschnitten',
                    'Einleger passgenau gefertigt',
                    'Randfliesen exakt eingepasst',
                    'Aussparung f√ºr Duschrinne geschnitten',
                    'Ablauf√∂ffnung pr√§zise ausgeschnitten',
                    'Gehrungsschnitte 45¬∞ an Au√üenecken',
                    'Anschl√ºsse passgenau geschnitten',
                    'Fliesen mit Fliesenschneider geteilt',
                    'Ausbr√ºche mit Papageienschnabel',
                    'Rundungen mit Bohrkrone gefertigt',
                    'Sonderschnitte mit Flex ausgef√ºhrt',
                    'Komplexe Geometrien gefertigt',
                    'Verschnitt minimiert',
                    'Schnittplan optimiert',
                    'Fliesen verlustarm zugeschnitten',
                    'Pr√§zisionsschnitte f√ºr √úberg√§nge',
                    'Sto√üfugen auf Ma√ü geschnitten',
                    'Abschl√ºsse sauber geschnitten',
                    'Fliesenspiegel ma√ügenau angepasst',
                    'Wandabschluss passgenau geschnitten',
                    'Bodenabschluss exakt gefertigt'
                ],
                'zugeschnitten': [
                    'Fliesen passgenau zugeschnitten',
                    'Randst√ºcke angepasst',
                    'Material zugeschnitten',
                    'Aussparungen geschnitten',
                    'Fliesen angepasst',
                    'Steckdosen√∂ffnungen ausgeschnitten',
                    'Rohrdurchf√ºhrungen zugeschnitten',
                    'Eckst√ºcke zugeschnitten',
                    'Sockelst√ºcke angepasst',
                    'Fliesen mit Nassschneider zugeschnitten',
                    'Feinsteinzeug pr√§zise zugeschnitten',
                    'Naturstein wassergek√ºhlt geschnitten',
                    'Mosaik individuell angepasst',
                    'Fliesenstreifen zugeschnitten',
                    'Material f√ºr Verlegung zugeschnitten'
                ],
                'bad': [
                    'Badezimmer komplett gefliest',
                    'Sanit√§rbereich ausgef√ºhrt',
                    'Duschbereich abgedichtet und gefliest',
                    'Badezimmerw√§nde gefliest',
                    'Bodenfliesen im Bad verlegt',
                    'G√§ste-WC komplett gefliest',
                    'Badezimmer nach Kundenwunsch gestaltet',
                    'Nassbereich fachgerecht ausgef√ºhrt',
                    'Fliesenarbeiten im Bad abgeschlossen',
                    'Badezimmersanierung fertiggestellt'
                ],
                'dusche': [
                    'Duschbereich nach DIN abgedichtet',
                    'Duschwanne eingebaut',
                    'Bodengleiche Dusche erstellt',
                    'Duschrinne eingebaut',
                    'Duschbereich komplett gefliest',
                    'Walk-In-Dusche fachgerecht ausgef√ºhrt',
                    'Gef√§lleestrich in Dusche erstellt',
                    'Duschbereich rutschhemmend gefliest',
                    'Duschabtrennung montiert',
                    'Dusche komplett fertiggestellt'
                ],
                'k√ºche': [
                    'K√ºche gefliest',
                    'Fliesenspiegel erstellt',
                    'K√ºchenr√ºckwand gefliest',
                    'K√ºchenboden verlegt',
                    'Spritzschutz erstellt',
                    'K√ºchenw√§nde teilweise gefliest',
                    'Arbeitsfl√§che gefliest',
                    'Herdbereich mit Mosaikfliesen',
                    'K√ºche mit Feinsteinzeug belegt',
                    'K√ºchenbereich fertiggestellt'
                ],
                'terrasse': [
                    'Terrassenbelag verlegt',
                    'Au√üenfliesen frostfest verlegt',
                    'Terrassenplatten verlegt',
                    'Gef√§lle f√ºr Ablauf erstellt',
                    'Terrassenbelag fertiggestellt',
                    'Feinsteinzeug frostsicher verlegt',
                    'Bahnenverlegung auf Terrasse',
                    'Terrassenkanten mit Profil versehen',
                    'Au√üenbereich fachgerecht gefliest',
                    'Terrassensanierung abgeschlossen'
                ],
                'balkon': [
                    'Balkonbelag erneuert',
                    'Balkonfliesen verlegt',
                    'Balkonabdichtung erstellt',
                    'Balkonentw√§sserung integriert',
                    'Balkonbr√ºstung gefliest',
                    'Balkonsanierung fachgerecht',
                    'Frostfester Belag auf Balkon',
                    'Balkon mit Gef√§lle verlegt',
                    'Balkonrinne eingebaut',
                    'Balkonbelag fertiggestellt'
                ],
                'montage': [
                    'Sanit√§robjekte montiert',
                    'WC fachgerecht montiert',
                    'Waschbecken befestigt',
                    'Heizk√∂rper wieder montiert',
                    'Abschlussprofile montiert',
                    'Eckschutzschienen angebracht',
                    'T√ºrschwelle eingebaut',
                    'Sockelleisten montiert',
                    'Duschabtrennung installiert',
                    'Duschrinne eingebaut und angeschlossen',
                    'Bodenablauf montiert',
                    'Revisions√∂ffnung eingesetzt',
                    'Fliesenprofile eingebaut',
                    '√úbergangsprofil montiert',
                    'Eckverbinder angebracht',
                    'Randabschluss montiert',
                    'Waschtischunterschrank befestigt',
                    'Spiegelschrank montiert',
                    'Handtuchhalter angebracht',
                    'Accessoires montiert'
                ],
                'estrich': [
                    'Estrich auf Belegreife gepr√ºft',
                    'CM-Wert gemessen und dokumentiert',
                    'Estrich geschliffen',
                    'Estrichrisse saniert',
                    'Estrichoberfl√§che vorbereitet',
                    'Estrich grundiert',
                    'Ausgleichsmasse aufgetragen',
                    'Estrichfeld abgegrenzt',
                    'Randd√§mmstreifen gepr√ºft',
                    'Estrich f√ºr Fliesenverlegung vorbereitet'
                ],
                'naturstein': [
                    'Naturstein fachgerecht verlegt',
                    'Marmor im M√∂rtelbett gesetzt',
                    'Granit mit Spezialkleber verlegt',
                    'Naturstein impr√§gniert',
                    'Schiefer versiegelt',
                    'Travertin kristallisiert',
                    'Natursteinbelag poliert',
                    'Steinfugen elastisch ausgef√ºhrt',
                    'Naturstein gegen Verf√§rbung gesch√ºtzt',
                    'Natursteinsockel montiert'
                ],
                'heizung': [
                    'Fu√übodenheizung gepr√ºft',
                    'Aufheizprotokoll eingehalten',
                    'Heizestrich auf Belegreife gepr√ºft',
                    'Verlegung auf Fu√übodenheizung',
                    'Estrich nach Heizprotokoll belegreif',
                    'Fliesen auf Heizestrich verlegt',
                    'Heizungsrohre √ºberdeckt',
                    'W√§rmed√§mmung ber√ºcksichtigt',
                    'Fu√übodenheizung wieder in Betrieb',
                    'Aufheizprotokoll dokumentiert'
                ],
                'pool': [
                    'Poolbereich gefliest',
                    'Schwimmbeckenfliesen verlegt',
                    'Poolrand mit Formteilen ausgef√ºhrt',
                    '√úberlaufrinne eingebaut',
                    'Poolabdichtung erstellt',
                    'Mosaikbelag im Pool verlegt',
                    'Beckenkopf fachgerecht gefliest',
                    'Poolumgang rutschhemmend verlegt',
                    'Schwallwasserrinne eingebaut',
                    'Poolbereich fertiggestellt'
                ],
                'gewerbe': [
                    'Gewerbefl√§che gefliest',
                    'Ladenfl√§che mit Feinsteinzeug belegt',
                    'Verkaufsraum gefliest',
                    'Gro√ük√ºche gefliest',
                    'Produktionsbereich gefliest',
                    'Lagerbereich belegt',
                    'Sanit√§rr√§ume im Gewerbe ausgef√ºhrt',
                    'Empfangsbereich gestaltet',
                    'B√ºrofl√§che gefliest',
                    'Gewerbebereich fertiggestellt'
                ],
                'sanierung': [
                    'Badsanierung durchgef√ºhrt',
                    'Altbausanierung ausgef√ºhrt',
                    'Fliesensanierung abgeschlossen',
                    'Teilsanierung fertiggestellt',
                    'Komplettsanierung ausgef√ºhrt',
                    'Schadensbehebung durchgef√ºhrt',
                    'Sanierungsarbeiten abgeschlossen',
                    'Renovierung fertiggestellt',
                    'Modernisierung durchgef√ºhrt',
                    'Sanierung fachgerecht ausgef√ºhrt'
                ],
                'handel': [
                    'Fliesen fachgerecht verlegt',
                    'Material nach Kundenwunsch verarbeitet',
                    'Sonderfliesen aus Kundenbeistellung verlegt',
                    'Restposten fachgerecht verarbeitet',
                    'Muster vor Verlegung freigegeben',
                    'Material auf Vollst√§ndigkeit gepr√ºft',
                    'Fliesenlieferung angenommen',
                    'Zusatzmaterial nachbestellt',
                    'Chargen kontrolliert',
                    'Fliesen aus einer Brandpartie verlegt'
                ],
                'default': [
                    'Arbeiten fachgerecht ausgef√ºhrt',
                    'T√§tigkeit gem√§√ü Auftrag durchgef√ºhrt',
                    'Arbeitsschritte planm√§√üig abgeschlossen',
                    'Leistung nach Vorgabe erbracht',
                    'Qualit√§tskontrolle durchgef√ºhrt',
                    'Arbeiten nach Stand der Technik',
                    'Ausf√ºhrung nach DIN-Normen',
                    'Fachgerechte Ausf√ºhrung best√§tigt',
                    'Arbeiten termingerecht fertiggestellt',
                    'Leistung dokumentiert',
                    'Qualit√§t gesichert',
                    'Arbeitsschritte protokolliert',
                    'Tagesleistung erbracht',
                    'Fortschritt dokumentiert',
                    'Zwischenabnahme erfolgt'
                ]
            }
        };
        
        
        // ===== TEXT KORRIGIEREN =====
        function autokorrigiereText(text) {
            if (!text) return text;
            let korrigiert = text;
            korrigiert = korrigiert.charAt(0).toUpperCase() + korrigiert.slice(1);
            for (const [falsch, richtig] of Object.entries(baustellenDatenbank.autokorrektur)) {
                const regex = new RegExp('\\b' + falsch + '\\b', 'gi');
                korrigiert = korrigiert.replace(regex, richtig);
            }
            return korrigiert.replace(/\s+/g, ' ').trim();
        }
        
        // ===== STUNDEN EXTRAHIEREN =====
        function extrahiereStunden(text) {
            if (!text) return { stunden: null, taetigkeit: text };
            
            // Muster: "2 Stunden Fliesen verlegt" oder "Fliesen verlegt 2 Stunden"
            const muster = [
                /(\d+(?:[,\.]\d+)?)\s*(?:stunden?|std\.?|h)\s+(?:f√ºr\s+)?(.+)/i,
                /(.+?)\s+(\d+(?:[,\.]\d+)?)\s*(?:stunden?|std\.?|h)$/i,
                /(\d+(?:[,\.]\d+)?)\s*(?:stunden?|std\.?|h)\s+(.+)/i
            ];
            
            for (const m of muster) {
                const match = text.match(m);
                if (match) {
                    let stunden, taetigkeit;
                    if (/^\d/.test(match[1])) {
                        stunden = parseFloat(match[1].replace(',', '.'));
                        taetigkeit = match[2];
                    } else {
                        taetigkeit = match[1];
                        stunden = parseFloat(match[2].replace(',', '.'));
                    }
                    return { stunden, taetigkeit: taetigkeit.trim() };
                }
            }
            return { stunden: null, taetigkeit: text };
        }
        
        // ===== LOKALE VORSCHL√ÑGE =====
        function generiereLokalVorschlaege(text) {
            const textLower = text.toLowerCase();
            for (const [keyword, vorschlaege] of Object.entries(baustellenDatenbank.formulierungen)) {
                if (keyword !== 'default' && textLower.includes(keyword)) {
                    return [...vorschlaege];
                }
            }
            return [...baustellenDatenbank.formulierungen.default];
        }
        
        // ===== KI-VORSCHL√ÑGE DEAKTIVIERT =====
        // Puter.js √∂ffnet externe Login-Seite - daher deaktiviert
        async function generiereKIVorschlaege(text) {
            // KI-Vorschl√§ge deaktiviert - nur lokale Vorschl√§ge verwenden
            console.log('KI-Vorschl√§ge deaktiviert (keine externe Seite √∂ffnen)');
            return [];
        }
        
        // ===== HAUPTFUNKTION =====
        async function showTextVerbesserungModal(originalText, typ) {
            const korrigiert = autokorrigiereText(originalText);
            const { stunden, taetigkeit } = extrahiereStunden(korrigiert);
            const lokaleVorschlaege = generiereLokalVorschlaege(taetigkeit);
            const kiVerfuegbar = isKIAvailable();

            // Modal erstellen
            const altesModal = document.getElementById('textVerbesserungModal');
            if (altesModal) altesModal.remove();

            const modal = document.createElement('div');
            modal.id = 'textVerbesserungModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10002;display:flex;align-items:center;justify-content:center;padding:15px;';

            const stundenHtml = stunden ? `
                <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:15px;border:2px solid #f59e0b;">
                    <div style="font-size:12px;color:#92400e;margin-bottom:5px;">‚è±Ô∏è Erkannte Stunden:</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="number" id="modalStunden" value="${stunden}" step="0.5" min="0" max="24"
                               style="width:80px;padding:8px;border:1px solid #d97706;border-radius:4px;font-size:16px;font-weight:bold;">
                        <span style="color:#92400e;font-weight:bold;">Stunden</span>
                    </div>
                </div>` : '';

            // KI-Bereich HTML
            const kiHtml = `
                <div style="margin-bottom:15px;padding:12px;background:linear-gradient(135deg,#667eea20,#764ba220);border-radius:8px;border:2px solid #667eea;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <div style="font-size:13px;color:#667eea;font-weight:bold;">ü§ñ KI-Zusammenfassung</div>
                        ${kiVerfuegbar ?
                            `<button id="kiButton" onclick="starteKIVerbesserung('${originalText.replace(/'/g, "\\'")}', '${typ}')"
                                style="padding:6px 12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;">
                                ‚ú® KI verbessern
                            </button>` :
                            `<button onclick="openKISettings()"
                                style="padding:6px 12px;background:#e5e7eb;color:#64748b;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                ‚öôÔ∏è API-Key einrichten
                            </button>`
                        }
                    </div>
                    <div id="kiVorschlag" style="display:none;background:white;padding:12px;border-radius:8px;cursor:pointer;border:2px solid #22c55e;"
                         onclick="waehleKIVorschlag('${typ}')">
                        <div style="font-size:11px;color:#166534;margin-bottom:5px;">‚ú® KI-Vorschlag:</div>
                        <div id="kiVorschlagText" style="color:#166534;font-weight:bold;"></div>
                        <div id="kiVorschlagSource" style="font-size:10px;color:#64748b;margin-top:5px;"></div>
                    </div>
                    <div id="kiLaden" style="display:none;text-align:center;padding:15px;color:#667eea;">
                        <div style="font-size:24px;margin-bottom:5px;">‚è≥</div>
                        <div>KI analysiert Text...</div>
                    </div>
                    <div id="kiInfo" style="font-size:11px;color:#64748b;${kiVerfuegbar ? '' : 'display:none;'}">
                        Klicke auf "KI verbessern" f√ºr professionelle Zusammenfassung
                    </div>
                </div>`;

            modal.innerHTML = `
                <div style="background:white;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
                    <div style="padding:16px 20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:16px 16px 0 0;">
                        <h3 style="margin:0;color:white;font-size:18px;">üé§ Spracheingabe verbessern</h3>
                    </div>
                    <div style="padding:20px;">
                        <div style="background:#f1f5f9;padding:10px 12px;border-radius:8px;margin-bottom:12px;">
                            <div style="font-size:11px;color:#64748b;">Erkannt:</div>
                            <div style="color:#475569;">"${originalText}"</div>
                        </div>
                        ${stundenHtml}
                        ${kiHtml}
                        <div style="background:#dcfce7;padding:12px;border-radius:8px;margin-bottom:15px;cursor:pointer;border:2px solid #22c55e;"
                             onclick="waehleTextvorschlag('${taetigkeit.replace(/'/g, "\\'")}', '${typ}')">
                            <div style="font-size:11px;color:#166534;">‚úÖ Lokal korrigiert:</div>
                            <div style="color:#166534;font-weight:bold;">"${taetigkeit}"</div>
                        </div>
                        <div style="font-size:13px;color:#64748b;margin-bottom:8px;font-weight:500;">üìö Professionelle Formulierungen:</div>
                        <div id="lokaleVorschlaege">
                            ${lokaleVorschlaege.map(v => `
                                <div style="background:#f8fafc;padding:10px 12px;border-radius:8px;margin-bottom:6px;cursor:pointer;border:2px solid transparent;"
                                     onclick="waehleTextvorschlag('${v.replace(/'/g, "\\'")}', '${typ}')"
                                     onmouseover="this.style.borderColor='#667eea';this.style.background='#eef2ff';"
                                     onmouseout="this.style.borderColor='transparent';this.style.background='#f8fafc';">
                                    ${v}
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-top:15px;border-top:1px solid #e5e7eb;padding-top:15px;">
                            <div style="font-size:13px;color:#64748b;margin-bottom:8px;font-weight:500;">üè∑Ô∏è Weitere Kategorien:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;" id="kategorieButtons">
                                <button onclick="zeigeKategorie('fliesen', '${typ}')" style="padding:6px 12px;background:#dbeafe;color:#1e40af;border:none;border-radius:6px;cursor:pointer;font-size:12px;">ü™® Fliesen</button>
                                <button onclick="zeigeKategorie('fugen', '${typ}')" style="padding:6px 12px;background:#fef3c7;color:#92400e;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üî≤ Fugen</button>
                                <button onclick="zeigeKategorie('silikon', '${typ}')" style="padding:6px 12px;background:#ddd6fe;color:#5b21b6;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üíß Silikon</button>
                                <button onclick="zeigeKategorie('abdichtung', '${typ}')" style="padding:6px 12px;background:#cffafe;color:#0e7490;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üõ°Ô∏è Abdichtung</button>
                                <button onclick="zeigeKategorie('grundierung', '${typ}')" style="padding:6px 12px;background:#dcfce7;color:#166534;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üé® Grundierung</button>
                                <button onclick="zeigeKategorie('spachteln', '${typ}')" style="padding:6px 12px;background:#fee2e2;color:#991b1b;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üîß Spachteln</button>
                                <button onclick="zeigeKategorie('demontage', '${typ}')" style="padding:6px 12px;background:#fef9c3;color:#854d0e;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üî® Demontage</button>
                                <button onclick="zeigeKategorie('reinigung', '${typ}')" style="padding:6px 12px;background:#f0fdf4;color:#15803d;border:none;border-radius:6px;cursor:pointer;font-size:12px;">üßπ Reinigung</button>
                            </div>
                            <div id="kategorieVorschlaege" style="max-height:150px;overflow-y:auto;"></div>
                        </div>
                    </div>
                    <div style="padding:12px 20px 20px;display:flex;gap:10px;">
                        <button onclick="document.getElementById('textVerbesserungModal').remove()"
                                style="flex:1;padding:12px;background:#e5e7eb;color:#475569;border:none;border-radius:8px;cursor:pointer;">‚ùå Abbrechen</button>
                        <button onclick="waehleTextvorschlag('${taetigkeit.replace(/'/g, "\\'")}', '${typ}')"
                                style="flex:1;padding:12px;background:#22c55e;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">‚úÖ √úbernehmen</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Automatisch KI starten wenn verf√ºgbar
            if (kiVerfuegbar) {
                starteKIVerbesserung(originalText, typ);
            }
        }

        // KI-Verbesserung starten
        let aktuellerKIVorschlag = '';
        async function starteKIVerbesserung(text, typ) {
            const kiButton = document.getElementById('kiButton');
            const kiLaden = document.getElementById('kiLaden');
            const kiVorschlag = document.getElementById('kiVorschlag');
            const kiInfo = document.getElementById('kiInfo');

            // Button deaktivieren, Ladeanimation zeigen
            if (kiButton) kiButton.style.display = 'none';
            if (kiInfo) kiInfo.style.display = 'none';
            if (kiLaden) kiLaden.style.display = 'block';

            try {
                const result = await verbessereMitKI(text);

                if (result && result.text) {
                    aktuellerKIVorschlag = result.text;
                    document.getElementById('kiVorschlagText').textContent = result.text;
                    document.getElementById('kiVorschlagSource').textContent = `via ${result.source}`;
                    if (kiLaden) kiLaden.style.display = 'none';
                    if (kiVorschlag) kiVorschlag.style.display = 'block';
                    showToast(`‚ú® KI-Vorschlag via ${result.source}`, 'success');
                } else {
                    throw new Error('Keine Antwort');
                }
            } catch (e) {
                console.error('KI-Verbesserung fehlgeschlagen:', e);
                if (kiLaden) kiLaden.style.display = 'none';
                if (kiButton) kiButton.style.display = 'inline-block';
                if (kiInfo) {
                    kiInfo.textContent = '‚ö†Ô∏è KI nicht verf√ºgbar - versuche es erneut';
                    kiInfo.style.display = 'block';
                }
                showToast('‚ö†Ô∏è KI-Verbesserung fehlgeschlagen', 'error');
            }
        }

        // KI-Vorschlag √ºbernehmen
        function waehleKIVorschlag(typ) {
            if (aktuellerKIVorschlag) {
                waehleTextvorschlag(aktuellerKIVorschlag, typ);
            }
        }
        
        // ===== SCROLL ZU HELPER =====
        function scrollToHelper(typ) {
            let element;
            if (typ === 'taetigkeit') {
                element = document.getElementById('taetigkeitHaupt');
            } else if (typ === 'material') {
                element = document.getElementById('materialHaupt');
            } else if (typ === 'werkzeuge') {
                element = document.getElementById('werkzeugeHaupt');
            }

            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.focus();
                showToast('‚¨ÜÔ∏è W√§hle oben eine Kategorie', 'info');
            }
        }

        // ===== KATEGORIE ANZEIGEN =====
        function zeigeKategorie(kategorie, typ) {
            const container = document.getElementById('kategorieVorschlaege');
            if (!container) return;

            const vorschlaege = baustellenDatenbank.formulierungen[kategorie] || [];

            if (vorschlaege.length === 0) {
                container.innerHTML = '<div style="color:#94a3b8;font-size:12px;padding:10px;text-align:center;">Keine Vorschl√§ge f√ºr diese Kategorie</div>';
                return;
            }

            container.innerHTML = vorschlaege.slice(0, 10).map(v => `
                <div style="background:#f8fafc;padding:8px 12px;border-radius:6px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;font-size:13px;"
                     onclick="waehleTextvorschlag('${v.replace(/'/g, "\\'")}', '${typ}')"
                     onmouseover="this.style.borderColor='#667eea';this.style.background='#eef2ff';"
                     onmouseout="this.style.borderColor='transparent';this.style.background='#f8fafc';">
                    ${v}
                </div>
            `).join('');
        }

        // ===== VORSCHLAG √úBERNEHMEN =====
        function waehleTextvorschlag(text, typ) {
            const stundenInput = document.getElementById('modalStunden');
            const stunden = stundenInput ? parseFloat(stundenInput.value) : null;
            
            const modal = document.getElementById('textVerbesserungModal');
            if (modal) modal.remove();
            
            if (typ === 'taetigkeit') {
                const tbody = document.getElementById('taetigkeitenTable');
                const datum = document.getElementById('datum').value;
                const newRow = tbody.insertRow();
                newRow.className = 'editable-row';
                const stundenText = stunden ? stunden + ' Std' : '';
                
                newRow.innerHTML = `
                    <td contenteditable="true">${taetigkeitenRowCounter}</td>
                    <td>${datum}</td>
                    <td contenteditable="true">${text}</td>
                    <td contenteditable="true">${stundenText}</td>
                    <td contenteditable="true"></td>
                `;
                
                taetigkeitenRowCounter++;
                showToast(stunden ? `‚úÖ + ${stunden}h √ºbernommen` : '‚úÖ √úbernommen', 'success');
            } else if (typ === 'material') {
                const textarea = document.getElementById('material');
                textarea.value = textarea.value ? textarea.value + '\n' + text : text;
                showToast('‚úÖ Material √ºbernommen', 'success');
            }
        }

        // ===== INITIALISIERUNG =====
        document.addEventListener('DOMContentLoaded', function() {
            // Tab-Navigation wird bereits √ºber onclick="switchToTab('...')" gesteuert
            // ENTFERNT: Konfliktierender Event-Listener der dataset.tab nutzte (existiert nicht)

            // Datum setzen
            const today = new Date().toISOString().split('T')[0];
            const datumInput = document.getElementById('datum');
            if (datumInput) datumInput.value = today;
            
            // Rapport-Nummer setzen
            const savedBerichte = JSON.parse(localStorage.getItem('baustellenberichte') || '[]');
            const nextNr = savedBerichte.length + 1;
            const rapportInput = document.getElementById('rapportNr');
            if (rapportInput) rapportInput.value = nextNr.toString().padStart(4, '0');
            
            // Gespeicherte Berichte laden
            loadBerichte();
            
            // Statistik
            const autoCount = Object.keys(baustellenDatenbank.autokorrektur).length;
            const formCategories = Object.keys(baustellenDatenbank.formulierungen).length;
            let formCount = 0;
            for (const arr of Object.values(baustellenDatenbank.formulierungen)) {
                formCount += arr.length;
            }
            console.log(`üìä Baustellenbericht v3.3.4 Datenbank geladen:`);
            console.log(`   ‚úÖ ${autoCount} Autokorrekturen`);
            console.log(`   ‚úÖ ${formCount} Formulierungen in ${formCategories} Kategorien`);
            console.log(`   ‚ÑπÔ∏è KI deaktiviert (nur lokale Vorschl√§ge)`);
        });
        
        
    </script>
</body>
</html>
